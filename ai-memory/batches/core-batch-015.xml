
You are the "Fixzit Memory Builder" for category: "core".

You are given a batch of source files from the Fixzit codebase, wrapped in <file> tags
inside <batch_content>. Each <file> has a "path" attribute with the repository-relative
file path, and its contents are wrapped in CDATA.

YOUR TASK:
1. Read ALL files in <batch_content>.
2. For EACH file, extract architectural metadata using this schema:

[
  {
    "file": "repo-relative/path/to/file.ext",
    "category": "core",
    "summary": "One-sentence technical summary of what this file does.",
    "exports": ["ExportedFunctionOrClassName", "..."],
    "dependencies": ["ImportedModuleOrPath", "..."]
  }
]

RULES:
- Return ONLY a valid JSON array.
- NO markdown, NO backticks, NO comments, NO extra text.
- Include an entry for every file in this batch.
- If a file has no exports, use "exports": [].
- If a file has no imports, use "dependencies": [].

<batch_content>

<file path="app/admin/onboarding/page.tsx">
<![CDATA[
"use client";

import { useState, useEffect, useCallback } from "react";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { useTranslation } from "@/contexts/TranslationContext";
import {
  CheckCircle,
  XCircle,
  Clock,
  FileText,
  User,
  Search,
  Loader2,
  ExternalLink,
  AlertTriangle,
  ShieldAlert,
} from "lucide-react";
import { toast } from "sonner";
import { cn } from "@/lib/utils";

// Roles allowed to access admin approval queue
const ADMIN_ROLES = ["SUPER_ADMIN", "CORPORATE_ADMIN", "ADMIN", "SUPPORT"];

type OnboardingStatus = "DRAFT" | "SUBMITTED" | "UNDER_REVIEW" | "DOCS_PENDING" | "APPROVED" | "REJECTED" | "CANCELLED";
type OnboardingRole = "TENANT" | "PROPERTY_OWNER" | "OWNER" | "VENDOR" | "AGENT";

interface OnboardingCase {
  _id: string;
  role: OnboardingRole;
  status: OnboardingStatus;
  current_step: number;
  basic_info: {
    name: string;
    email: string;
    phone?: string;
  };
  documents: string[];
  country: string;
  createdAt: string;
  subject_user_id?: string;
}

const STATUS_COLORS: Record<OnboardingStatus, string> = {
  DRAFT: "bg-gray-100 text-gray-800",
  SUBMITTED: "bg-primary/10 text-primary-dark",
  UNDER_REVIEW: "bg-yellow-100 text-yellow-800",
  DOCS_PENDING: "bg-orange-100 text-orange-800",
  APPROVED: "bg-green-100 text-green-800",
  REJECTED: "bg-red-100 text-red-800",
  CANCELLED: "bg-gray-100 text-gray-500",
};

const STATUS_LABELS: Record<OnboardingStatus, { en: string; ar: string }> = {
  DRAFT: { en: "Draft", ar: "مسودة" },
  SUBMITTED: { en: "Submitted", ar: "مرسل" },
  UNDER_REVIEW: { en: "Under Review", ar: "قيد المراجعة" },
  DOCS_PENDING: { en: "Documents Pending", ar: "مستندات معلقة" },
  APPROVED: { en: "Approved", ar: "موافق عليه" },
  REJECTED: { en: "Rejected", ar: "مرفوض" },
  CANCELLED: { en: "Cancelled", ar: "ملغي" },
};

const ROLE_LABELS: Record<OnboardingRole, { en: string; ar: string }> = {
  TENANT: { en: "Tenant", ar: "مستأجر" },
  PROPERTY_OWNER: { en: "Property Owner", ar: "مالك عقار" },
  OWNER: { en: "Corporate Owner", ar: "مالك مؤسسي" },
  VENDOR: { en: "Vendor", ar: "مورد" },
  AGENT: { en: "Agent", ar: "وكيل" },
};

export default function AdminApprovalQueuePage() {
  const { t, isRTL } = useTranslation();
  const { data: session, status } = useSession();
  const router = useRouter();
  
  const [cases, setCases] = useState<OnboardingCase[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState<string>("SUBMITTED");
  const [roleFilter, setRoleFilter] = useState<string>("all");
  
  // Review dialog state
  const [selectedCase, setSelectedCase] = useState<OnboardingCase | null>(null);
  const [reviewAction, setReviewAction] = useState<"approve" | "reject" | null>(null);
  const [rejectionReason, setRejectionReason] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);

  // RBAC Check: Only allow admin roles
  const userRole = session?.user?.role as string | undefined;
  const hasAccess = userRole && ADMIN_ROLES.includes(userRole);

  // Redirect if not authorized (after session loads)
  useEffect(() => {
    if (status === "unauthenticated") {
      router.push("/login?callbackUrl=/admin/onboarding");
    }
  }, [status, router]);

  const fetchCases = useCallback(async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      if (statusFilter !== "all") params.set("status", statusFilter);
      if (roleFilter !== "all") params.set("role", roleFilter);
      params.set("limit", "50");

      const res = await fetch(`/api/onboarding?${params.toString()}`);
      if (res.ok) {
        const data = await res.json();
        setCases(data);
      }
    } catch (_error) {
      toast.error(isRTL ? "فشل في تحميل الطلبات" : "Failed to load applications");
    } finally {
      setIsLoading(false);
    }
  }, [statusFilter, roleFilter, isRTL]);

  useEffect(() => {
    fetchCases();
  }, [fetchCases]);

  // Show loading while checking session
  if (status === "loading") {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  // Show access denied if no permission
  if (status === "authenticated" && !hasAccess) {
    return (
      <div className="container max-w-2xl py-16 px-4">
        <Card className="border-destructive/50">
          <CardHeader className="text-center">
            <div className="mx-auto w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center mb-4">
              <ShieldAlert className="h-6 w-6 text-destructive" />
            </div>
            <CardTitle className="text-xl">
              {isRTL ? "الوصول مرفوض" : "Access Denied"}
            </CardTitle>
          </CardHeader>
          <CardContent className="text-center text-muted-foreground">
            <p className="mb-4">
              {isRTL
                ? "ليس لديك صلاحية للوصول إلى قائمة الموافقات. هذه الصفحة مخصصة للمسؤولين فقط."
                : "You do not have permission to access the Approval Queue. This page is restricted to Admin users only."}
            </p>
            <Button variant="outline" onClick={() => router.push("/dashboard")}>
              {isRTL ? "العودة للوحة التحكم" : "Back to Dashboard"}
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const filteredCases = cases.filter((c) => {
    if (!searchQuery) return true;
    const query = searchQuery.toLowerCase();
    return (
      c.basic_info.name?.toLowerCase().includes(query) ||
      c.basic_info.email?.toLowerCase().includes(query) ||
      c._id.includes(query)
    );
  });

  const handleReview = async () => {
    if (!selectedCase || !reviewAction) return;

    setIsProcessing(true);
    try {
      const newStatus = reviewAction === "approve" 
        ? (selectedCase.documents.length > 0 ? "UNDER_REVIEW" : "APPROVED")
        : "REJECTED";

      const res = await fetch(`/api/onboarding/${selectedCase._id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          status: newStatus,
          payload: reviewAction === "reject" ? { rejectionReason } : undefined,
        }),
      });

      if (!res.ok) {
        throw new Error("Failed to update status");
      }

      toast.success(
        reviewAction === "approve"
          ? (isRTL ? "تمت الموافقة على الطلب" : "Application approved")
          : (isRTL ? "تم رفض الطلب" : "Application rejected")
      );

      setSelectedCase(null);
      setReviewAction(null);
      setRejectionReason("");
      fetchCases();
    } catch (_error) {
      toast.error(isRTL ? "فشل في تحديث الطلب" : "Failed to update application");
    } finally {
      setIsProcessing(false);
    }
  };

  const pendingCount = cases.filter((c) => c.status === "SUBMITTED").length;
  const reviewingCount = cases.filter((c) => c.status === "UNDER_REVIEW").length;
  const now = new Date();
  const startOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0, 0));
  const endOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59, 999));
  const approvedCount = cases.filter((c) => {
    if (c.status !== "APPROVED") return false;
    const ts = (c as { approvedAt?: string | Date; createdAt?: string | Date }).approvedAt ?? c.createdAt;
    if (!ts) return false;
    const d = new Date(ts);
    return d >= startOfDay && d <= endOfDay;
  }).length;

  return (
    <div className="container max-w-7xl py-8 px-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold mb-2">
          {t("admin.approvalQueue", isRTL ? "قائمة الموافقات" : "Approval Queue")}
        </h1>
        <p className="text-muted-foreground">
          {t(
            "admin.approvalQueueDesc",
            isRTL
              ? "مراجعة والموافقة على طلبات الإنضمام"
              : "Review and approve onboarding applications"
          )}
        </p>
      </div>

      {/* Stats Cards */}
      <div className="grid gap-4 md:grid-cols-3 mb-6">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              {isRTL ? "بانتظار المراجعة" : "Pending Review"}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <Clock className="h-4 w-4 text-yellow-500" />
              <span className="text-2xl font-bold">{pendingCount}</span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              {isRTL ? "قيد المراجعة" : "Under Review"}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <FileText className="h-4 w-4 text-primary" />
              <span className="text-2xl font-bold">{reviewingCount}</span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              {isRTL ? "تمت الموافقة" : "Approved Today"}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <CheckCircle className="h-4 w-4 text-green-500" />
              <span className="text-2xl font-bold">{approvedCount}</span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card className="mb-6">
        <CardContent className="p-4">
          <div className="flex flex-col md:flex-row gap-4">
            <div className="flex-1">
              <div className="relative">
                <Search className="absolute start-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder={isRTL ? "بحث بالاسم أو البريد..." : "Search by name or email..."}
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="ps-10"
                />
              </div>
            </div>
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder={isRTL ? "الحالة" : "Status"} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">{isRTL ? "الكل" : "All"}</SelectItem>
                <SelectItem value="SUBMITTED">{isRTL ? "مرسل" : "Submitted"}</SelectItem>
                <SelectItem value="UNDER_REVIEW">{isRTL ? "قيد المراجعة" : "Under Review"}</SelectItem>
                <SelectItem value="DOCS_PENDING">{isRTL ? "مستندات معلقة" : "Docs Pending"}</SelectItem>
                <SelectItem value="APPROVED">{isRTL ? "موافق عليه" : "Approved"}</SelectItem>
                <SelectItem value="REJECTED">{isRTL ? "مرفوض" : "Rejected"}</SelectItem>
              </SelectContent>
            </Select>
            <Select value={roleFilter} onValueChange={setRoleFilter}>
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder={isRTL ? "الدور" : "Role"} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">{isRTL ? "الكل" : "All Roles"}</SelectItem>
                <SelectItem value="TENANT">{isRTL ? "مستأجر" : "Tenant"}</SelectItem>
                <SelectItem value="PROPERTY_OWNER">{isRTL ? "مالك عقار" : "Property Owner"}</SelectItem>
                <SelectItem value="OWNER">{isRTL ? "مالك مؤسسي" : "Corporate Owner"}</SelectItem>
                <SelectItem value="VENDOR">{isRTL ? "مورد" : "Vendor"}</SelectItem>
                <SelectItem value="AGENT">{isRTL ? "وكيل" : "Agent"}</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Cases Table */}
      <Card>
        <CardContent className="p-0">
          {isLoading ? (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-primary" />
            </div>
          ) : filteredCases.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 text-muted-foreground">
              <FileText className="h-12 w-12 mb-4" />
              <p>{isRTL ? "لا توجد طلبات" : "No applications found"}</p>
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>{isRTL ? "مقدم الطلب" : "Applicant"}</TableHead>
                  <TableHead>{isRTL ? "الدور" : "Role"}</TableHead>
                  <TableHead>{isRTL ? "الحالة" : "Status"}</TableHead>
                  <TableHead>{isRTL ? "المستندات" : "Documents"}</TableHead>
                  <TableHead>{isRTL ? "تاريخ التقديم" : "Submitted"}</TableHead>
                  <TableHead className="text-end">{isRTL ? "الإجراءات" : "Actions"}</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredCases.map((c) => (
                  <TableRow key={c._id}>
                    <TableCell>
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center">
                          <User className="h-4 w-4 text-primary" />
                        </div>
                        <div>
                          <p className="font-medium">{c.basic_info.name}</p>
                          <p className="text-sm text-muted-foreground">{c.basic_info.email}</p>
                        </div>
                      </div>
                    </TableCell>
                    <TableCell>
                      <Badge variant="outline">
                        {ROLE_LABELS[c.role]?.[isRTL ? "ar" : "en"] || c.role}
                      </Badge>
                    </TableCell>
                    <TableCell>
                      <Badge className={cn("font-normal", STATUS_COLORS[c.status])}>
                        {STATUS_LABELS[c.status]?.[isRTL ? "ar" : "en"] || c.status}
                      </Badge>
                    </TableCell>
                    <TableCell>
                      <span className="text-sm">
                        {c.documents?.length || 0} {isRTL ? "مستند" : "docs"}
                      </span>
                    </TableCell>
                    <TableCell>
                      <span className="text-sm text-muted-foreground">
                        {new Date(c.createdAt).toLocaleDateString(isRTL ? "ar-SA" : "en-US")}
                      </span>
                    </TableCell>
                    <TableCell className="text-end">
                      <div className="flex items-center justify-end gap-2">
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => window.open(`/admin/onboarding/${c._id}`, "_blank")}
                        >
                          <ExternalLink className="h-4 w-4" />
                        </Button>
                        {(c.status === "SUBMITTED" || c.status === "UNDER_REVIEW") && (
                          <>
                            <Button
                              variant="ghost"
                              size="sm"
                              className="text-green-600 hover:text-green-700 hover:bg-green-50"
                              onClick={() => {
                                setSelectedCase(c);
                                setReviewAction("approve");
                              }}
                            >
                              <CheckCircle className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="sm"
                              className="text-red-600 hover:text-red-700 hover:bg-red-50"
                              onClick={() => {
                                setSelectedCase(c);
                                setReviewAction("reject");
                              }}
                            >
                              <XCircle className="h-4 w-4" />
                            </Button>
                          </>
                        )}
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      {/* Review Dialog */}
      <Dialog open={!!reviewAction && !!selectedCase} onOpenChange={() => {
        setReviewAction(null);
        setSelectedCase(null);
        setRejectionReason("");
      }}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {reviewAction === "approve"
                ? (isRTL ? "تأكيد الموافقة" : "Confirm Approval")
                : (isRTL ? "تأكيد الرفض" : "Confirm Rejection")}
            </DialogTitle>
            <DialogDescription>
              {selectedCase && (
                <span>
                  {isRTL
                    ? `مراجعة طلب ${selectedCase.basic_info.name}`
                    : `Reviewing application for ${selectedCase.basic_info.name}`}
                </span>
              )}
            </DialogDescription>
          </DialogHeader>

          {reviewAction === "reject" && (
            <div className="space-y-2">
              <label className="text-sm font-medium">
                {isRTL ? "سبب الرفض" : "Rejection Reason"}
              </label>
              <Textarea
                value={rejectionReason}
                onChange={(e) => setRejectionReason(e.target.value)}
                placeholder={isRTL ? "اكتب سبب الرفض..." : "Enter rejection reason..."}
                rows={3}
              />
            </div>
          )}

          {reviewAction === "approve" && selectedCase && selectedCase.documents.length === 0 && (
            <div className="flex items-center gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <AlertTriangle className="h-5 w-5 text-yellow-600" />
              <p className="text-sm text-yellow-800">
                {isRTL
                  ? "لم يتم تحميل أي مستندات. سيتم الموافقة على الطلب مباشرة."
                  : "No documents uploaded. Application will be approved directly."}
              </p>
            </div>
          )}

          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => {
                setReviewAction(null);
                setSelectedCase(null);
                setRejectionReason("");
              }}
              disabled={isProcessing}
            >
              {isRTL ? "إلغاء" : "Cancel"}
            </Button>
            <Button
              variant={reviewAction === "approve" ? "default" : "destructive"}
              onClick={handleReview}
              disabled={isProcessing || (reviewAction === "reject" && !rejectionReason.trim())}
            >
              {isProcessing && <Loader2 className="h-4 w-4 me-2 animate-spin" />}
              {reviewAction === "approve"
                ? (isRTL ? "موافقة" : "Approve")
                : (isRTL ? "رفض" : "Reject")}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}

]]>
</file>

<file path="app/admin/page.tsx">
<![CDATA[
export { default } from "@/app/fm/admin/page";
export * from "@/app/fm/admin/page";

]]>
</file>

<file path="app/admin/template.tsx">
<![CDATA[
import { ReactNode } from "react";
import { OrgContextGate } from "@/components/fm/OrgContextGate";

interface AdminTemplateProps {
  children: ReactNode;
}

/**
 * Template to enforce organization selection for legacy /admin routes.
 * These pages reuse FM admin surfaces and must not load without tenant context.
 */
export default function AdminTemplate({ children }: AdminTemplateProps) {
  return <OrgContextGate>{children}</OrgContextGate>;
}

]]>
</file>

<file path="app/admin/test-notifications/page.tsx">
<![CDATA[
"use client";

/**
 * Notification Test Page
 * SUPER_ADMIN only - Test SMS and WhatsApp notifications
 *
 * Features:
 * - Send test SMS via Twilio
 * - Send test WhatsApp via Twilio
 * - View delivery status
 * - Check configuration status
 *
 * @version 1.0.0
 * @date 2024-12-04
 */

import React, { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { useSession } from "next-auth/react";
import {
  MessageSquare,
  Phone,
  Send,
  CheckCircle,
  XCircle,
  AlertCircle,
  Loader2,
  Settings,
  RefreshCw,
} from "lucide-react";
import { toast } from "sonner";
import { useTranslation } from "@/contexts/TranslationContext";

interface ConfigStatus {
  sms: {
    configured: boolean;
    accountSid?: string;
    phoneNumber?: string;
  };
  whatsapp: {
    configured: boolean;
    phoneNumber?: string;
  };
  email: {
    configured: boolean;
    provider?: string;
  };
}

interface TestResult {
  success: boolean;
  messageId?: string;
  error?: string;
  timestamp: Date;
}

export default function NotificationTestPage() {
  const router = useRouter();
  const { t } = useTranslation();
  const { data: session, status } = useSession();

  // Form state
  const [phoneNumber, setPhoneNumber] = useState("");
  const [message, setMessage] = useState(
    "This is a test notification from Fixzit. If you received this, your notification system is working correctly!",
  );
  const [channel, setChannel] = useState<"sms" | "whatsapp">("sms");

  // Status state
  const [configStatus, setConfigStatus] = useState<ConfigStatus | null>(null);
  const [isLoadingConfig, setIsLoadingConfig] = useState(true);
  const [isSending, setIsSending] = useState(false);
  const [testResults, setTestResults] = useState<TestResult[]>([]);

  // Auth check
  useEffect(() => {
    if (status === "loading") return;

    if (!session?.user) {
      router.push("/login?callbackUrl=/admin/test-notifications");
      return;
    }

    if (session.user.role !== "SUPER_ADMIN") {
      toast.error(t("admin.accessDenied", "Access Denied: SUPER_ADMIN only"));
      router.push("/dashboard");
    }
  }, [session, status, router, t]);

  // Load configuration status
  useEffect(() => {
    if (session?.user?.role !== "SUPER_ADMIN") return;

    const loadConfig = async () => {
      try {
        const response = await fetch("/api/admin/notifications/config");
        if (response.ok) {
          const data = await response.json();
          setConfigStatus(data);
        }
      } catch {
        // Config loading failed - silently continue, user will see empty config
      } finally {
        setIsLoadingConfig(false);
      }
    };

    loadConfig();
  }, [session]);

  const handleSendTest = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!phoneNumber.trim()) {
      toast.error(t("admin.notifications.phoneRequired", "Phone number is required"));
      return;
    }

    setIsSending(true);

    try {
      const response = await fetch("/api/admin/notifications/test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          channel,
          to: phoneNumber,
          message,
        }),
      });

      const data = await response.json();

      const result: TestResult = {
        success: response.ok,
        messageId: data.messageId,
        error: data.error,
        timestamp: new Date(),
      };

      setTestResults((prev) => [result, ...prev].slice(0, 10));

      if (response.ok) {
        toast.success(
          t("admin.notifications.sent", "Test message sent successfully!"),
        );
      } else {
        toast.error(data.error || t("admin.notifications.failed", "Failed to send"));
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : "Unknown error";
      setTestResults((prev) =>
        [
          { success: false, error: errorMsg, timestamp: new Date() },
          ...prev,
        ].slice(0, 10),
      );
      toast.error(errorMsg);
    } finally {
      setIsSending(false);
    }
  };

  if (status === "loading" || session?.user?.role !== "SUPER_ADMIN") {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8 max-w-4xl">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-foreground flex items-center gap-3">
          <MessageSquare className="h-8 w-8 text-primary" />
          {t("admin.notifications.testTitle", "Notification Testing")}
        </h1>
        <p className="text-muted-foreground mt-2">
          {t(
            "admin.notifications.testSubtitle",
            "Test SMS and WhatsApp notifications to verify your configuration",
          )}
        </p>
      </div>

      {/* Configuration Status */}
      <div className="bg-card rounded-xl border p-6 mb-8">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <Settings className="h-5 w-5" />
            {t("admin.notifications.configStatus", "Configuration Status")}
          </h2>
          <button
            onClick={() => window.location.reload()}
            className="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1"
          >
            <RefreshCw className="h-4 w-4" />
            {t("common.refresh", "Refresh")}
          </button>
        </div>

        {isLoadingConfig ? (
          <div className="flex items-center gap-2 text-muted-foreground">
            <Loader2 className="h-4 w-4 animate-spin" />
            {t("common.loading", "Loading...")}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {/* SMS Status */}
            <div className="p-4 rounded-lg bg-muted/50">
              <div className="flex items-center gap-2 mb-2">
                <Phone className="h-5 w-5" />
                <span className="font-medium">SMS (Twilio)</span>
              </div>
              {configStatus?.sms?.configured ? (
                <div className="flex items-center gap-2 text-green-600">
                  <CheckCircle className="h-4 w-4" />
                  <span className="text-sm">
                    {t("admin.notifications.configured", "Configured")}
                  </span>
                </div>
              ) : (
                <div className="flex items-center gap-2 text-red-600">
                  <XCircle className="h-4 w-4" />
                  <span className="text-sm">
                    {t("admin.notifications.notConfigured", "Not Configured")}
                  </span>
                </div>
              )}
              {configStatus?.sms?.phoneNumber && (
                <p className="text-xs text-muted-foreground mt-1">
                  From: {configStatus.sms.phoneNumber}
                </p>
              )}
            </div>

            {/* WhatsApp Status */}
            <div className="p-4 rounded-lg bg-muted/50">
              <div className="flex items-center gap-2 mb-2">
                <MessageSquare className="h-5 w-5" />
                <span className="font-medium">WhatsApp</span>
              </div>
              {configStatus?.whatsapp?.configured ? (
                <div className="flex items-center gap-2 text-green-600">
                  <CheckCircle className="h-4 w-4" />
                  <span className="text-sm">
                    {t("admin.notifications.configured", "Configured")}
                  </span>
                </div>
              ) : (
                <div className="flex items-center gap-2 text-red-600">
                  <XCircle className="h-4 w-4" />
                  <span className="text-sm">
                    {t("admin.notifications.notConfigured", "Not Configured")}
                  </span>
                </div>
              )}
              {configStatus?.whatsapp?.phoneNumber && (
                <p className="text-xs text-muted-foreground mt-1">
                  From: {configStatus.whatsapp.phoneNumber}
                </p>
              )}
            </div>

            {/* Email Status */}
            <div className="p-4 rounded-lg bg-muted/50">
              <div className="flex items-center gap-2 mb-2">
                <AlertCircle className="h-5 w-5" />
                <span className="font-medium">Email</span>
              </div>
              {configStatus?.email?.configured ? (
                <div className="flex items-center gap-2 text-green-600">
                  <CheckCircle className="h-4 w-4" />
                  <span className="text-sm">
                    {configStatus.email.provider || "Configured"}
                  </span>
                </div>
              ) : (
                <div className="flex items-center gap-2 text-yellow-600">
                  <AlertCircle className="h-4 w-4" />
                  <span className="text-sm">
                    {t("admin.notifications.notConfigured", "Not Configured")}
                  </span>
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Test Form */}
      <div className="bg-card rounded-xl border p-6 mb-8">
        <h2 className="text-lg font-semibold mb-4">
          {t("admin.notifications.sendTest", "Send Test Message")}
        </h2>

        <form onSubmit={handleSendTest} className="space-y-4">
          {/* Channel Selection */}
          <div>
            <label className="block text-sm font-medium mb-2">
              {t("admin.notifications.channel", "Channel")}
            </label>
            <div className="flex gap-4">
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="channel"
                  value="sms"
                  checked={channel === "sms"}
                  onChange={() => setChannel("sms")}
                  className="w-4 h-4 text-primary"
                />
                <Phone className="h-4 w-4" />
                <span>SMS</span>
              </label>
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="channel"
                  value="whatsapp"
                  checked={channel === "whatsapp"}
                  onChange={() => setChannel("whatsapp")}
                  className="w-4 h-4 text-primary"
                />
                <MessageSquare className="h-4 w-4" />
                <span>WhatsApp</span>
              </label>
            </div>
          </div>

          {/* Phone Number */}
          <div>
            <label className="block text-sm font-medium mb-2">
              {t("admin.notifications.phoneNumber", "Phone Number")}
            </label>
            <input
              type="tel"
              value={phoneNumber}
              onChange={(e) => setPhoneNumber(e.target.value)}
              placeholder="+966501234567"
              className="w-full px-4 py-2 rounded-lg border bg-background focus:ring-2 focus:ring-primary focus:border-primary"
              dir="ltr"
            />
            <p className="text-xs text-muted-foreground mt-1">
              {t(
                "admin.notifications.phoneHint",
                "Enter phone in E.164 format (e.g., +966501234567)",
              )}
            </p>
          </div>

          {/* Message */}
          <div>
            <label className="block text-sm font-medium mb-2">
              {t("admin.notifications.message", "Message")}
            </label>
            <textarea
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              rows={4}
              className="w-full px-4 py-2 rounded-lg border bg-background focus:ring-2 focus:ring-primary focus:border-primary resize-none"
            />
            <p className="text-xs text-muted-foreground mt-1">
              {message.length}/1600{" "}
              {t("admin.notifications.characters", "characters")}
            </p>
          </div>

          {/* Submit */}
          <button
            type="submit"
            disabled={isSending || !phoneNumber.trim()}
            className="w-full px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium"
          >
            {isSending ? (
              <>
                <Loader2 className="h-5 w-5 animate-spin" />
                {t("admin.notifications.sending", "Sending...")}
              </>
            ) : (
              <>
                <Send className="h-5 w-5" />
                {t("admin.notifications.sendButton", "Send Test Message")}
              </>
            )}
          </button>
        </form>
      </div>

      {/* Test Results */}
      {testResults.length > 0 && (
        <div className="bg-card rounded-xl border p-6">
          <h2 className="text-lg font-semibold mb-4">
            {t("admin.notifications.results", "Test Results")}
          </h2>
          <div className="space-y-3">
            {testResults.map((result, index) => (
              <div
                key={index}
                className={`p-4 rounded-lg border ${
                  result.success
                    ? "bg-green-50 border-green-200 dark:bg-green-950/20 dark:border-green-800"
                    : "bg-red-50 border-red-200 dark:bg-red-950/20 dark:border-red-800"
                }`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    {result.success ? (
                      <CheckCircle className="h-5 w-5 text-green-600" />
                    ) : (
                      <XCircle className="h-5 w-5 text-red-600" />
                    )}
                    <span
                      className={
                        result.success ? "text-green-700" : "text-red-700"
                      }
                    >
                      {result.success
                        ? t("admin.notifications.success", "Success")
                        : t("admin.notifications.failure", "Failed")}
                    </span>
                  </div>
                  <span className="text-xs text-muted-foreground">
                    {result.timestamp.toLocaleTimeString()}
                  </span>
                </div>
                {result.messageId && (
                  <p className="text-xs text-muted-foreground mt-1">
                    Message ID: {result.messageId}
                  </p>
                )}
                {result.error && (
                  <p className="text-sm text-red-600 mt-1">{result.error}</p>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Help Section */}
      <div className="mt-8 p-6 bg-muted/30 rounded-xl border border-dashed">
        <h3 className="font-semibold mb-2">
          {t("admin.notifications.helpTitle", "Configuration Help")}
        </h3>
        <ul className="text-sm text-muted-foreground space-y-1">
          <li>
            • SMS requires: <code className="bg-muted px-1 rounded">TWILIO_ACCOUNT_SID</code>,{" "}
            <code className="bg-muted px-1 rounded">TWILIO_AUTH_TOKEN</code>,{" "}
            <code className="bg-muted px-1 rounded">TWILIO_PHONE_NUMBER</code>
          </li>
          <li>
            • WhatsApp requires:{" "}
            <code className="bg-muted px-1 rounded">TWILIO_WHATSAPP_NUMBER</code>{" "}
            (same Twilio credentials)
          </li>
          <li>
            • For WhatsApp sandbox, recipient must first message the Twilio number
          </li>
        </ul>
      </div>
    </div>
  );
}

]]>
</file>

<file path="app/administration/page.tsx">
<![CDATA[
"use client";

/**
 * Administration Module - Fully Integrated with API and RBAC
 *
 * This module provides comprehensive administration features for:
 * - User Management (CRUD operations)
 * - Role & Permission Management
 * - Audit Log Viewing
 * - System Settings Configuration
 *
 * Access Control: Super Admin and Corporate Admin only
 * Compliance: WCAG 2.1 AA, RTL-first, Gov V5 structure
 */

export const dynamic = "force-dynamic";
export const fetchCache = "force-no-store";

import React, { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { useSession } from "next-auth/react";
import {
  Users,
  Shield,
  Activity,
  Settings as SettingsIcon,
  UserPlus,
  Download,
  Edit,
  Lock,
  Unlock,
  Trash2,
  Search,
  Filter,
  Save,
  X,
  Check,
  AlertCircle,
  MoreVertical,
  Eye,
  UserCog,
  Globe,
  DollarSign,
  Bell,
  MessageSquare,
} from "lucide-react";
import AdminNotificationsTab from "@/components/admin/AdminNotificationsTab";
import CommunicationDashboard from "@/components/admin/CommunicationDashboard";
import RoleBadge from "@/components/admin/RoleBadge";
import UserModal, { type UserFormData } from "@/components/admin/UserModal";
import { logger } from "@/lib/logger";
import { useTranslation } from "@/contexts/TranslationContext";
import { useAuthRbac } from "@/hooks/useAuthRbac";
import { SubRole } from "@/lib/rbac/client-roles";
import {
  adminApi,
  type OrgSettings,
  type AdminUser,
  type AdminRole,
  type AuditLogEntry,
} from "@/lib/api/admin";
import {
  useUsers,
  useRoles,
  useAuditLogs,
  useOrgSettings,
  useCreateUser,
  useUpdateUser,
  useDeleteUser,
} from "@/hooks/useAdminData";

// Types
interface User {
  id: string;
  name: string;
  email: string;
  role: string;
  subRole?: SubRole; // STRICT v4.1: Team Member sub-role
  status: "Active" | "Inactive" | "Locked";
  lastLogin: string;
  department: string;
  phone?: string;
  createdAt: string;
  org_id: string;
}

interface Role {
  id: string;
  name: string;
  description: string;
  permissions: string[];
  userCount: number;
  createdAt: string;
}

interface AuditLog {
  id: string;
  timestamp: string;
  user: string;
  action: string;
  resource: string;
  status: "Success" | "Failed";
  ip: string;
  details?: string;
}

interface SystemSetting {
  key: string;
  value: string;
  category: string;
  description: string;
  type: "string" | "number" | "boolean";
}

// interface ApiResponse<T> {
//   data: T;
//   error?: string;
//   message?: string;
// }

const AdminModule: React.FC = () => {
  const router = useRouter();
  const { t } = useTranslation();
  const { data: session, status: sessionStatus } = useSession();
  const { isSuperAdmin, isLoading: rbacLoading } = useAuthRbac();

  // Session + RBAC helpers
  const sessionUser = session?.user;
  const authLoading = sessionStatus === "loading" || rbacLoading;
  const isCorporateAdmin = sessionUser?.role === "ADMIN";
  const hasAdminAccess = isSuperAdmin || isCorporateAdmin;
  const orgId = sessionUser?.orgId ?? undefined;
  const activeOrgId = orgId ?? "platform";

  // State management
  const [activeTab, setActiveTab] = useState<
    | "users"
    | "roles"
    | "audit"
    | "settings"
    | "tenants"
    | "billing"
    | "notifications"
    | "communications"
  >("users");
  const [searchQuery, setSearchQuery] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  // User management state
  const [userModalOpen, setUserModalOpen] = React.useState(false);
  const [editingUser, setEditingUser] = useState<User | null>(null);

  // Settings state
  const [editedSettings, setEditedSettings] = useState<Map<string, string>>(
    new Map(),
  );

  // TanStack Query hooks for data fetching (Step 3)
  const {
    data: usersData,
    isLoading: isLoadingUsers,
    error: usersError,
  } = useUsers({ limit: 100, search: searchQuery || undefined });
  const {
    data: rolesData,
    isLoading: isLoadingRoles,
    error: rolesError,
  } = useRoles({ limit: 100 });
  const {
    data: auditLogsData,
    isLoading: isLoadingAuditLogs,
    error: auditLogsError,
  } = useAuditLogs({ limit: 100 });
  const {
    data: orgSettings,
    isLoading: isLoadingOrgSettings,
    error: orgSettingsError,
  } = useOrgSettings(activeOrgId);

  // Mutations
  const createUserMutation = useCreateUser();
  const updateUserMutation = useUpdateUser();
  const deleteUserMutation = useDeleteUser();

  // Map API data to UI format
  const users = useMemo(
    () => (usersData ? usersData.map(mapAdminUser) : []),
    [usersData]
  );
  const roles = useMemo(
    () => (rolesData ? rolesData.map(mapAdminRole) : []),
    [rolesData]
  );
  const auditLogs = useMemo(
    () => (auditLogsData ? auditLogsData.map(mapAuditLogEntry) : []),
    [auditLogsData]
  );
  const settings = useMemo(
    () => (orgSettings ? normalizeSettingsFromOrg(orgSettings) : []),
    [orgSettings]
  );

  // Determine loading state based on active tab
  const isLoadingData =
    (activeTab === "users" && isLoadingUsers) ||
    (activeTab === "roles" && isLoadingRoles) ||
    (activeTab === "audit" && isLoadingAuditLogs) ||
    (activeTab === "settings" && isLoadingOrgSettings);

  const mapAdminUser = (adminUser: AdminUser): User => {
    // Normalize role to canonical form for STRICT v4.1
    let canonicalRole = adminUser.role || adminUser.roles?.[0];
    
    // Handle special cases
    if (adminUser.isSuperAdmin) {
      canonicalRole = "SUPER_ADMIN";
    } else if (!canonicalRole) {
      canonicalRole = "TENANT"; // Default fallback
    }
    
    // Normalize legacy role names (e.g., "Super Admin" -> "SUPER_ADMIN")
    // This ensures UI always works with canonical enums
    canonicalRole = canonicalRole.toUpperCase().replace(/\s+/g, "_");
    
    return {
      id: adminUser.id,
      name:
        adminUser.name ||
        adminUser.email ||
        adminUser.username ||
        t("admin.users.table.unknownUser", "Unknown user"),
      email: adminUser.email || adminUser.username || "—",
      role: canonicalRole,
      subRole: adminUser.subRole as SubRole | undefined, // Preserve STRICT v4.1 sub-role
      status: adminUser.isActive ? "Active" : "Inactive",
      lastLogin:
        adminUser.updatedAt?.toString() ||
        adminUser.createdAt?.toString() ||
        t("admin.users.table.noActivity", "No activity recorded"),
      department:
        adminUser.orgId || t("admin.users.table.departmentFallback", "General"),
      phone: adminUser.username,
      createdAt: adminUser.createdAt?.toString() || new Date().toISOString(),
      // ORGID-FIX: Use empty string for missing orgId (type requires string)
      org_id: adminUser.orgId || "",
    };
  };

  const mapAdminRole = (role: AdminRole): Role => ({
    id: role.id,
    name: role.name,
    description: role.description || "",
    permissions: role.permissions || [],
    userCount: role.permissions ? role.permissions.length : 0,
    createdAt: role.createdAt || "",
  });

  const mapAuditLogEntry = (entry: AuditLogEntry): AuditLog => ({
    id: entry.id,
    timestamp: entry.timestamp,
    user: entry.actorEmail || entry.actorId,
    action: entry.action,
    resource: entry.resourceType
      ? `${entry.resourceType}/${entry.resourceId ?? ""}`
      : entry.action,
    status: entry.success ? "Success" : "Failed",
    ip: entry.ipAddress || "—",
    details:
      entry.errorMessage ||
      (entry.meta ? JSON.stringify(entry.meta) : undefined),
  });

  const formatUserStatus = (status: User["status"]): string => {
    switch (status) {
      case "Active":
        return t("admin.users.status.active", "Active");
      case "Inactive":
        return t("admin.users.status.inactive", "Inactive");
      case "Locked":
        return t("admin.users.status.locked", "Locked");
      default:
        return status;
    }
  };

  const formatAuditStatus = (status: AuditLog["status"]): string => {
    return status === "Success"
      ? t("admin.audit.status.success", "Success")
      : t("admin.audit.status.failed", "Failed");
  };

  const normalizeSettingsFromOrg = (payload: OrgSettings): SystemSetting[] => {
    const rows: SystemSetting[] = [
      {
        key: "org.name",
        value: payload.name || "",
        category: "General",
        description: t(
          "admin.settings.fields.orgName",
          "Organization display name",
        ),
        type: "string",
      },
      {
        key: "org.timezone",
        value: payload.timezone || "",
        category: "General",
        description: t("admin.settings.fields.timezone", "Default timezone"),
        type: "string",
      },
      {
        key: "org.language",
        value: payload.language || "en",
        category: "Localization",
        description: t("admin.settings.fields.language", "Default language"),
        type: "string",
      },
    ];

    Object.entries(payload.features || {}).forEach(([featureKey, enabled]) => {
      rows.push({
        key: `feature.${featureKey}`,
        value: String(enabled),
        category: "Features",
        description: t(
          "admin.settings.fields.featureToggle",
          "Feature availability",
        ),
        type: "boolean",
      });
    });

    return rows;
  };

  // RBAC Check
  useEffect(() => {
    if (authLoading) return;

    if (!sessionUser) {
      router.replace(
        `/login?callbackUrl=${encodeURIComponent("/administration")}`,
      );
      return;
    }

    if (!hasAdminAccess) {
      logger.warn("Access denied to admin module", { role: sessionUser.role });
      router.replace("/dashboard");
    }
  }, [authLoading, sessionUser, hasAdminAccess, router]);

  // Handle query errors (Step 3: TanStack Query integration)
  useEffect(() => {
    const queryError =
      (activeTab === "users" && usersError) ||
      (activeTab === "roles" && rolesError) ||
      (activeTab === "audit" && auditLogsError) ||
      (activeTab === "settings" && orgSettingsError);

    if (queryError) {
      const errorMessage =
        queryError instanceof Error
          ? queryError.message
          : t("admin.common.errors.fetchData", "Failed to fetch data");
      setError(errorMessage);
      logger.error(`Failed to fetch ${activeTab} data:`, queryError);
    } else {
      setError(null);
    }
  }, [
    activeTab,
    usersError,
    rolesError,
    auditLogsError,
    orgSettingsError,
    t,
  ]);

  // User actions
  const handleAddUser = () => {
    setEditingUser(null);
    setUserModalOpen(true);
  };

  const handleEditUser = (user: User) => {
    setEditingUser(user);
    setUserModalOpen(true);
  };

  const handleSaveUser = async (userData: UserFormData) => {
    try {
      if (editingUser) {
        // Update existing user with org scoping (B.1 Multi-tenancy Enforcement)
        await updateUserMutation.mutateAsync({
          id: editingUser.id,
          data: {
            name: userData.name,
            email: userData.email,
            role: userData.role,
            orgId: activeOrgId, // Enforce tenant scope to prevent cross-tenant updates
            isActive: userData.status ? userData.status !== "Inactive" : undefined,
            // Include subRole if provided (STRICT v4.1)
            ...(userData.subRole ? { subRole: userData.subRole } : {}),
          },
        });
        setSuccessMessage(
          t("admin.users.toast.updated", "User updated successfully"),
        );
      } else {
        // Create new user
        await createUserMutation.mutateAsync({
          name: userData.name!,
          email: userData.email!,
          role: userData.role!,
          orgId: activeOrgId,
          // Include subRole if provided (STRICT v4.1)
          ...(userData.subRole ? { subRole: userData.subRole } : {}),
        });
        setSuccessMessage(
          t("admin.users.toast.created", "User created successfully"),
        );
      }
      setUserModalOpen(false);
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      const errorMessage =
        err instanceof Error
          ? err.message
          : t("admin.users.errors.save", "Failed to save user");
      setError(errorMessage);
      logger.error("Failed to save user:", err);
      throw err; // Re-throw so UserModal can show the error
    }
  };

  const handleToggleUserStatus = async (
    userId: string,
    currentStatus: string,
  ) => {
    try {
      const newStatus = currentStatus === "Active" ? "Inactive" : "Active";
      await updateUserMutation.mutateAsync({
        id: userId,
        data: { isActive: newStatus === "Active", orgId: activeOrgId },
      });
      setSuccessMessage(
        newStatus === "Active"
          ? t("admin.users.toast.activated", "User activated successfully")
          : t("admin.users.toast.deactivated", "User deactivated successfully"),
      );
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError(t("admin.users.errors.status", "Failed to update user status"));
      logger.error("Failed to update user status:", err);
    }
  };

  const handleDeleteUser = async (userId: string) => {
    if (
      !confirm(
        t(
          "admin.users.confirmDelete",
          "Are you sure you want to delete this user?",
        ),
      )
    )
      return;

    try {
      await deleteUserMutation.mutateAsync(userId);
      setSuccessMessage(
        t("admin.users.toast.deleted", "User deleted successfully"),
      );
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError(t("admin.users.errors.delete", "Failed to delete user"));
      logger.error("Failed to delete user:", err);
    }
  };

  // Settings actions
  const handleSettingChange = (key: string, value: string) => {
    const newEdited = new Map(editedSettings);
    newEdited.set(key, value);
    setEditedSettings(newEdited);
  };

  const handleSaveSettings = async () => {
    try {
      if (!orgSettings) return;

      const updates: Partial<OrgSettings> = {};
      const featureUpdates: Record<string, boolean> = {};

      editedSettings.forEach((value, key) => {
        if (key === "org.name") {
          updates.name = value;
        } else if (key === "org.timezone") {
          updates.timezone = value;
        } else if (key === "org.language") {
          updates.language = value;
        } else if (key.startsWith("feature.")) {
          featureUpdates[key.replace("feature.", "")] = value === "true";
        }
      });

      if (Object.keys(featureUpdates).length) {
        updates.features = {
          ...(orgSettings.features || {}),
          ...featureUpdates,
        };
      }

      const _updated = await adminApi.updateOrgSettings(activeOrgId, updates);
      // Note: orgSettings and settings will be updated automatically via TanStack Query refetch
      setEditedSettings(new Map());
      setSuccessMessage(
        t("admin.settings.toast.saved", "Settings saved successfully"),
      );
      logger.info("Settings updated", { count: editedSettings.size });
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError(t("admin.settings.errors.save", "Failed to save settings"));
      logger.error("Failed to save settings:", err);
    }
  };

  // Define tabs before any early returns (React Hooks rule)
  const tabs = useMemo(() => {
    const baseTabs = [
      { id: "users", label: t("admin.tabs.users", "Users"), icon: Users },
      { id: "roles", label: t("admin.tabs.roles", "Roles"), icon: Shield },
      {
        id: "audit",
        label: t("admin.tabs.audit", "Audit Logs"),
        icon: Activity,
      },
      {
        id: "settings",
        label: t("admin.tabs.settings", "Settings"),
        icon: SettingsIcon,
      },
    ];

    if (isSuperAdmin) {
      baseTabs.push(
        {
          id: "notifications",
          label: t("admin.tabs.notifications", "Send Notifications"),
          icon: Bell,
        },
        {
          id: "communications",
          label: t("admin.tabs.communications", "Communications"),
          icon: MessageSquare,
        },
        {
          id: "tenants",
          label: t("admin.tabs.tenants", "Tenant Management"),
          icon: Globe,
        },
        {
          id: "billing",
          label: t("admin.tabs.billing", "Subscriptions & Billing"),
          icon: DollarSign,
        },
      );
    }

    return baseTabs;
  }, [isSuperAdmin, t]);

  // Loading and access control
  if (authLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mb-4"></div>
          <p className="text-gray-600">
            {t("admin.common.loadingSession", "Loading session...")}
          </p>
        </div>
      </div>
    );
  }

  if (!sessionUser || !hasAdminAccess) {
    return null; // Router will redirect
  }

  const renderUsers = () => (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">
            {t("admin.users.title", "User Management")}
          </h2>
          <p className="text-gray-600 mt-1">
            {t("admin.users.subtitle", "Manage organization users and access")}
          </p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={() => {
              /* Export functionality */
            }}
            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
            aria-label={t("admin.users.actions.exportAria", "Export users")}
          >
            <Download size={20} />
            <span className="hidden sm:inline">
              {t("admin.common.export", "Export")}
            </span>
          </button>
          <button
            onClick={handleAddUser}
            className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark flex items-center gap-2"
            aria-label={t("admin.users.actions.addAria", "Add new user")}
          >
            <UserPlus size={20} />
            {t("admin.users.actions.add", "Add User")}
          </button>
        </div>
      </div>

      {/* Search and filters */}
      <div className="flex flex-col sm:flex-row gap-4">
        <div className="relative flex-1">
          <Search
            className="absolute start-3 top-1/2 -translate-y-1/2 text-gray-400"
            size={20}
          />
          <input
            type="text"
            placeholder={t("admin.users.searchPlaceholder", "Search users...")}
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full ps-10 pe-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
            aria-label={t("admin.users.searchAria", "Search users")}
          />
        </div>
        <button
          className="px-4 py-2 border rounded-lg hover:bg-gray-50 flex items-center gap-2"
          aria-label={t("admin.users.actions.filterAria", "Filter users")}
        >
          <Filter size={20} />
          {t("admin.common.filters", "Filters")}
        </button>
      </div>

      {/* Users table */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
                {t("admin.users.table.user", "User")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
                {t("admin.users.table.role", "Role")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
                {t("admin.users.table.status", "Status")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
                {t("admin.users.table.lastLogin", "Last Login")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
                {t("admin.users.table.department", "Department")}
              </th>
              <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">
                {t("admin.users.table.actions", "Actions")}
              </th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {isLoadingData ? (
              <tr>
                <td colSpan={6} className="text-center p-6">
                  <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                </td>
              </tr>
            ) : error ? (
              <tr>
                <td colSpan={6} className="text-center p-6 text-destructive">
                  <AlertCircle className="inline mb-1" size={20} /> {error}
                </td>
              </tr>
            ) : (
              users
                .filter(
                  (u) =>
                    u.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    u.email.toLowerCase().includes(searchQuery.toLowerCase()),
                )
                .map((user) => (
                  <tr key={user.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4">
                      <div className="font-medium">{user.name}</div>
                      <div className="text-sm text-gray-500">{user.email}</div>
                    </td>
                    <td className="px-6 py-4">
                      <RoleBadge role={user.role} size="sm" />
                    </td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                          user.status === "Active"
                            ? "bg-green-100 text-green-800"
                            : user.status === "Locked"
                              ? "bg-red-100 text-red-800"
                              : "bg-gray-100 text-gray-800"
                        }`}
                      >
                        {formatUserStatus(user.status)}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-500">
                      {user.lastLogin}
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-500">
                      {user.department}
                    </td>
                    <td className="px-6 py-4 text-end">
                      <div className="flex items-center justify-end gap-2">
                        <button
                          onClick={() => handleEditUser(user)}
                          className="p-2 hover:bg-gray-100 rounded"
                          title={t("admin.users.actions.edit", "Edit user")}
                          aria-label={`${t("admin.users.actions.edit", "Edit user")} ${user.name}`}
                        >
                          <Edit size={18} />
                        </button>
                        <button
                          onClick={() =>
                            handleToggleUserStatus(user.id, user.status)
                          }
                          className="p-2 hover:bg-gray-100 rounded"
                          title={
                            user.status === "Active"
                              ? t(
                                  "admin.users.actions.deactivate",
                                  "Deactivate user",
                                )
                              : t(
                                  "admin.users.actions.activate",
                                  "Activate user",
                                )
                          }
                          aria-label={`${
                            user.status === "Active"
                              ? t(
                                  "admin.users.actions.deactivate",
                                  "Deactivate user",
                                )
                              : t(
                                  "admin.users.actions.activate",
                                  "Activate user",
                                )
                          } ${user.name}`}
                        >
                          {user.status === "Active" ? (
                            <Lock size={18} />
                          ) : (
                            <Unlock size={18} />
                          )}
                        </button>
                        <button
                          onClick={() => handleDeleteUser(user.id)}
                          className="p-2 hover:bg-gray-100 rounded text-destructive"
                          title={t("admin.users.actions.delete", "Delete user")}
                          aria-label={`${t("admin.users.actions.delete", "Delete user")} ${user.name}`}
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );

  const renderRoles = () => (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">
            {t("admin.roles.title", "Role Management")}
          </h2>
          <p className="text-gray-600 mt-1">
            {t("admin.roles.subtitle", "Define roles and permissions")}
          </p>
        </div>
        <button
          className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark flex items-center gap-2"
          aria-label={t("admin.roles.actions.addAria", "Add new role")}
        >
          <Shield size={20} />
          {t("admin.roles.actions.add", "Add Role")}
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {isLoadingData ? (
          <div className="col-span-full text-center p-12">
            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
          </div>
        ) : (
          roles.map((role) => (
            <div
              key={role.id}
              className="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow"
            >
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-secondary/20 rounded-lg">
                    <UserCog size={24} className="text-secondary-foreground" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-lg">{role.name}</h3>
                    <p className="text-sm text-gray-500">
                      {t("admin.roles.usersCount", "{{count}} users").replace(
                        "{{count}}",
                        String(role.userCount),
                      )}
                    </p>
                  </div>
                </div>
                <button
                  className="p-1 hover:bg-gray-100 rounded"
                  aria-label={t("admin.roles.actions.more", "More options")}
                >
                  <MoreVertical size={20} />
                </button>
              </div>
              <p className="text-gray-600 text-sm mb-4">{role.description}</p>
              <div className="flex flex-wrap gap-2">
                {role.permissions.slice(0, 3).map((perm) => (
                  <span
                    key={perm}
                    className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded"
                  >
                    {perm}
                  </span>
                ))}
                {role.permissions.length > 3 && (
                  <span className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                    {t(
                      "admin.roles.morePermissions",
                      "+{{count}} more",
                    ).replace("{{count}}", String(role.permissions.length - 3))}
                  </span>
                )}
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );

  const renderAuditLogs = () => (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-gray-900">
          {t("admin.audit.title", "Audit Logs")}
        </h2>
        <p className="text-gray-600 mt-1">
          {t(
            "admin.audit.subtitle",
            "System activity and security audit trail",
          )}
        </p>
      </div>

      {/* Filters */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <select
          className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
          aria-label={t("admin.audit.filters.actionAria", "Filter by action")}
        >
          <option value="">
            {t("admin.audit.filters.allActions", "All Actions")}
          </option>
          <option>
            {t("admin.audit.filters.userCreated", "User Created")}
          </option>
          <option>
            {t("admin.audit.filters.userUpdated", "User Updated")}
          </option>
          <option>{t("admin.audit.filters.login", "Login")}</option>
          <option>{t("admin.audit.filters.logout", "Logout")}</option>
        </select>
        <select
          className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
          aria-label={t("admin.audit.filters.statusAria", "Filter by status")}
        >
          <option value="">
            {t("admin.audit.filters.allStatus", "All Status")}
          </option>
          <option>{t("admin.audit.status.success", "Success")}</option>
          <option>{t("admin.audit.status.failed", "Failed")}</option>
        </select>
        <input
          type="date"
          className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
          aria-label={t("admin.audit.filters.fromDate", "From date")}
        />
        <input
          type="date"
          className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
          aria-label={t("admin.audit.filters.toDate", "To date")}
        />
      </div>

      {/* Audit table */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.timestamp", "Timestamp")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.user", "User")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.action", "Action")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.resource", "Resource")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.status", "Status")}
              </th>
              <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.ip", "IP Address")}
              </th>
              <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase">
                {t("admin.audit.table.details", "Details")}
              </th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {isLoadingData ? (
              <tr>
                <td colSpan={7} className="text-center p-6">
                  <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                </td>
              </tr>
            ) : (
              auditLogs.map((log) => (
                <tr key={log.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4 text-sm text-gray-900">
                    {log.timestamp}
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-900">
                    {log.user}
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-900">
                    {log.action}
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-500 font-mono">
                    {log.resource}
                  </td>
                  <td className="px-6 py-4">
                    <span
                      className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        log.status === "Success"
                          ? "bg-green-100 text-green-800"
                          : "bg-red-100 text-red-800"
                      }`}
                    >
                      {formatAuditStatus(log.status)}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-500 font-mono">
                    {log.ip}
                  </td>
                  <td className="px-6 py-4 text-end">
                    {log.details && (
                      <button
                        className="p-2 hover:bg-gray-100 rounded"
                        title={t(
                          "admin.audit.actions.viewDetails",
                          "View details",
                        )}
                        aria-label={t(
                          "admin.audit.actions.viewDetails",
                          "View log details",
                        )}
                      >
                        <Eye size={18} />
                      </button>
                    )}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );

  const renderSettings = () => {
    const categories = Array.from(new Set(settings.map((s) => s.category)));
    const hasChanges = editedSettings.size > 0;

    return (
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <div>
            <h2 className="text-2xl font-bold text-gray-900">
              {t("admin.settings.title", "System Settings")}
            </h2>
            <p className="text-gray-600 mt-1">
              {t("admin.settings.subtitle", "Configure system-wide parameters")}
            </p>
          </div>
          {hasChanges && (
            <div className="flex gap-3">
              <button
                onClick={() => setEditedSettings(new Map())}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2"
                aria-label={t(
                  "admin.settings.buttons.cancelAria",
                  "Cancel changes",
                )}
              >
                <X size={20} />
                {t("admin.settings.buttons.cancel", "Cancel")}
              </button>
              <button
                onClick={handleSaveSettings}
                className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark flex items-center gap-2"
                aria-label={t(
                  "admin.settings.buttons.saveAria",
                  "Save settings",
                )}
              >
                <Save size={20} />
                {t("admin.settings.buttons.save", "Save Changes")}
              </button>
            </div>
          )}
        </div>

        {isLoadingData ? (
          <div className="text-center p-12">
            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
          </div>
        ) : (
          categories.map((category) => (
            <div key={category} className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <SettingsIcon size={20} />
                {category}
              </h3>
              <div className="space-y-4">
                {settings
                  .filter((s) => s.category === category)
                  .map((setting) => {
                    const currentValue =
                      editedSettings.get(setting.key) ?? setting.value;
                    const hasChanged = editedSettings.has(setting.key);

                    return (
                      <div
                        key={setting.key}
                        className="flex items-center justify-between py-3 border-b last:border-b-0"
                      >
                        <div className="flex-1">
                          <label
                            htmlFor={setting.key}
                            className="block font-medium text-gray-900"
                          >
                            {setting.key
                              .split(".")[1]
                              .replace(/_/g, " ")
                              .replace(/\b\w/g, (l) => l.toUpperCase())}
                            {hasChanged && (
                              <span className="ms-2 text-primary text-sm">
                                ●
                              </span>
                            )}
                          </label>
                          <p className="text-sm text-gray-500 mt-1">
                            {setting.description}
                          </p>
                        </div>
                        <div className="w-64 ms-4">
                          {setting.type === "boolean" ? (
                            <select
                              id={setting.key}
                              value={currentValue}
                              onChange={(e) =>
                                handleSettingChange(setting.key, e.target.value)
                              }
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                            >
                              <option value="true">
                                {t("admin.settings.options.enabled", "Enabled")}
                              </option>
                              <option value="false">
                                {t(
                                  "admin.settings.options.disabled",
                                  "Disabled",
                                )}
                              </option>
                            </select>
                          ) : setting.type === "number" ? (
                            <input
                              id={setting.key}
                              type="number"
                              value={currentValue}
                              onChange={(e) =>
                                handleSettingChange(setting.key, e.target.value)
                              }
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                            />
                          ) : (
                            <input
                              id={setting.key}
                              type="text"
                              value={currentValue}
                              onChange={(e) =>
                                handleSettingChange(setting.key, e.target.value)
                              }
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary"
                            />
                          )}
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          ))
        )}
      </div>
    );
  };

  const renderTenantManagement = () => (
    <div className="space-y-6">
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-2xl font-bold text-gray-900">
          {t("admin.tenants.title", "Tenant Management")}
        </h2>
        <p className="text-gray-600 mt-1">
          {t(
            "admin.tenants.subtitle",
            "Manage corporate organizations, branding, and module assignments.",
          )}
        </p>
        <div className="mt-6 border rounded-lg p-4 bg-slate-50 text-sm text-slate-600">
          {t(
            "admin.tenants.placeholder",
            "Tenant management tooling is restricted to Super Admin users. Connect to the platform directory to view and update organizations.",
          )}
        </div>
      </div>
    </div>
  );

  const renderBilling = () => (
    <div className="space-y-6">
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-2xl font-bold text-gray-900">
          {t("admin.billing.title", "Subscriptions & Billing")}
        </h2>
        <p className="text-gray-600 mt-1">
          {t(
            "admin.billing.subtitle",
            "Track plans, invoices, and platform revenue operations.",
          )}
        </p>
        <div className="mt-6 border rounded-lg p-4 bg-slate-50 text-sm text-slate-600">
          {t(
            "admin.billing.placeholder",
            "Billing tooling hooks into /api/admin/billing endpoints. Wire the adminApi billing client to surface plan limits, invoices, and dunning events.",
          )}
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Success/Error notifications */}
      {successMessage && (
        <div className="fixed top-4 end-4 z-50 bg-success/90 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-slide-in">
          <Check size={20} />
          {successMessage}
        </div>
      )}
      {error && (
        <div className="fixed top-4 end-4 z-50 bg-destructive/90 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-slide-in">
          <AlertCircle size={20} />
          {error}
        </div>
      )}

      {/* Header */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <div className="flex items-center gap-3">
            <div className="p-3 bg-secondary/20 rounded-lg">
              <Shield size={32} className="text-secondary-foreground" />
            </div>
            <div>
              <h1 className="text-3xl font-bold text-gray-900">
                {t("admin.header.title", "Administration")}
              </h1>
              <p className="text-gray-600">
                {t(
                  "admin.header.subtitle",
                  "System configuration and user management",
                )}
              </p>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-1 mt-6 border-b overflow-x-auto">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as typeof activeTab)}
                className={`flex items-center gap-2 px-4 py-3 border-b-2 font-medium transition-colors whitespace-nowrap ${
                  activeTab === tab.id
                    ? "border-primary text-primary"
                    : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                }`}
                aria-current={activeTab === tab.id ? "page" : undefined}
              >
                <tab.icon size={20} />
                {tab.label}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {activeTab === "users" && renderUsers()}
        {activeTab === "roles" && renderRoles()}
        {activeTab === "audit" && renderAuditLogs()}
        {activeTab === "settings" && renderSettings()}
        {activeTab === "notifications" && isSuperAdmin && (
          <AdminNotificationsTab t={t} />
        )}
        {activeTab === "communications" && isSuperAdmin && (
          <CommunicationDashboard t={t} isRTL={false} />
        )}
        {activeTab === "tenants" && renderTenantManagement()}
        {activeTab === "billing" && renderBilling()}
      </div>

      {/* User Modal - Create/Edit Users with Sub-Role Support */}
      <UserModal
        isOpen={userModalOpen}
        onClose={() => {
          setUserModalOpen(false);
          setEditingUser(null);
        }}
        onSave={handleSaveUser}
        editingUser={editingUser}
        t={t}
      />
    </div>
  );
};

export default AdminModule;

]]>
</file>

<file path="app/aqar/auctions/page.tsx">
<![CDATA[
"use client";

// This page is purely client-rendered; disable prerender/SSG to avoid build export errors
export const prerender = false;
export const dynamic = "force-dynamic";

import { useEffect, useState } from "react";
import { useTranslation } from "@/contexts/TranslationContext";
import { Gavel, Shield } from "lucide-react";

interface AuctionListing {
  listingId: string;
  score: number;
  listing: { title?: string; city?: string; price?: number };
  highlights: string[];
}

export default function AuctionsPage() {
  const { t } = useTranslation();
  const [auctions, setAuctions] = useState<AuctionListing[]>([]);

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch(
          "/api/aqar/listings/recommendations?intent=AUCTION&limit=6&experimental=false",
        );
        if (!res.ok) throw new Error("failed");
        const data = await res.json();
        setAuctions(data.primary || []);
      } catch {
        setAuctions([]);
      }
    })();
  }, []);

  return (
    <div className="max-w-5xl mx-auto px-4 py-10 space-y-6">
      <div className="text-center space-y-2">
        <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-warning/10 text-warning">
          <Gavel className="w-4 h-4" />
          {t("aqar.auctions.badge", "مزادات Fixzit Souq المتقدمة")}
        </div>
        <h1 className="text-3xl font-bold text-foreground">
          {t("aqar.auctions.title", "مزادات مدمجة مع RNPL وREGA")}
        </h1>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          {t(
            "aqar.auctions.subtitle",
            "توقيت العد التنازلي، تأمينات، وتكامل مع Aqalat/Aflak مع إمكانية إنشاء Work Orders بعد الإغلاق.",
          )}
        </p>
      </div>

      <div className="grid gap-4 md:grid-cols-2">
        {auctions.map((auction) => (
          <article
            key={auction.listingId}
            className="border border-border rounded-2xl p-4 bg-card space-y-2"
          >
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-lg font-semibold text-foreground">
                  {auction.listing.title}
                </h2>
                <p className="text-sm text-muted-foreground">
                  {auction.listing.city}
                </p>
              </div>
              <span className="text-xs text-muted-foreground">
                AI {auction.score.toFixed(0)}%
              </span>
            </div>
            <p className="text-2xl font-bold text-foreground">
              {auction.listing.price
                ? `${auction.listing.price.toLocaleString()} ﷼`
                : "—"}
            </p>
            <ul className="text-xs text-muted-foreground list-disc ps-4">
              {auction.highlights.slice(0, 2).map((highlight) => (
                <li key={highlight}>{highlight}</li>
              ))}
            </ul>
          </article>
        ))}
        {auctions.length === 0 && (
          <div className="border border-dashed border-border rounded-2xl p-6 text-center text-muted-foreground">
            {t("aqar.auctions.empty", "لا توجد مزادات مباشرة الآن")}
          </div>
        )}
      </div>

      <div className="rounded-2xl border border-border p-4 flex items-start gap-4 bg-muted/30">
        <Shield className="w-5 h-5 text-primary mt-1" />
        <div>
          <p className="font-semibold text-foreground">
            {t("aqar.auctions.rega", "تحقق REGA وZATCA جاهز")}
          </p>
          <p className="text-sm text-muted-foreground">
            {t(
              "aqar.auctions.rega.desc",
              "نربط رخص FAL، نصدر QR زاتكا، وننشئ Work Order للتسليم بعد انتهاء المزاد.",
            )}
          </p>
        </div>
      </div>
    </div>
  );
}

]]>
</file>

<file path="app/aqar/error.tsx">
<![CDATA[
"use client";

import { useEffect } from "react";
import { RefreshCw, Home, Building2 } from "lucide-react";
import Link from "next/link";
import { useTranslation } from "@/contexts/TranslationContext";
import { Button } from "@/components/ui/button";
import { logger } from "@/lib/logger";

/**
 * Aqar (Real Estate) Error Boundary
 *
 * STRICT v4 COMPLIANCE:
 * - Uses semantic color tokens
 * - Supports RTL via TranslationContext
 * - Logs errors via centralized logger
 */
export default function AqarError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  const { t, isRTL } = useTranslation();

  useEffect(() => {
    logger.error("Aqar error caught by error boundary", {
      error: error.message,
      digest: error.digest,
      stack: error.stack,
      component: "app/aqar/error.tsx",
    });
  }, [error]);

  return (
    <div
      className="min-h-[60vh] flex flex-col items-center justify-center px-4"
      dir={isRTL ? "rtl" : "ltr"}
    >
      <div className="max-w-md w-full text-center">
        <div className="mb-6">
          <div className="w-16 h-16 mx-auto bg-destructive/10 rounded-full flex items-center justify-center">
            <Building2 className="w-8 h-8 text-destructive" />
          </div>
        </div>

        <h1 className="text-xl font-bold text-foreground mb-2">
          {t("errors.aqar.title", "Aqar Error")}
        </h1>
        <p className="text-muted-foreground mb-6">
          {t(
            "errors.aqar.message",
            "There was a problem loading real estate listings. Please try again."
          )}
        </p>

        {process.env.NODE_ENV === "development" && (
          <div className="bg-destructive/5 border border-destructive/20 rounded-lg p-3 text-start mb-6">
            <p className="text-sm font-mono text-destructive break-all">
              {error.message}
            </p>
          </div>
        )}

        <div className="flex flex-col sm:flex-row gap-3 justify-center">
          <Button onClick={reset} variant="default">
            <RefreshCw className="w-4 h-4 me-2" />
            {t("common.actions.tryAgain", "Try Again")}
          </Button>

          <Button asChild variant="outline">
            <Link href="/dashboard">
              <Home className="w-4 h-4 me-2" />
              {t("common.actions.goToDashboard", "Dashboard")}
            </Link>
          </Button>
        </div>
      </div>
    </div>
  );
}

]]>
</file>

</batch_content>


You are the "Fixzit Memory Builder" for category: "core".

You are given a batch of source files from the Fixzit codebase, wrapped in <file> tags
inside <batch_content>. Each <file> has a "path" attribute with the repository-relative
file path, and its contents are wrapped in CDATA.

YOUR TASK:
1. Read ALL files in <batch_content>.
2. For EACH file, extract architectural metadata using this schema:

[
  {
    "file": "repo-relative/path/to/file.ext",
    "category": "core",
    "summary": "One-sentence technical summary of what this file does.",
    "exports": ["ExportedFunctionOrClassName", "..."],
    "dependencies": ["ImportedModuleOrPath", "..."]
  }
]

RULES:
- Return ONLY a valid JSON array.
- NO markdown, NO backticks, NO comments, NO extra text.
- Include an entry for every file in this batch.
- If a file has no exports, use "exports": [].
- If a file has no imports, use "dependencies": [].

<batch_content>

<file path="components/souq/claims/ClaimDetails.tsx">
<![CDATA[
"use client";

import { useState, useEffect } from "react";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import type { BadgeProps } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  AlertCircle,
  CheckCircle2,
  Clock,
  FileText,
  MessageSquare,
  Package,
  Video,
  XCircle,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { logger } from "@/lib/logger";

interface Evidence {
  url: string;
  type: "photo" | "video" | "document";
  uploadedBy: "buyer" | "seller" | "admin";
  uploadedAt: string;
}

interface SellerResponse {
  solutionType: "full-refund" | "partial-refund" | "replacement" | "dispute";
  message: string;
  partialRefundAmount?: number;
  respondedAt: string;
}

interface Decision {
  outcome: "approve-full" | "approve-partial" | "reject";
  reason: string;
  refundAmount?: number;
  decidedBy: string;
  decidedAt: string;
  recommendedAction?: string;
}

interface Appeal {
  reason: string;
  additionalEvidence?: string[];
  status: "pending" | "approved" | "rejected";
  filedAt: string;
  appellant: "buyer" | "seller";
}

interface ClaimDetailsData {
  claimId: string;
  claimNumber: string;
  orderId: string;
  claimType: string;
  status: string;
  description: string;
  claimAmount: number;
  buyerId: string;
  buyerName: string;
  sellerId: string;
  sellerName: string;
  evidence: Evidence[];
  sellerResponse?: SellerResponse;
  decision?: Decision;
  appeal?: Appeal;
  createdAt: string;
  updatedAt: string;
  timeline: Array<{
    event: string;
    description: string;
    timestamp: string;
    actor?: string;
  }>;
}

interface ClaimDetailsProps {
  claimId: string;
  userRole: "buyer" | "seller" | "admin";
  onActionRequired?: () => void;
}

import type { LucideIcon } from "lucide-react";

type BadgeVariant = NonNullable<BadgeProps["variant"]>;

const STATUS_CONFIG: Record<
  string,
  { label: string; variant: BadgeVariant; icon: LucideIcon }
> = {
  filed: { label: "تم التقديم (Filed)", variant: "default", icon: FileText },
  "seller-notified": {
    label: "تم إشعار البائع (Seller Notified)",
    variant: "secondary",
    icon: MessageSquare,
  },
  "under-investigation": {
    label: "قيد التحقيق (Under Investigation)",
    variant: "secondary",
    icon: Clock,
  },
  "pending-seller-response": {
    label: "بانتظار رد البائع (Awaiting Seller)",
    variant: "secondary",
    icon: Clock,
  },
  "seller-responded": {
    label: "رد البائع (Seller Responded)",
    variant: "default",
    icon: MessageSquare,
  },
  "pending-decision": {
    label: "بانتظار القرار (Pending Decision)",
    variant: "secondary",
    icon: Clock,
  },
  approved: {
    label: "تمت الموافقة (Approved)",
    variant: "default",
    icon: CheckCircle2,
  },
  "partially-approved": {
    label: "موافقة جزئية (Partially Approved)",
    variant: "default",
    icon: CheckCircle2,
  },
  rejected: {
    label: "مرفوض (Rejected)",
    variant: "destructive",
    icon: XCircle,
  },
  "under-appeal": {
    label: "قيد الاستئناف (Under Appeal)",
    variant: "secondary",
    icon: AlertCircle,
  },
  closed: { label: "مغلق (Closed)", variant: "outline", icon: CheckCircle2 },
  // Backend statuses
  pending_review: {
    label: "بانتظار المراجعة (Pending Review)",
    variant: "secondary",
    icon: Clock,
  },
  pending_seller_response: {
    label: "بانتظار رد البائع (Awaiting Seller)",
    variant: "secondary",
    icon: Clock,
  },
  under_review: {
    label: "قيد المراجعة (Under Review)",
    variant: "secondary",
    icon: Clock,
  },
  pending_investigation: {
    label: "قيد التحقيق (Pending Investigation)",
    variant: "secondary",
    icon: Clock,
  },
  pending_evidence: {
    label: "بانتظار الأدلة (Pending Evidence)",
    variant: "secondary",
    icon: Clock,
  },
  resolved_refund_full: {
    label: "استرجاع كامل (Refund Full)",
    variant: "default",
    icon: CheckCircle2,
  },
  resolved_refund_partial: {
    label: "استرجاع جزئي (Refund Partial)",
    variant: "default",
    icon: CheckCircle2,
  },
  resolved_replacement: {
    label: "استبدال (Replacement)",
    variant: "default",
    icon: Package,
  },
  under_appeal: {
    label: "قيد الاستئناف (Under Appeal)",
    variant: "secondary",
    icon: AlertCircle,
  },
  escalated: {
    label: "تصعيد (Escalated)",
    variant: "secondary",
    icon: AlertCircle,
  },
  withdrawn: {
    label: "تم السحب (Withdrawn)",
    variant: "outline",
    icon: XCircle,
  },
};

const CLAIM_TYPE_LABELS: Record<string, string> = {
  "item-not-received": "لم أستلم السلعة (Item Not Received)",
  defective: "السلعة معيبة (Defective Item)",
  "not-as-described": "لا تطابق الوصف (Not as Described)",
  "wrong-item": "سلعة خاطئة (Wrong Item Sent)",
  "missing-parts": "أجزاء ناقصة (Missing Parts)",
  counterfeit: "سلعة مزيفة (Counterfeit Item)",
};

export default function ClaimDetails({
  claimId,
  userRole,
  onActionRequired,
}: ClaimDetailsProps) {
  const [claim, setClaim] = useState<ClaimDetailsData | null>(null);
  const [loading, setLoading] = useState(true);
  const [selectedMedia, setSelectedMedia] = useState<Evidence | null>(null);
  const [activeTab, setActiveTab] = useState("overview");

  // Fetch claim details
  useEffect(() => {
    fetchClaimDetails();
  }, [claimId]);

  const fetchClaimDetails = async () => {
    setLoading(true);
    try {
      const response = await fetch(`/api/souq/claims/${claimId}`);
      if (response.ok) {
        const data = await response.json();
        // Unwrap response - API returns { claim } or { claim: {...} }
        setClaim(data.claim || data);
      }
    } catch (error) {
      logger.error("Failed to fetch claim", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <Card className="w-full">
        <CardContent className="pt-6">
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <Clock className="w-8 h-8 animate-spin mx-auto mb-2" />
              <p className="text-sm text-muted-foreground">
                جاري التحميل... (Loading...)
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (!claim) {
    return (
      <Card className="w-full">
        <CardContent className="pt-6">
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <XCircle className="w-8 h-8 text-destructive mx-auto mb-2" />
              <p className="text-sm">المطالبة غير موجودة (Claim not found)</p>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  const statusConfig = STATUS_CONFIG[claim.status] || STATUS_CONFIG.filed;
  const StatusIcon = statusConfig.icon;

  return (
    <>
      <Card className="w-full">
        <CardHeader>
          <div className="flex items-start justify-between">
            <div>
              <CardTitle className="text-2xl">
                مطالبة رقم {claim.claimNumber}
              </CardTitle>
              <CardDescription>
                Claim #{claim.claimNumber} • Order #{claim.orderId}
              </CardDescription>
            </div>
            <Badge
              variant={statusConfig.variant}
              className="flex items-center gap-1"
            >
              <StatusIcon className="w-4 h-4" />
              {statusConfig.label}
            </Badge>
          </div>
        </CardHeader>

        <CardContent>
          <Tabs
            value={activeTab}
            onValueChange={setActiveTab}
            className="w-full"
          >
            <TabsList className="grid w-full grid-cols-4">
              <TabsTrigger value="overview">نظرة عامة</TabsTrigger>
              <TabsTrigger value="evidence">
                الأدلة ({claim.evidence.length})
              </TabsTrigger>
              <TabsTrigger value="timeline">الجدول الزمني</TabsTrigger>
              <TabsTrigger value="communication">التواصل</TabsTrigger>
            </TabsList>

            {/* Overview Tab */}
            <TabsContent value="overview" className="space-y-6 mt-6">
              {/* Claim Information */}
              <div className="space-y-4">
                <h3 className="font-semibold">
                  تفاصيل المطالبة (Claim Details)
                </h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-muted-foreground">
                      نوع المشكلة (Type)
                    </p>
                    <p className="text-sm font-medium">
                      {CLAIM_TYPE_LABELS[claim.claimType]}
                    </p>
                  </div>
                  <div>
                    <p className="text-sm text-muted-foreground">
                      المبلغ (Amount)
                    </p>
                    <p className="text-sm font-medium">
                      {claim.claimAmount} SAR
                    </p>
                  </div>
                  <div>
                    <p className="text-sm text-muted-foreground">
                      تاريخ التقديم (Filed Date)
                    </p>
                    <p className="text-sm font-medium">
                      {new Date(claim.createdAt).toLocaleDateString("ar-SA", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </p>
                  </div>
                  <div>
                    <p className="text-sm text-muted-foreground">
                      آخر تحديث (Last Updated)
                    </p>
                    <p className="text-sm font-medium">
                      {new Date(claim.updatedAt).toLocaleDateString("ar-SA", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </p>
                  </div>
                </div>

                <Separator />

                {/* Description */}
                <div>
                  <h4 className="text-sm font-semibold mb-2">
                    وصف المشكلة (Problem Description)
                  </h4>
                  <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                    {claim.description}
                  </p>
                </div>

                <Separator />

                {/* Parties */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <h4 className="text-sm font-semibold mb-2">
                      المشتري (Buyer)
                    </h4>
                    <p className="text-sm">{claim.buyerName}</p>
                    <p className="text-xs text-muted-foreground">
                      {claim.buyerId}
                    </p>
                  </div>
                  <div>
                    <h4 className="text-sm font-semibold mb-2">
                      البائع (Seller)
                    </h4>
                    <p className="text-sm">{claim.sellerName}</p>
                    <p className="text-xs text-muted-foreground">
                      {claim.sellerId}
                    </p>
                  </div>
                </div>
              </div>

              {/* Seller Response */}
              {claim.sellerResponse && (
                <>
                  <Separator />
                  <div className="space-y-3">
                    <h3 className="font-semibold">
                      رد البائع (Seller Response)
                    </h3>
                    <div className="bg-muted p-4 rounded-lg space-y-2">
                      <div className="flex justify-between items-center">
                        <span className="text-sm font-medium">
                          {claim.sellerResponse.solutionType ===
                            "full-refund" && "استرجاع كامل (Full Refund)"}
                          {claim.sellerResponse.solutionType ===
                            "partial-refund" && "استرجاع جزئي (Partial Refund)"}
                          {claim.sellerResponse.solutionType ===
                            "replacement" && "استبدال (Replacement)"}
                          {claim.sellerResponse.solutionType === "dispute" &&
                            "اعتراض (Dispute)"}
                        </span>
                        {claim.sellerResponse.partialRefundAmount && (
                          <Badge>
                            {claim.sellerResponse.partialRefundAmount} SAR
                          </Badge>
                        )}
                      </div>
                      <p className="text-sm">{claim.sellerResponse.message}</p>
                      <p className="text-xs text-muted-foreground">
                        {new Date(
                          claim.sellerResponse.respondedAt,
                        ).toLocaleDateString("ar-SA")}
                      </p>
                    </div>
                  </div>
                </>
              )}

              {/* Decision */}
              {claim.decision && (
                <>
                  <Separator />
                  <div className="space-y-3">
                    <h3 className="font-semibold">القرار (Decision)</h3>
                    <div
                      className={cn(
                        "p-4 rounded-lg space-y-2",
                        claim.decision.outcome === "approve-full" &&
                          "bg-success/10 border border-success/20",
                        claim.decision.outcome === "approve-partial" &&
                          "bg-primary/10 border border-primary/20",
                        claim.decision.outcome === "reject" &&
                          "bg-destructive/10 border border-destructive/20",
                      )}
                    >
                      <div className="flex justify-between items-center">
                        <span className="text-sm font-medium">
                          {claim.decision.outcome === "approve-full" &&
                            "موافقة كاملة (Approved - Full Refund)"}
                          {claim.decision.outcome === "approve-partial" &&
                            "موافقة جزئية (Approved - Partial Refund)"}
                          {claim.decision.outcome === "reject" &&
                            "مرفوض (Rejected)"}
                        </span>
                        {claim.decision.refundAmount && (
                          <Badge>{claim.decision.refundAmount} SAR</Badge>
                        )}
                      </div>
                      <p className="text-sm">{claim.decision.reason}</p>
                      <p className="text-xs text-muted-foreground">
                        Decided by {claim.decision.decidedBy} •{" "}
                        {new Date(claim.decision.decidedAt).toLocaleDateString(
                          "ar-SA",
                        )}
                      </p>
                    </div>
                  </div>
                </>
              )}

              {/* Appeal */}
              {claim.appeal && (
                <>
                  <Separator />
                  <div className="space-y-3">
                    <h3 className="font-semibold">الاستئناف (Appeal)</h3>
                    <div className="bg-warning/5 border border-yellow-200 p-4 rounded-lg space-y-2">
                      <div className="flex justify-between items-center">
                        <span className="text-sm font-medium">
                          استئناف من{" "}
                          {claim.appeal.appellant === "buyer"
                            ? "المشتري"
                            : "البائع"}
                        </span>
                        <Badge variant="secondary">{claim.appeal.status}</Badge>
                      </div>
                      <p className="text-sm">{claim.appeal.reason}</p>
                      <p className="text-xs text-muted-foreground">
                        {new Date(claim.appeal.filedAt).toLocaleDateString(
                          "ar-SA",
                        )}
                      </p>
                    </div>
                  </div>
                </>
              )}
            </TabsContent>

            {/* Evidence Tab */}
            <TabsContent value="evidence" className="mt-6">
              {claim.evidence.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-center">
                  <Package className="w-12 h-12 text-muted-foreground mb-2" />
                  <p className="text-sm text-muted-foreground">
                    لا توجد أدلة (No evidence uploaded)
                  </p>
                </div>
              ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {claim.evidence.map((evidence, index) => (
                    <button
                      key={index}
                      onClick={() => setSelectedMedia(evidence)}
                      className="relative group aspect-square rounded-lg overflow-hidden border hover:border-primary transition-colors"
                    >
                      {evidence.type === "photo" ? (
                        <img
                          src={evidence.url}
                          alt={`Evidence ${index + 1}`}
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center bg-muted">
                          {evidence.type === "video" ? (
                            <Video className="w-12 h-12 text-muted-foreground" />
                          ) : (
                            <FileText className="w-12 h-12 text-muted-foreground" />
                          )}
                        </div>
                      )}
                      <div className="absolute bottom-0 start-0 end-0 bg-black/60 text-white text-xs p-2">
                        <p>
                          {evidence.uploadedBy === "buyer" && "المشتري"}
                          {evidence.uploadedBy === "seller" && "البائع"}
                          {evidence.uploadedBy === "admin" && "الإدارة"}
                        </p>
                        <p className="text-xs opacity-75">
                          {new Date(evidence.uploadedAt).toLocaleDateString(
                            "ar-SA",
                          )}
                        </p>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </TabsContent>

            {/* Timeline Tab */}
            <TabsContent value="timeline" className="mt-6">
              <div className="space-y-4">
                {claim.timeline.map((event, index) => (
                  <div key={index} className="flex gap-4">
                    <div className="flex flex-col items-center">
                      <div className="w-3 h-3 rounded-full bg-primary" />
                      {index < claim.timeline.length - 1 && (
                        <div className="w-px h-full bg-border my-1" />
                      )}
                    </div>
                    <div className="flex-1 pb-4">
                      <p className="text-sm font-medium">{event.event}</p>
                      <p className="text-sm text-muted-foreground">
                        {event.description}
                      </p>
                      <div className="flex items-center gap-2 mt-1">
                        <p className="text-xs text-muted-foreground">
                          {new Date(event.timestamp).toLocaleString("ar-SA")}
                        </p>
                        {event.actor && (
                          <>
                            <span className="text-xs text-muted-foreground">
                              •
                            </span>
                            <p className="text-xs text-muted-foreground">
                              {event.actor}
                            </p>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>

            {/* Communication Tab */}
            <TabsContent value="communication" className="mt-6">
              <div className="flex flex-col items-center justify-center h-64 text-center">
                <MessageSquare className="w-12 h-12 text-muted-foreground mb-2" />
                <p className="text-sm text-muted-foreground">
                  نظام المراسلات قيد التطوير
                  <br />
                  Communication system coming soon
                </p>
              </div>
            </TabsContent>
          </Tabs>

          {/* Action Buttons */}
          {onActionRequired && (
            <div className="mt-6 flex justify-end gap-2">
              {userRole === "seller" &&
                claim.status === "pending-seller-response" && (
                  <Button onClick={onActionRequired}>
                    تقديم رد (Submit Response)
                  </Button>
                )}
              {userRole === "buyer" && claim.decision && !claim.appeal && (
                <Button onClick={onActionRequired} variant="outline">
                  تقديم استئناف (File Appeal)
                </Button>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Media Viewer Dialog */}
      {selectedMedia && (
        <Dialog
          open={!!selectedMedia}
          onOpenChange={() => setSelectedMedia(null)}
        >
          <DialogContent className="max-w-4xl">
            <DialogHeader>
              <DialogTitle>عرض الدليل (View Evidence)</DialogTitle>
              <DialogDescription>
                رفعه {selectedMedia.uploadedBy} في{" "}
                {new Date(selectedMedia.uploadedAt).toLocaleDateString("ar-SA")}
              </DialogDescription>
            </DialogHeader>
            <div className="w-full">
              {selectedMedia.type === "photo" && (
                <img
                  src={selectedMedia.url}
                  alt="Evidence"
                  className="w-full h-auto rounded-lg"
                />
              )}
              {selectedMedia.type === "video" && (
                <video
                  src={selectedMedia.url}
                  controls
                  className="w-full rounded-lg"
                />
              )}
              {selectedMedia.type === "document" && (
                <iframe
                  src={selectedMedia.url}
                  className="w-full h-96 rounded-lg"
                />
              )}
            </div>
          </DialogContent>
        </Dialog>
      )}
    </>
  );
}

]]>
</file>

<file path="components/souq/claims/ClaimForm.tsx">
<![CDATA[
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectItem } from "@/components/ui/select";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Upload, X, FileText, Image as ImageIcon, Video } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface ClaimFormProps {
  orderId: string;
  orderDetails: {
    itemName: string;
    orderAmount: number;
    orderDate: string;
    sellerId: string;
    sellerName: string;
    productId: string; // Added: Required for API payload
  };
  onSuccess?: (_claimId: string) => void;
  onCancel?: () => void;
}

interface EvidenceFile {
  file: File;
  preview?: string;
  type: "photo" | "video" | "document";
}

const CLAIM_TYPES = [
  {
    value: "item_not_received",
    label: "لم أستلم السلعة (Item Not Received)",
    reason: "Item never arrived",
  },
  {
    value: "defective_item",
    label: "السلعة معيبة (Defective Item)",
    reason: "Item is damaged or defective",
  },
  {
    value: "not_as_described",
    label: "لا تطابق الوصف (Not as Described)",
    reason: "Item does not match listing description",
  },
  {
    value: "wrong_item",
    label: "سلعة خاطئة (Wrong Item Sent)",
    reason: "Received incorrect product",
  },
  {
    value: "missing_parts",
    label: "أجزاء ناقصة (Missing Parts)",
    reason: "Item is incomplete or missing components",
  },
  {
    value: "counterfeit",
    label: "سلعة مزيفة (Counterfeit Item)",
    reason: "Suspected counterfeit or fake product",
  },
];

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const MAX_FILES = 10;

export default function ClaimForm({
  orderId,
  orderDetails,
  onSuccess,
  onCancel,
}: ClaimFormProps) {
  const { toast } = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [claimType, setClaimType] = useState("");
  const [description, setDescription] = useState("");
  const [evidenceFiles, setEvidenceFiles] = useState<EvidenceFile[]>([]);
  const [error, setError] = useState("");

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || []);

    if (evidenceFiles.length + files.length > MAX_FILES) {
      setError(
        `يمكنك رفع ${MAX_FILES} ملفات كحد أقصى (Maximum ${MAX_FILES} files)`,
      );
      return;
    }

    const validFiles: EvidenceFile[] = [];
    const errors: string[] = [];

    files.forEach((file) => {
      if (file.size > MAX_FILE_SIZE) {
        errors.push(`${file.name} يتجاوز 10MB`);
        return;
      }

      let fileType: "photo" | "video" | "document" = "document";
      if (file.type.startsWith("image/")) {
        fileType = "photo";
      } else if (file.type.startsWith("video/")) {
        fileType = "video";
      }

      const evidenceFile: EvidenceFile = { file, type: fileType };

      // Generate preview for images
      if (fileType === "photo") {
        const reader = new FileReader();
        reader.onload = (e) => {
          evidenceFile.preview = e.target?.result as string;
          setEvidenceFiles((prev) => [...prev]);
        };
        reader.readAsDataURL(file);
      }

      validFiles.push(evidenceFile);
    });

    if (errors.length > 0) {
      setError(errors.join(", "));
    } else {
      setError("");
    }

    setEvidenceFiles((prev) => [...prev, ...validFiles]);
  };

  const removeFile = (index: number) => {
    setEvidenceFiles((prev) => prev.filter((_, i) => i !== index));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");

    if (!claimType) {
      setError("الرجاء اختيار نوع المشكلة (Please select claim type)");
      return;
    }

    if (description.trim().length < 20) {
      setError(
        "الرجاء تقديم وصف تفصيلي (20 حرف على الأقل) - Please provide detailed description (minimum 20 characters)",
      );
      return;
    }

    if (evidenceFiles.length === 0) {
      setError(
        "الرجاء رفع دليل واحد على الأقل (Please upload at least one evidence file)",
      );
      return;
    }

    setIsSubmitting(true);

    try {
      // Upload evidence files first
      const evidenceUrls: Array<{
        url: string;
        type: string;
        uploadedBy: string;
      }> = [];

      for (const evidenceFile of evidenceFiles) {
        const formData = new FormData();
        formData.append("file", evidenceFile.file);

        // Upload to your file storage service
        const uploadResponse = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        if (!uploadResponse.ok) {
          throw new Error("فشل رفع الملفات (File upload failed)");
        }

        const uploadData = await uploadResponse.json();
        evidenceUrls.push({
          url: uploadData.url,
          type: evidenceFile.type,
          uploadedBy: "buyer",
        });
      }

      // Create claim with all required fields matching API contract
      const selectedClaimType = CLAIM_TYPES.find((t) => t.value === claimType);
      if (!selectedClaimType) {
        throw new Error("Invalid claim type selected");
      }

      const response = await fetch("/api/souq/claims", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderId,
          sellerId: orderDetails.sellerId,
          productId: orderDetails.productId,
          type: selectedClaimType.value,
          reason: selectedClaimType.reason, // Auto-fill reason based on type
          description,
          evidence: evidenceUrls,
          orderAmount: orderDetails.orderAmount, // Required number field
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(
          errorData.error || "فشل تقديم المطالبة (Failed to submit claim)",
        );
      }

      const data = await response.json();

      toast({
        title: "تم تقديم المطالبة بنجاح",
        description: `رقم المطالبة: ${data.claimNumber}`,
      });

      if (onSuccess) {
        onSuccess(data.claimId);
      }
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : "Unknown error";
      setError(errorMessage);
      toast({
        variant: "destructive",
        title: "خطأ (Error)",
        description: errorMessage,
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const getFileIcon = (type: string) => {
    switch (type) {
      case "photo":
        return <ImageIcon className="w-4 h-4" />;
      case "video":
        return <Video className="w-4 h-4" />;
      default:
        return <FileText className="w-4 h-4" />;
    }
  };

  return (
    <Card className="w-full max-w-3xl mx-auto">
      <CardHeader>
        <CardTitle>تقديم مطالبة حماية من الألف إلى الياء</CardTitle>
        <CardDescription>
          A-to-Z Guarantee Claim - نموذج تقديم مطالبة
        </CardDescription>
      </CardHeader>

      <form onSubmit={handleSubmit}>
        <CardContent className="space-y-6">
          {/* Order Details Summary */}
          <div className="bg-muted p-4 rounded-lg space-y-2">
            <div className="flex justify-between">
              <span className="text-sm font-medium">السلعة (Item):</span>
              <span className="text-sm">{orderDetails.itemName}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm font-medium">المبلغ (Amount):</span>
              <span className="text-sm">{orderDetails.orderAmount} SAR</span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm font-medium">
                تاريخ الطلب (Order Date):
              </span>
              <span className="text-sm">
                {new Date(orderDetails.orderDate).toLocaleDateString("ar-SA")}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm font-medium">البائع (Seller):</span>
              <span className="text-sm">{orderDetails.sellerName}</span>
            </div>
          </div>

          {/* Claim Type */}
          <div className="space-y-2">
            <Label htmlFor="claimType">نوع المشكلة (Problem Type) *</Label>
            <Select
              id="claimType"
              value={claimType}
              onValueChange={setClaimType}
              placeholder="اختر نوع المشكلة (Select problem type)"
            >
              {CLAIM_TYPES.map((type) => (
                <SelectItem key={type.value} value={type.value}>
                  {type.label}
                </SelectItem>
              ))}
            </Select>
          </div>

          {/* Description */}
          <div className="space-y-2">
            <Label htmlFor="description">
              وصف المشكلة التفصيلي (Detailed Description) *
            </Label>
            <Textarea
              id="description"
              placeholder="الرجاء وصف المشكلة بالتفصيل... (Please describe the problem in detail...)"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows={6}
              className="resize-none"
            />
            <p className="text-xs text-muted-foreground">
              {description.length}/500 - الحد الأدنى 20 حرف (Minimum 20
              characters)
            </p>
          </div>

          {/* Evidence Upload */}
          <div className="space-y-2">
            <Label>الأدلة الداعمة (Supporting Evidence) *</Label>
            <div className="border-2 border-dashed rounded-lg p-6 text-center">
              <input
                type="file"
                id="evidence"
                multiple
                accept="image/*,video/*,.pdf,.doc,.docx"
                onChange={handleFileUpload}
                className="hidden"
                disabled={evidenceFiles.length >= MAX_FILES}
              />
              <label
                htmlFor="evidence"
                className="cursor-pointer flex flex-col items-center gap-2"
              >
                <Upload className="w-10 h-10 text-muted-foreground" />
                <div className="text-sm">
                  <span className="font-medium text-primary">انقر للرفع</span>
                  <span className="text-muted-foreground">
                    {" "}
                    أو اسحب الملفات هنا
                  </span>
                </div>
                <p className="text-xs text-muted-foreground">
                  صور، فيديو، أو مستندات (حتى 10MB لكل ملف)
                  <br />
                  Photos, videos, or documents (up to 10MB per file)
                </p>
              </label>
            </div>

            {/* Uploaded Files */}
            {evidenceFiles.length > 0 && (
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                {evidenceFiles.map((evidence, index) => (
                  <div key={index} className="relative group">
                    <div className="border rounded-lg p-3 bg-muted">
                      {evidence.preview ? (
                        <img
                          src={evidence.preview}
                          alt={`Evidence ${index + 1}`}
                          className="w-full h-24 object-cover rounded"
                        />
                      ) : (
                        <div className="w-full h-24 flex items-center justify-center">
                          {getFileIcon(evidence.type)}
                        </div>
                      )}
                      <p className="text-xs mt-2 truncate">
                        {evidence.file.name}
                      </p>
                      <p className="text-xs text-muted-foreground">
                        {(evidence.file.size / 1024).toFixed(1)} KB
                      </p>
                    </div>
                    <Button
                      type="button"
                      variant="destructive"
                      size="icon"
                      className="absolute -top-2 -end-2 w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                      onClick={() => removeFile(index)}
                    >
                      <X className="w-4 h-4" />
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Important Information */}
          <Alert>
            <AlertDescription className="text-sm space-y-2">
              <p className="font-medium">
                معلومات هامة (Important Information):
              </p>
              <ul className="list-disc list-inside space-y-1 text-xs">
                <li>
                  سيتم إشعار البائع وسيكون لديه 48 ساعة للرد (Seller will be
                  notified and has 48 hours to respond)
                </li>
                <li>
                  سيتم مراجعة المطالبة خلال 3-5 أيام عمل (Claim will be reviewed
                  within 3-5 business days)
                </li>
                <li>
                  قد نطلب معلومات إضافية أثناء التحقيق (Additional information
                  may be requested during investigation)
                </li>
                <li>
                  سيتم إشعارك بالقرار عبر البريد الإلكتروني والإشعارات (Decision
                  will be communicated via email and notifications)
                </li>
              </ul>
            </AlertDescription>
          </Alert>

          {error && (
            <Alert variant="destructive">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
        </CardContent>

        <CardFooter className="flex justify-between">
          <Button
            type="button"
            variant="outline"
            onClick={onCancel}
            disabled={isSubmitting}
          >
            إلغاء (Cancel)
          </Button>
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? "جاري التقديم..." : "تقديم المطالبة (Submit Claim)"}
          </Button>
        </CardFooter>
      </form>
    </Card>
  );
}

]]>
</file>

<file path="components/souq/claims/ClaimList.tsx">
<![CDATA[
"use client";

import { useState, useEffect, type ComponentType } from "react";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectItem } from "@/components/ui/select";
import { useToast } from "@/hooks/use-toast";
import { logger } from "@/lib/logger";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  AlertCircle,
  CheckCircle2,
  Clock,
  FileText,
  Filter,
  MessageSquare,
  Package,
  Search,
  XCircle,
} from "lucide-react";
interface Claim {
  claimId: string;
  claimNumber: string;
  orderId: string;
  claimType: string;
  status: string;
  claimAmount?: number;
  requestedAmount?: number;
  type?: string;
  buyerName?: string;
  sellerName?: string;
  createdAt: string;
  updatedAt: string;
}

interface ClaimListProps {
  view: "buyer" | "seller" | "admin";
  onSelectClaim?: (_claimId: string) => void;
}

const STATUS_CONFIG: Record<
  string,
  {
    label: string;
    variant: "default" | "secondary" | "destructive" | "outline";
    icon: ComponentType<{ className?: string }>;
  }
> = {
  // Legacy UI keys
  filed: { label: "تم التقديم", variant: "default", icon: FileText },
  "seller-notified": {
    label: "تم إشعار البائع",
    variant: "secondary",
    icon: MessageSquare,
  },
  "under-investigation": {
    label: "قيد التحقيق",
    variant: "secondary",
    icon: Clock,
  },
  "pending-seller-response": {
    label: "بانتظار رد البائع",
    variant: "secondary",
    icon: Clock,
  },
  "seller-responded": {
    label: "رد البائع",
    variant: "default",
    icon: MessageSquare,
  },
  "pending-decision": {
    label: "بانتظار القرار",
    variant: "secondary",
    icon: Clock,
  },
  approved: { label: "تمت الموافقة", variant: "default", icon: CheckCircle2 },
  "partially-approved": {
    label: "موافقة جزئية",
    variant: "default",
    icon: CheckCircle2,
  },
  rejected: { label: "مرفوض", variant: "destructive", icon: XCircle },
  "under-appeal": {
    label: "قيد الاستئناف",
    variant: "secondary",
    icon: AlertCircle,
  },
  closed: { label: "مغلق", variant: "outline", icon: CheckCircle2 },
  // Backend statuses
  pending_review: {
    label: "بانتظار المراجعة",
    variant: "secondary",
    icon: Clock,
  },
  under_review: { label: "قيد المراجعة", variant: "secondary", icon: Clock },
  pending_investigation: {
    label: "قيد التحقيق",
    variant: "secondary",
    icon: Clock,
  },
  pending_evidence: {
    label: "بانتظار الأدلة",
    variant: "secondary",
    icon: Clock,
  },
  approved_backend: {
    label: "تمت الموافقة",
    variant: "default",
    icon: CheckCircle2,
  },
  resolved_refund_full: {
    label: "استرجاع كامل",
    variant: "default",
    icon: CheckCircle2,
  },
  resolved_refund_partial: {
    label: "استرجاع جزئي",
    variant: "default",
    icon: CheckCircle2,
  },
  resolved_replacement: { label: "استبدال", variant: "default", icon: Package },
  escalated: { label: "تصعيد", variant: "secondary", icon: AlertCircle },
  under_appeal: {
    label: "قيد الاستئناف",
    variant: "secondary",
    icon: AlertCircle,
  },
  withdrawn: { label: "تم السحب", variant: "outline", icon: XCircle },
};

const STATUS_FILTER_OPTIONS = [
  { value: "all", label: "جميع الحالات (All)" },
  { value: "pending_review", label: "بانتظار المراجعة" },
  { value: "pending_seller_response", label: "بانتظار رد البائع" },
  { value: "under_review", label: "قيد المراجعة" },
  { value: "pending_investigation", label: "قيد التحقيق" },
  { value: "resolved_refund_full", label: "استرجاع كامل" },
  { value: "resolved_refund_partial", label: "استرجاع جزئي" },
  { value: "resolved_replacement", label: "استبدال" },
  { value: "rejected", label: "مرفوض" },
  { value: "approved", label: "تمت الموافقة" },
  { value: "closed", label: "مغلق" },
  { value: "under_appeal", label: "قيد الاستئناف" },
  { value: "escalated", label: "تصعيد" },
  { value: "withdrawn", label: "تم السحب" },
];

const CLAIM_TYPE_OPTIONS = [
  { value: "item_not_received", label: "لم أستلم السلعة (Item Not Received)" },
  { value: "defective_item", label: "السلعة معيبة (Defective Item)" },
  { value: "not_as_described", label: "لا تطابق الوصف (Not as Described)" },
  { value: "wrong_item", label: "سلعة خاطئة (Wrong Item Sent)" },
  { value: "missing_parts", label: "أجزاء ناقصة (Missing Parts)" },
  { value: "counterfeit", label: "سلعة مزيفة (Counterfeit Item)" },
];

const CLAIM_TYPE_LABELS = CLAIM_TYPE_OPTIONS.reduce<Record<string, string>>(
  (acc, option) => {
    acc[option.value] = option.label;
    return acc;
  },
  {},
);

const TYPE_FILTER_OPTIONS = [
  { value: "all", label: "جميع الأنواع (All)" },
  ...CLAIM_TYPE_OPTIONS,
];

export default function ClaimList({ view, onSelectClaim }: ClaimListProps) {
  const [claims, setClaims] = useState<Claim[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [typeFilter, setTypeFilter] = useState<string>("all");
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const pageSize = 10;
  const { toast } = useToast();

  useEffect(() => {
    fetchClaims();
  }, [view, currentPage, statusFilter, typeFilter, searchQuery]);

  const fetchClaims = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        view: view, // Add view parameter for buyer/seller/admin context
        page: currentPage.toString(),
        limit: pageSize.toString(),
      });

      if (statusFilter !== "all") {
        params.append("status", statusFilter);
      }
      if (typeFilter !== "all") {
        params.append("type", typeFilter); // Changed from 'claimType' to 'type' to match API
      }
      if (searchQuery) {
        params.append("search", searchQuery);
      }

      const response = await fetch(`/api/souq/claims?${params.toString()}`);
      if (response.ok) {
        const data = await response.json();
        setClaims(Array.isArray(data.claims) ? data.claims : []);

        const totalPagesFromApi =
          data?.pagination?.totalPages ??
          data?.pagination?.pages ??
          data?.totalPages;
        const parsedTotalPages =
          typeof totalPagesFromApi === "number" &&
          Number.isFinite(totalPagesFromApi)
            ? totalPagesFromApi
            : 1;

        setTotalPages(parsedTotalPages > 0 ? parsedTotalPages : 1);
      } else {
        // Show user-friendly error message
        const payload = await response.json().catch(() => ({}));
        toast({
          title: "فشل في تحميل المطالبات (Failed to load claims)",
          description:
            payload?.error ||
            "حدث خطأ أثناء تحميل المطالبات. يرجى المحاولة مرة أخرى. (An error occurred while loading claims. Please try again.)",
          variant: "destructive",
        });
      }
    } catch (error) {
      logger.error("Failed to fetch claims", error, {
        component: "ClaimList",
        action: "fetchClaims",
      });
      // Show user-friendly error notification
      toast({
        title: "خطأ في الاتصال (Connection Error)",
        description:
          "تعذر الاتصال بالخادم. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى. (Unable to connect to server. Please check your internet connection and try again.)",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const getStatusBadge = (status: string) => {
    const config =
      STATUS_CONFIG[status] ||
      STATUS_CONFIG["pending_review"] ||
      STATUS_CONFIG.filed;
    const Icon = config.icon;
    return (
      <Badge variant={config.variant} className="flex items-center gap-1 w-fit">
        <Icon className="w-3 h-3" />
        {config.label}
      </Badge>
    );
  };

  const getTitle = () => {
    if (view === "buyer") return "مطالباتي (My Claims)";
    if (view === "seller") return "المطالبات المقدمة ضدي (Claims Against Me)";
    return "جميع المطالبات (All Claims)";
  };

  const getClaimAmount = (claim: Claim) => {
    const amount = claim.claimAmount ?? claim.requestedAmount ?? 0;
    return Number.isFinite(amount) ? amount : 0;
  };

  const getClaimTypeLabel = (claim: Claim) =>
    CLAIM_TYPE_LABELS[claim.claimType] ??
    CLAIM_TYPE_LABELS[claim.type || ""] ??
    claim.claimType;

  const getClaimDisplayId = (claim: Claim) =>
    claim.claimNumber || claim.claimId;

  const getDescription = () => {
    if (view === "buyer")
      return "عرض وإدارة جميع مطالبات حماية المشتري الخاصة بك";
    if (view === "seller") return "عرض والرد على المطالبات المقدمة ضد منتجاتك";
    return "إدارة جميع مطالبات A-to-Z في المنصة";
  };

  const handleSearch = (value: string) => {
    setSearchQuery(value);
    setCurrentPage(1);
  };

  const handleStatusFilter = (value: string) => {
    setStatusFilter(value);
    setCurrentPage(1);
  };

  const handleTypeFilter = (value: string) => {
    setTypeFilter(value);
    setCurrentPage(1);
  };

  return (
    <Card className="w-full">
      <CardHeader>
        <div className="flex items-start justify-between">
          <div>
            <CardTitle>{getTitle()}</CardTitle>
            <CardDescription>{getDescription()}</CardDescription>
          </div>
          {view === "buyer" && (
            <Button
              onClick={() => {
                /* Navigate to new claim form */
              }}
            >
              تقديم مطالبة جديدة
            </Button>
          )}
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        {/* Filters */}
        <div className="flex flex-col md:flex-row gap-4">
          {/* Search */}
          <div className="relative flex-1">
            <Search className="absolute start-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input
              placeholder="بحث برقم المطالبة أو الطلب... (Search by claim or order number...)"
              value={searchQuery}
              onChange={(e) => handleSearch(e.target.value)}
              className="ps-10"
            />
          </div>

          {/* Status Filter */}
          <div className="relative w-full md:w-[200px]">
            <Filter className="absolute start-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground pointer-events-none" />
            <Select
              value={statusFilter}
              onValueChange={handleStatusFilter}
              placeholder="الحالة (Status)"
              className="ps-9"
              wrapperClassName="w-full"
            >
              <SelectItem value="all">جميع الحالات (All)</SelectItem>
              {STATUS_FILTER_OPTIONS.map((opt) => (
                <SelectItem key={opt.value} value={opt.value}>
                  {opt.label}
                </SelectItem>
              ))}
            </Select>
          </div>

          {/* Type Filter */}
          <div className="relative w-full md:w-[200px]">
            <Filter className="absolute start-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground pointer-events-none" />
            <Select
              value={typeFilter}
              onValueChange={handleTypeFilter}
              placeholder="النوع (Type)"
              className="ps-9"
              wrapperClassName="w-full"
            >
              {TYPE_FILTER_OPTIONS.map((opt) => (
                <SelectItem key={opt.value} value={opt.value}>
                  {opt.label}
                </SelectItem>
              ))}
            </Select>
          </div>
        </div>

        {/* Claims Table */}
        {loading ? (
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <Clock className="w-8 h-8 animate-spin mx-auto mb-2 text-muted-foreground" />
              <p className="text-sm text-muted-foreground">
                جاري التحميل... (Loading...)
              </p>
            </div>
          </div>
        ) : claims.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64 text-center">
            <FileText className="w-12 h-12 text-muted-foreground mb-2" />
            <p className="text-sm font-medium">لا توجد مطالبات</p>
            <p className="text-sm text-muted-foreground">
              {view === "buyer"
                ? "لم تقدم أي مطالبات بعد (You haven't filed any claims yet)"
                : "لا توجد مطالبات مقدمة ضدك (No claims filed against you)"}
            </p>
          </div>
        ) : (
          <>
            {/* Desktop Table View */}
            <div className="hidden md:block border rounded-lg">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>رقم المطالبة</TableHead>
                    <TableHead>رقم الطلب</TableHead>
                    <TableHead>النوع</TableHead>
                    <TableHead>الحالة</TableHead>
                    {view === "buyer" && <TableHead>البائع</TableHead>}
                    {view === "seller" && <TableHead>المشتري</TableHead>}
                    {view === "admin" && (
                      <>
                        <TableHead>المشتري</TableHead>
                        <TableHead>البائع</TableHead>
                      </>
                    )}
                    <TableHead>المبلغ</TableHead>
                    <TableHead>التاريخ</TableHead>
                    <TableHead></TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {claims.map((claim) => (
                    <TableRow
                      key={claim.claimId}
                      className="cursor-pointer hover:bg-muted/50"
                      onClick={() => onSelectClaim?.(claim.claimId)}
                    >
                      <TableCell className="font-medium">
                        {getClaimDisplayId(claim)}
                      </TableCell>
                      <TableCell>{claim.orderId}</TableCell>
                      <TableCell>
                        <span className="text-sm">
                          {getClaimTypeLabel(claim)}
                        </span>
                      </TableCell>
                      <TableCell>{getStatusBadge(claim.status)}</TableCell>
                      {view === "buyer" && (
                        <TableCell>{claim.sellerName}</TableCell>
                      )}
                      {view === "seller" && (
                        <TableCell>{claim.buyerName}</TableCell>
                      )}
                      {view === "admin" && (
                        <>
                          <TableCell>{claim.buyerName}</TableCell>
                          <TableCell>{claim.sellerName}</TableCell>
                        </>
                      )}
                      <TableCell className="font-medium">
                        {getClaimAmount(claim)} SAR
                      </TableCell>
                      <TableCell className="text-sm text-muted-foreground">
                        {new Date(claim.createdAt).toLocaleDateString("ar-SA")}
                      </TableCell>
                      <TableCell>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={(e) => {
                            e.stopPropagation();
                            onSelectClaim?.(claim.claimId);
                          }}
                        >
                          عرض
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>

            {/* Mobile Card View */}
            <div className="md:hidden space-y-4">
              {claims.map((claim) => (
                <Card
                  key={claim.claimId}
                  className="cursor-pointer hover:border-primary transition-colors"
                  onClick={() => onSelectClaim?.(claim.claimId)}
                >
                  <CardContent className="pt-4 space-y-3">
                    <div className="flex justify-between items-start">
                      <div>
                        <p className="font-medium">
                          #{getClaimDisplayId(claim)}
                        </p>
                        <p className="text-sm text-muted-foreground">
                          Order #{claim.orderId}
                        </p>
                      </div>
                      {getStatusBadge(claim.status)}
                    </div>
                    <div className="space-y-1">
                      <p className="text-sm">{getClaimTypeLabel(claim)}</p>
                      <p className="text-sm font-medium">
                        {getClaimAmount(claim)} SAR
                      </p>
                    </div>
                    {view === "buyer" && claim.sellerName && (
                      <p className="text-sm text-muted-foreground">
                        البائع: {claim.sellerName}
                      </p>
                    )}
                    {view === "seller" && claim.buyerName && (
                      <p className="text-sm text-muted-foreground">
                        المشتري: {claim.buyerName}
                      </p>
                    )}
                    <div className="flex justify-between items-center pt-2 border-t">
                      <p className="text-xs text-muted-foreground">
                        {new Date(claim.createdAt).toLocaleDateString("ar-SA")}
                      </p>
                      <Button variant="ghost" size="sm">
                        عرض التفاصيل
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="flex justify-between items-center pt-4 border-t">
                <p className="text-sm text-muted-foreground">
                  صفحة {currentPage} من {totalPages}
                </p>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
                    disabled={currentPage === 1}
                  >
                    السابق
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() =>
                      setCurrentPage((p) => Math.min(totalPages, p + 1))
                    }
                    disabled={currentPage === totalPages}
                  >
                    التالي
                  </Button>
                </div>
              </div>
            )}
          </>
        )}
      </CardContent>
    </Card>
  );
}

]]>
</file>

<file path="components/souq/claims/ResponseForm.tsx">
<![CDATA[
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { AlertCircle, CheckCircle2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface ResponseFormProps {
  claimId: string;
  claimDetails: {
    claimNumber: string;
    claimType: string;
    claimAmount: number;
    description: string;
  };
  onSuccess?: () => void;
  onCancel?: () => void;
}

type SolutionType =
  | "refund_full"
  | "refund_partial"
  | "replacement"
  | "dispute";

export default function ResponseForm({
  claimId,
  claimDetails,
  onSuccess,
  onCancel,
}: ResponseFormProps) {
  const { toast } = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [solutionType, setSolutionType] = useState<SolutionType>("dispute");
  const [responseText, setResponseText] = useState(""); // Changed from 'message' to match API
  const [partialRefundAmount, setPartialRefundAmount] = useState("");
  const [error, setError] = useState("");

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");

    // Validation
    if (responseText.trim().length < 20) {
      setError(
        "الرجاء تقديم رد تفصيلي (20 حرف على الأقل) - Please provide detailed response (minimum 20 characters)",
      );
      return;
    }

    if (solutionType === "refund_partial") {
      const amount = parseFloat(partialRefundAmount);
      if (isNaN(amount) || amount <= 0 || amount > claimDetails.claimAmount) {
        setError(
          `المبلغ يجب أن يكون بين 0 و ${claimDetails.claimAmount} SAR (Amount must be between 0 and ${claimDetails.claimAmount} SAR)`,
        );
        return;
      }
    }

    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/souq/claims/${claimId}/response`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          responseText, // API expects responseText, not message
          proposedSolution: solutionType, // Already in correct underscore format
          partialRefundAmount:
            solutionType === "refund_partial"
              ? parseFloat(partialRefundAmount)
              : undefined, // Convert to number
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(
          errorData.error || "فشل إرسال الرد (Failed to submit response)",
        );
      }

      toast({
        title: "تم إرسال الرد بنجاح",
        description: "تم تسجيل ردك وسيتم مراجعته",
      });

      if (onSuccess) {
        onSuccess();
      }
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : "Unknown error";
      setError(errorMessage);
      toast({
        variant: "destructive",
        title: "خطأ (Error)",
        description: errorMessage,
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Card className="w-full max-w-3xl mx-auto">
      <CardHeader>
        <CardTitle>الرد على المطالبة #{claimDetails.claimNumber}</CardTitle>
        <CardDescription>Respond to Claim - نموذج رد البائع</CardDescription>
      </CardHeader>

      <form onSubmit={handleSubmit}>
        <CardContent className="space-y-6">
          {/* Claim Summary */}
          <div className="bg-muted p-4 rounded-lg space-y-2">
            <h3 className="font-semibold text-sm">
              ملخص المطالبة (Claim Summary)
            </h3>
            <div className="space-y-1 text-sm">
              <p>
                <span className="font-medium">النوع:</span>{" "}
                {claimDetails.claimType}
              </p>
              <p>
                <span className="font-medium">المبلغ:</span>{" "}
                {claimDetails.claimAmount} SAR
              </p>
              <p className="text-muted-foreground italic">
                {claimDetails.description}
              </p>
            </div>
          </div>

          {/* Solution Type */}
          <div className="space-y-3">
            <Label>نوع الحل المقترح (Proposed Solution) *</Label>
            <RadioGroup
              value={solutionType}
              onValueChange={(value: string) =>
                setSolutionType(value as SolutionType)
              }
            >
              <div className="space-y-3">
                {/* Full Refund */}
                <div className="flex items-start space-x-2 space-x-reverse border rounded-lg p-4 hover:bg-muted/50 transition-colors">
                  <RadioGroupItem
                    value="refund_full"
                    id="refund_full"
                    className="mt-1"
                  />
                  <Label
                    htmlFor="refund_full"
                    className="flex-1 cursor-pointer"
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <CheckCircle2 className="w-4 h-4 text-success" />
                      <span className="font-medium">
                        استرجاع كامل (Full Refund)
                      </span>
                    </div>
                    <p className="text-sm text-muted-foreground">
                      الموافقة على إرجاع المبلغ بالكامل (
                      {claimDetails.claimAmount} SAR) للمشتري
                      <br />
                      Agree to refund the full amount to the buyer
                    </p>
                  </Label>
                </div>

                {/* Partial Refund */}
                <div className="flex items-start space-x-2 space-x-reverse border rounded-lg p-4 hover:bg-muted/50 transition-colors">
                  <RadioGroupItem
                    value="refund_partial"
                    id="refund_partial"
                    className="mt-1"
                  />
                  <Label
                    htmlFor="refund_partial"
                    className="flex-1 cursor-pointer"
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <CheckCircle2 className="w-4 h-4 text-primary" />
                      <span className="font-medium">
                        استرجاع جزئي (Partial Refund)
                      </span>
                    </div>
                    <p className="text-sm text-muted-foreground mb-2">
                      عرض استرجاع جزء من المبلغ
                      <br />
                      Offer to refund a partial amount
                    </p>
                    {solutionType === "refund_partial" && (
                      <div className="mt-2">
                        <Label htmlFor="partialAmount" className="text-xs">
                          المبلغ المقترح (Proposed Amount) *
                        </Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Input
                            id="partialAmount"
                            type="number"
                            step="0.01"
                            min="0"
                            max={claimDetails.claimAmount}
                            value={partialRefundAmount}
                            onChange={(e) =>
                              setPartialRefundAmount(e.target.value)
                            }
                            placeholder="0.00"
                            className="max-w-[150px]"
                          />
                          <span className="text-sm">SAR</span>
                          <span className="text-xs text-muted-foreground">
                            (الحد الأقصى: {claimDetails.claimAmount})
                          </span>
                        </div>
                      </div>
                    )}
                  </Label>
                </div>

                {/* Replacement */}
                <div className="flex items-start space-x-2 space-x-reverse border rounded-lg p-4 hover:bg-muted/50 transition-colors">
                  <RadioGroupItem
                    value="replacement"
                    id="replacement"
                    className="mt-1"
                  />
                  <Label
                    htmlFor="replacement"
                    className="flex-1 cursor-pointer"
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <CheckCircle2 className="w-4 h-4 text-secondary-foreground" />
                      <span className="font-medium">استبدال (Replacement)</span>
                    </div>
                    <p className="text-sm text-muted-foreground">
                      عرض إرسال منتج بديل للمشتري
                      <br />
                      Offer to send a replacement product to the buyer
                    </p>
                  </Label>
                </div>

                {/* Dispute */}
                <div className="flex items-start space-x-2 space-x-reverse border rounded-lg p-4 hover:bg-muted/50 transition-colors">
                  <RadioGroupItem
                    value="dispute"
                    id="dispute"
                    className="mt-1"
                  />
                  <Label htmlFor="dispute" className="flex-1 cursor-pointer">
                    <div className="flex items-center gap-2 mb-1">
                      <AlertCircle className="w-4 h-4 text-orange-600" />
                      <span className="font-medium">
                        اعتراض (Dispute Claim)
                      </span>
                    </div>
                    <p className="text-sm text-muted-foreground">
                      الاعتراض على المطالبة وتقديم دليل مضاد
                      <br />
                      Dispute the claim and provide counter-evidence
                    </p>
                  </Label>
                </div>
              </div>
            </RadioGroup>
          </div>

          {/* Response Message */}
          <div className="space-y-2">
            <Label htmlFor="message">ردك التفصيلي (Detailed Response) *</Label>
            <Textarea
              id="message"
              placeholder="اشرح موقفك بالتفصيل... (Explain your position in detail...)"
              value={responseText}
              onChange={(e) => setResponseText(e.target.value)}
              rows={8}
              className="resize-none"
            />
            <p className="text-xs text-muted-foreground">
              {responseText.length}/1000 - الحد الأدنى 20 حرف (Minimum 20
              characters)
            </p>
          </div>

          {/* Guidelines */}
          <Alert>
            <AlertDescription className="text-sm space-y-2">
              <p className="font-medium">إرشادات الرد (Response Guidelines):</p>
              <ul className="list-disc list-inside space-y-1 text-xs">
                <li>
                  كن محترماً ومهنياً في ردك (Be respectful and professional)
                </li>
                <li>
                  قدم أدلة داعمة إن وجدت (رقم التتبع، صور، إيصالات) - Provide
                  supporting evidence if available
                </li>
                <li>
                  اشرح الموقف بوضوح من وجهة نظرك (Clearly explain your
                  perspective)
                </li>
                <li>
                  الردود السريعة تساعد في حل المشكلة بشكل أسرع (Quick responses
                  help resolve issues faster)
                </li>
                <li>
                  سيتم مراجعة ردك من قبل فريق الدعم (Your response will be
                  reviewed by support team)
                </li>
              </ul>
            </AlertDescription>
          </Alert>

          {error && (
            <Alert variant="destructive">
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
        </CardContent>

        <CardFooter className="flex justify-between">
          <Button
            type="button"
            variant="outline"
            onClick={onCancel}
            disabled={isSubmitting}
          >
            إلغاء (Cancel)
          </Button>
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? "جاري الإرسال..." : "إرسال الرد (Submit Response)"}
          </Button>
        </CardFooter>
      </form>
    </Card>
  );
}

]]>
</file>

<file path="components/support/SupportOrgSwitcher.tsx">
<![CDATA[
"use client";

import React from "react";
import { useEffect, useState } from "react";
import { toast } from "sonner";
import { useSupportOrg } from "@/contexts/SupportOrgContext";
import { useTranslation } from "@/contexts/TranslationContext";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Separator } from "@/components/ui/separator";

type SearchResult = {
  orgId: string;
  name: string;
  code?: string | null;
  registrationNumber?: string | null;
  subscriptionPlan?: string | null;
};

const SWITCHER_EVENT = "support-org-switcher:open";

export default function SupportOrgSwitcher() {
  const { t } = useTranslation();
  const {
    supportOrg,
    loading,
    canImpersonate,
    selectOrgById,
    clearSupportOrg,
  } = useSupportOrg();
  const [open, setOpen] = useState(false);
  const [identifier, setIdentifier] = useState("");
  const [results, setResults] = useState<SearchResult[]>([]);
  const [searching, setSearching] = useState(false);
  useEffect(() => {
    if (typeof window === "undefined") {
      return;
    }
    const handleOpen = () => setOpen(true);
    window.addEventListener(SWITCHER_EVENT, handleOpen);
    return () => {
      window.removeEventListener(SWITCHER_EVENT, handleOpen);
    };
  }, []);

  if (!canImpersonate) {
    return null;
  }

  const runSearch = async (id: string) => {
    if (!id.trim()) {
      toast.error(
        t(
          "support.impersonation.errors.identifierRequired",
          "Enter a corporate ID or code to search",
        ),
      );
      return;
    }
    setSearching(true);
    try {
      const res = await fetch(
        `/api/support/organizations/search?identifier=${encodeURIComponent(id.trim())}`,
        { credentials: "include" },
      );
      if (!res.ok) {
        const error = await res.json().catch(() => ({}));
        toast.error(
          error?.error ||
            t("support.impersonation.errors.lookupFailed", "Lookup failed"),
        );
        setResults([]);
        return;
      }
      const data = (await res.json()) as { results?: SearchResult[] };
      if (!data.results?.length) {
        toast.error(
          t(
            "support.impersonation.errors.noResults",
            "No organization found for that ID",
          ),
        );
        setResults([]);
        return;
      }
      setResults(data.results);
    } catch (error) {
      toast.error(
        error instanceof Error
          ? error.message
          : t("support.impersonation.errors.lookupFailed", "Lookup failed"),
      );
      setResults([]);
    } finally {
      setSearching(false);
    }
  };

  const handleSearchSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    await runSearch(identifier);
  };

  const handleSelect = async (orgId: string) => {
    const ok = await selectOrgById(orgId);
    if (ok) {
      toast.success(
        t("support.impersonation.success", "Support context updated"),
      );
      setOpen(false);
      setResults([]);
      setIdentifier("");
    } else {
      toast.error(
        t(
          "support.impersonation.errors.setFailed",
          "Failed to set support organization",
        ),
      );
    }
  };

  const handleClear = async () => {
    await clearSupportOrg();
    toast.success(
      t("support.impersonation.cleared", "Support context cleared"),
    );
    setResults([]);
    setIdentifier("");
  };

  const buttonLabel = supportOrg
    ? `${t("support.impersonation.current", "Org")}: ${supportOrg.name}`
    : t("support.impersonation.select", "Select customer");

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button variant="outline" size="sm" className="whitespace-nowrap">
          {buttonLabel}
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>
            {t("support.impersonation.title", "Support organization")}
          </DialogTitle>
          <DialogDescription>
            {t(
              "support.impersonation.description",
              "Search for a customer by corporate ID or code and set the active tenant context.",
            )}
          </DialogDescription>
        </DialogHeader>
        <div className="space-y-3">
          {supportOrg ? (
            <div className="rounded-lg border p-3 text-sm">
              <div className="font-semibold">{supportOrg.name}</div>
              <div className="text-muted-foreground">
                {supportOrg.registrationNumber
                  ? `${t("support.impersonation.registration", "Corporate ID")}: ${supportOrg.registrationNumber}`
                  : t(
                      "support.impersonation.noRegistration",
                      "Corporate ID not available",
                    )}
              </div>
              <Button
                variant="ghost"
                size="sm"
                className="mt-2"
                onClick={handleClear}
              >
                {t("support.impersonation.clear", "Clear selection")}
              </Button>
            </div>
          ) : (
            <p className="text-sm text-muted-foreground">
              {t(
                "support.impersonation.noSelection",
                "No support context selected. Choose a customer to unlock tenant data.",
              )}
            </p>
          )}
          <Separator />
          <form onSubmit={handleSearchSubmit} className="space-y-2">
            <label
              htmlFor="support-org-search"
              className="text-xs font-medium uppercase tracking-wide"
            >
              {t("support.impersonation.searchLabel", "Corporate ID or code")}
            </label>
            <div className="flex gap-2">
              <Input
                id="support-org-search"
                value={identifier}
                onChange={(event) => setIdentifier(event.target.value)}
                placeholder={t(
                  "support.impersonation.placeholder",
                  "e.g. 7001234567",
                )}
                autoComplete="off"
              />
              <Button type="submit" disabled={searching}>
                {searching
                  ? t("support.impersonation.searching", "Searching…")
                  : t("support.impersonation.search", "Search")}
              </Button>
            </div>
          </form>
          {results.length > 0 && (
            <div className="space-y-2">
              <p className="text-xs uppercase tracking-wide text-muted-foreground">
                {t("support.impersonation.results", "Matches")}
              </p>
              <div className="space-y-2 max-h-60 overflow-y-auto pe-2">
                {results.map((result) => (
                  <div
                    key={result.orgId}
                    className="rounded-lg border p-3 flex items-center justify-between gap-3 text-sm"
                  >
                    <div>
                      <div className="font-medium">{result.name}</div>
                      <div className="text-muted-foreground">
                        {result.registrationNumber
                          ? `${t("support.impersonation.registration", "Corporate ID")}: ${result.registrationNumber}`
                          : t(
                              "support.impersonation.noRegistration",
                              "Corporate ID not available",
                            )}
                      </div>
                    </div>
                    <Button
                      size="sm"
                      onClick={() => handleSelect(result.orgId)}
                      disabled={loading}
                    >
                      {t("support.impersonation.useOrg", "Use org")}
                    </Button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
        <DialogFooter>
          <p className="text-xs text-muted-foreground">
            {t(
              "support.impersonation.auditNotice",
              "All support impersonation actions are logged for audit purposes.",
            )}
          </p>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

]]>
</file>

<file path="components/topbar/AppSwitcher.tsx">
<![CDATA[
"use client";

import React, { useState, useEffect } from "react";
import { useTopBar } from "@/contexts/TopBarContext";
import { APPS, type AppKey } from "@/config/topbar-modules";
import { useTranslation } from "@/contexts/TranslationContext";
import Link from "next/link";
import { ChevronDown, Building2, Store, Landmark } from "lucide-react";

const appIcons = {
  fm: Building2,
  souq: Store,
  aqar: Landmark,
};

export default function AppSwitcher() {
  const { app, setApp } = useTopBar();
  const { t, isRTL } = useTranslation();
  const [open, setOpen] = useState(false);
  const [activeIndex, setActiveIndex] = useState(0);

  const Icon = appIcons[app];
  const appList = Object.values(APPS);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (open && !target.closest(".app-switcher-container")) {
        setOpen(false);
      }
    };

    const handleKeyDown = (event: KeyboardEvent) => {
      if (!open) return;

      switch (event.key) {
        case "Escape":
          setOpen(false);
          break;
        case "ArrowDown":
          event.preventDefault();
          setActiveIndex((prev) => (prev + 1) % appList.length);
          break;
        case "ArrowUp":
          event.preventDefault();
          setActiveIndex(
            (prev) => (prev - 1 + appList.length) % appList.length,
          );
          break;
        case "Enter":
        case " ": {
          event.preventDefault();
          const selectedApp = appList[activeIndex];
          if (selectedApp) {
            setApp(selectedApp.id);
            setOpen(false);
          }
          break;
        }
        case "Home":
          event.preventDefault();
          setActiveIndex(0);
          break;
        case "End":
          event.preventDefault();
          setActiveIndex(appList.length - 1);
          break;
      }
    };

    if (open) {
      document.addEventListener("mousedown", handleClickOutside);
      document.addEventListener("keydown", handleKeyDown);
      return () => {
        document.removeEventListener("mousedown", handleClickOutside);
        document.removeEventListener("keydown", handleKeyDown);
      };
    }
  }, [open, activeIndex, appList, setApp]);

  // Get translated app name
  const getAppName = (appId: string) => {
    const appConfig = APPS[appId as AppKey];
    // FIX: Use labelKey instead of label
    return t(appConfig?.labelKey || `app.${appId}`, "Unknown App");
  };

  return (
    <div
      className={`app-switcher-container relative ${isRTL ? "text-end" : "text-start"}`}
    >
      <button
        onClick={() => setOpen(!open)}
        className={`flex items-center gap-2 px-3 py-2 rounded-md hover:bg-white/10 transition-colors ${isRTL ? "flex-row-reverse" : ""}`}
        aria-label={t("app.switchApplication", "Switch application")}
        aria-expanded={open}
        aria-haspopup="menu"
        aria-controls="app-switcher-menu"
      >
        <Icon className="w-4 h-4" />
        <span className="text-sm font-medium">{getAppName(app)}</span>
        <ChevronDown className="w-4 h-4" />
      </button>

      {open && (
        <div
          id="app-switcher-menu"
          role="menu"
          aria-label={t("app.switchApplication", "Switch Application")}
          className={`absolute ${isRTL ? "end-0" : "start-0"} top-full mt-2 w-80 max-w-[calc(100vw-2rem)] bg-popover rounded-lg shadow-2xl border border-border z-[100] animate-in slide-in-from-top-2 duration-200`}
          style={{ maxWidth: "calc(100vw - 2rem)" }}
        >
          {/* Arrow pointer */}
          <div
            className={`hidden md:block absolute -top-2 w-3 h-3 bg-popover border-l border-t border-border transform rotate-45 ${isRTL ? "end-8" : "start-8"}`}
          ></div>

          <div className="p-3 border-b border-border">
            <h3 className="text-sm font-semibold text-foreground">
              {t("app.switchApplication", "Switch Application")}
            </h3>
          </div>
          <div className="p-2 max-h-[60vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
            {appList.map((appConfig, idx) => {
              const AppIcon = appIcons[appConfig.id];
              const isActive = app === appConfig.id;
              const isFocused = idx === activeIndex;

              return (
                <Link
                  key={appConfig.id}
                  href={appConfig.routePrefix}
                  role="menuitem"
                  tabIndex={isFocused ? 0 : -1}
                  aria-current={isActive ? "page" : undefined}
                  onClick={() => {
                    setApp(appConfig.id);
                    setOpen(false);
                  }}
                  onMouseEnter={() => setActiveIndex(idx)}
                  className={`flex items-center gap-3 p-3 rounded-md hover:bg-accent hover:text-accent-foreground transition-colors ${
                    isActive ? "bg-accent/50 text-primary" : "text-foreground"
                  } ${isFocused ? "ring-2 ring-primary ring-inset" : ""} ${isRTL ? "flex-row-reverse" : ""}`}
                >
                  <AppIcon className="w-5 h-5" aria-hidden="true" />
                  <div
                    className={`flex-1 ${isRTL ? "text-end" : "text-start"}`}
                  >
                    <div className="font-medium text-sm">
                      {getAppName(appConfig.id)}
                    </div>
                    <div
                      className="text-xs text-muted-foreground"
                      aria-label={`${Array.isArray(appConfig.searchEntities) ? appConfig.searchEntities.length : 0} ${t("app.searchableEntities", "searchable entities")}`}
                    >
                      {Array.isArray(appConfig.searchEntities)
                        ? appConfig.searchEntities.length
                        : 0}{" "}
                      {t("app.searchableEntities", "modules")}
                    </div>
                  </div>
                  {isActive && (
                    <div
                      className="w-2 h-2 rounded-full bg-primary"
                      aria-label={t("app.currentApp", "Current application")}
                    ></div>
                  )}
                </Link>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}

]]>
</file>

<file path="components/topbar/CommandPalette.tsx">
<![CDATA[
"use client";

import React, { useEffect, useRef } from "react";
import { X, Search } from "lucide-react";
import Portal from "@/components/Portal";
import { useTranslation } from "@/contexts/TranslationContext";
import type { GlobalSearchResult } from "./types";
import type {
  QuickActionConfig,
  SavedSearchConfig,
} from "@/config/topbar-modules";

interface CommandPaletteProps {
  open: boolean;
  query: string;
  onQueryChange: (_value: string) => void;
  loading: boolean;
  results: GlobalSearchResult[];
  savedSearches: SavedSearchConfig[];
  quickActions: QuickActionConfig[];
  scope: "module" | "all";
  onScopeChange: (_scope: "module" | "all") => void;
  moduleLabel: string;
  placeholder: string;
  onClose: () => void;
  onResultClick: (_href: string) => void;
  onActionClick: (_href: string) => void;
  onSavedSearchSelect: (_search: SavedSearchConfig) => void;
}

export function CommandPalette({
  open,
  query,
  onQueryChange,
  loading,
  results,
  savedSearches,
  quickActions,
  scope,
  onScopeChange,
  moduleLabel,
  placeholder,
  onClose,
  onResultClick,
  onActionClick,
  onSavedSearchSelect,
}: CommandPaletteProps) {
  const { t } = useTranslation();
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (open) {
      queueMicrotask(() => inputRef.current?.focus());
    }
  }, [open]);

  if (!open) return null;

  return (
    <Portal>
      <div className="fixed inset-0 z-[250] bg-black/60 backdrop-blur-sm p-4">
        <div
          role="dialog"
          aria-modal="true"
          className="mx-auto flex max-w-3xl flex-col rounded-2xl bg-card text-card-foreground shadow-2xl border border-border h-[70vh]"
        >
          <div className="flex items-center gap-3 border-b border-border px-4 py-3">
            <Search
              className="h-4 w-4 text-muted-foreground"
              aria-hidden="true"
            />
            <input
              ref={inputRef}
              value={query}
              onChange={(event) => onQueryChange(event.target.value)}
              placeholder={placeholder}
              className="flex-1 bg-transparent text-sm focus:outline-none placeholder:text-muted-foreground/70 text-start"
            />
            <div className="flex items-center gap-2 text-xs">
              <button
                type="button"
                onClick={() => onScopeChange("module")}
                className={`rounded-full px-2 py-1 ${
                  scope === "module"
                    ? "bg-primary text-primary-foreground"
                    : "bg-muted text-muted-foreground"
                }`}
              >
                {moduleLabel}
              </button>
              <button
                type="button"
                onClick={() => onScopeChange("all")}
                className={`rounded-full px-2 py-1 ${
                  scope === "all"
                    ? "bg-primary text-primary-foreground"
                    : "bg-muted text-muted-foreground"
                }`}
              >
                {t("search.scope.all", "All")}
              </button>
            </div>
            <button
              type="button"
              onClick={onClose}
              className="rounded-full bg-muted px-2 py-1 text-xs text-muted-foreground hover:bg-muted/80"
              aria-label={t("common.close", "Close")}
            >
              <X className="h-4 w-4" />
            </button>
          </div>

          <div className="grid flex-1 grid-cols-1 gap-4 overflow-hidden p-4 md:grid-cols-[220px_1fr]">
            <div className="space-y-4 overflow-y-auto border border-border rounded-xl p-3">
              <div>
                <div className="text-xs font-semibold uppercase text-muted-foreground">
                  {t("search.saved.title", "Saved searches")}
                </div>
                <div className="mt-2 space-y-2">
                  {savedSearches.length === 0 && (
                    <p className="text-xs text-muted-foreground">
                      {t("search.saved.empty", "No saved searches")}
                    </p>
                  )}
                  {savedSearches.map((saved) => (
                    <button
                      key={saved.id}
                      type="button"
                      className="w-full rounded-lg border border-border px-3 py-2 text-start text-sm hover:bg-muted"
                      onClick={() => onSavedSearchSelect(saved)}
                    >
                      <div className="font-medium">
                        {t(saved.labelKey, saved.fallbackLabel)}
                      </div>
                      <div className="text-xs text-muted-foreground">
                        {saved.query}
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <div className="text-xs font-semibold uppercase text-muted-foreground">
                  {t("search.quickActions", "Quick actions")}
                </div>
                <div className="mt-2 space-y-2">
                  {quickActions.length === 0 && (
                    <p className="text-xs text-muted-foreground">
                      {t("search.quickActions.empty", "No actions available")}
                    </p>
                  )}
                  {quickActions.map((action) => (
                    <button
                      key={action.id}
                      type="button"
                      className="w-full rounded-lg border border-border px-3 py-2 text-start text-sm hover:bg-muted"
                      onClick={() => onActionClick(action.href)}
                    >
                      {t(action.labelKey, action.fallbackLabel)}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex flex-col overflow-hidden rounded-xl border border-border">
              <div className="flex items-center justify-between border-b border-border px-3 py-2 text-xs text-muted-foreground">
                {loading
                  ? t("search.results.loading", "Searching…")
                  : t("search.results.title", "Results")}
              </div>
              <div className="flex-1 overflow-y-auto">
                {loading && (
                  <div className="flex h-full items-center justify-center text-sm text-muted-foreground">
                    {t("search.results.loading", "Searching…")}
                  </div>
                )}
                {!loading && results.length === 0 && (
                  <div className="flex h-full items-center justify-center text-sm text-muted-foreground">
                    {query
                      ? t("search.results.empty", "No matches yet")
                      : t("search.results.hint", "Start typing to search")}
                  </div>
                )}
                {!loading && results.length > 0 && (
                  <ul className="divide-y divide-border">
                    {results.map((result) => (
                      <li key={`${result.entity}-${result.id}`}>
                        <button
                          type="button"
                          onClick={() => onResultClick(result.href)}
                          className="flex w-full flex-col gap-1 px-4 py-3 text-start hover:bg-muted"
                        >
                          <span className="text-sm font-medium text-foreground">
                            {result.title}
                          </span>
                          {result.subtitle && (
                            <span className="text-xs text-muted-foreground">
                              {result.subtitle}
                            </span>
                          )}
                          <span className="text-[11px] uppercase text-muted-foreground/80">
                            {result.entity}
                          </span>
                        </button>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </Portal>
  );
}

]]>
</file>

</batch_content>

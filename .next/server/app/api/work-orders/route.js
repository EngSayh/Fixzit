"use strict";(()=>{var e={};e.id=307,e.ids=[307],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1073:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>O,requestAsyncStorage:()=>m,routeModule:()=>w,serverHooks:()=>f,staticGenerationAsyncStorage:()=>E});var n={};r.r(n),r.d(n,{GET:()=>p,POST:()=>c});var a=r(9303),o=r(8716),i=r(670),s=r(7070),d=r(7478),u=r(5237);function l(e){return{tenantId:e.headers.get("x-tenant-id")||"",actorId:e.headers.get("x-user-id")||void 0,ip:e.ip??""}}async function p(e){let{searchParams:t}=new URL(e.url),{tenantId:r}=l(e);if(!r)return s.NextResponse.json({error:"Missing tenant"},{status:400});let n=t.get("q")||void 0,a=t.get("status")||void 0,o=await d.pb(r,n,a);return s.NextResponse.json({data:o})}async function c(e){let t=`wo:${e.headers.get("x-user-id")}:${e.headers.get("x-tenant-id")}`;if(!(0,u.h)(t,30,6e4).allowed)return s.NextResponse.json({error:"Rate limit"},{status:429});let{tenantId:r,actorId:n,ip:a}=l(e);if(!r)return s.NextResponse.json({error:"Missing tenant"},{status:400});let o=await e.json();try{let e=await d.Ue({...o,tenantId:r},n,a);return s.NextResponse.json({data:e},{status:201})}catch(e){return s.NextResponse.json({error:e.message},{status:400})}}let w=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/work-orders/route",pathname:"/api/work-orders",filename:"route",bundlePath:"app/api/work-orders/route"},resolvedPagePath:"C:\\Users\\Geekay\\OneDrive\\Documents\\GitHub\\Fixzit-1\\app\\api\\work-orders\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:E,serverHooks:f}=w,_="/api/work-orders/route";function O(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:E})}},9851:(e,t,r)=>{r.d(t,{_:()=>a});let n=require("@prisma/client"),a=global.__prisma??new n.PrismaClient;global.__prisma||(global.__prisma=a)},2:(e,t,r)=>{r.d(t,{a:()=>a});let n=new Map;function a(e,t){if(n.has(e))return n.get(e);let r=(async()=>await t())();return n.set(e,r),r}},5237:(e,t,r)=>{r.d(t,{h:()=>a});let n=new(r(138)).z({max:5e3});function a(e,t=60,r=6e4){let a=Date.now(),o=n.get(e);return!o||a>o.resetAt?(n.set(e,{count:1,resetAt:a+r}),{allowed:!0,remaining:t-1}):o.count>=t?{allowed:!1,remaining:0}:(o.count+=1,{allowed:!0,remaining:t-o.count})}},1165:(e,t,r)=>{r.d(t,{U:()=>a});var n=r(9851);async function a(e,t,r,a,o,i){await n._.auditLog.create({data:{tenantId:e,actorId:t,action:r,entity:a,payload:o,ip:i}})}},7478:(e,t,r)=>{r.d(t,{Ue:()=>f,pb:()=>O,Vx:()=>_});var n=r(8879);let a=n.KmV(["LOW","MEDIUM","HIGH","CRITICAL"]),o=n.KmV(["NEW","ASSIGNED","IN_PROGRESS","ON_HOLD","COMPLETED","CANCELLED"]),i=n.Ryn({tenantId:n.Z_8().cuid(),title:n.Z_8().min(3),description:n.Z_8().min(3),priority:a.default("MEDIUM"),propertyId:n.Z_8().cuid().optional(),requesterId:n.Z_8().cuid().optional(),slaHours:n.Rxh().int().min(1).max(720).default(72)}),s=n.Ryn({title:n.Z_8().min(3).optional(),description:n.Z_8().min(3).optional(),priority:a.optional(),status:o.optional(),assigneeId:n.Z_8().cuid().optional(),scheduledAt:n.oQ2.date().optional(),startedAt:n.oQ2.date().optional(),completedAt:n.oQ2.date().optional(),slaHours:n.Rxh().int().min(1).max(720).optional()});var d=r(9851);async function u(e){let t=await d._.workOrder.count({where:{tenantId:e.tenantId}}),r=`WO-${function(e,t=6){return String(e).padStart(t,"0")}(t+1)}`;return d._.workOrder.create({data:{...e,code:r}})}async function l(e,t){return d._.workOrder.update({where:{id:e},data:t})}async function p(e){return d._.workOrder.findUnique({where:{id:e}})}async function c(e,t,r){return d._.workOrder.findMany({where:{tenantId:e,AND:[t?{OR:[{title:{contains:t,mode:"insensitive"}},{description:{contains:t,mode:"insensitive"}}]}:{},r?{status:r}:{}]},orderBy:{createdAt:"desc"},take:200})}var w=r(1165),m=r(2);let E={NEW:["ASSIGNED","CANCELLED"],ASSIGNED:["IN_PROGRESS","ON_HOLD","CANCELLED"],IN_PROGRESS:["ON_HOLD","COMPLETED","CANCELLED"],ON_HOLD:["IN_PROGRESS","CANCELLED"],COMPLETED:[],CANCELLED:[]};async function f(e,t,r){let n=i.parse(e),a=await (0,m.a)(`wo:create:${n.tenantId}:${n.title}`,()=>u(n));return await (0,w.U)(n.tenantId,t,"wo.create",`workOrder:${a.code}`,{wo:a},r),a}async function _(e,t,r,n,a){let o=s.parse(t);if(o.status){let t=await p(e);if(!t||t.tenantId!==r)throw Error("Not found");if(!(E[t.status]||[]).includes(o.status))throw Error(`Invalid transition ${t.status} -> ${o.status}`)}let i=await l(e,o);return await (0,w.U)(r,n,"wo.update",`workOrder:${i.code}`,{patch:o},a),i}async function O(e,t,r){return c(e,t,r)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,877,138],()=>r(1073));module.exports=n})();
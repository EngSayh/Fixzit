"use strict";(()=>{var e={};e.id=308,e.ids=[308],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8967:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>v,staticGenerationAsyncStorage:()=>p});var i={};n.r(i),n.d(i,{PATCH:()=>c});var a=n(9303),r=n(8716),o=n(670),s=n(7070),u=n(3330);async function c(e,{params:t}){let{tenantId:n,actorId:i,ip:a}={tenantId:e.headers.get("x-tenant-id")||"",actorId:e.headers.get("x-user-id")||void 0,ip:e.ip??""};if(!n)return s.NextResponse.json({error:"Missing tenant"},{status:400});let r=await e.json();try{let e=await u.v_(n,t.id,r,i,a);return s.NextResponse.json({data:e})}catch(e){return s.NextResponse.json({error:e.message},{status:400})}}let d=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/finance/invoices/[id]/route",pathname:"/api/finance/invoices/[id]",filename:"route",bundlePath:"app/api/finance/invoices/[id]/route"},resolvedPagePath:"C:\\Users\\Geekay\\OneDrive\\Documents\\GitHub\\Fixzit-1\\app\\api\\finance\\invoices\\[id]\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:v}=d,m="/api/finance/invoices/[id]/route";function f(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:p})}},9851:(e,t,n)=>{n.d(t,{_:()=>a});let i=require("@prisma/client"),a=global.__prisma??new i.PrismaClient;global.__prisma||(global.__prisma=a)},3330:(e,t,n)=>{n.d(t,{Ue:()=>v,pb:()=>m,v_:()=>f});var i=n(8879);let a=i.Ryn({sku:i.Z_8().optional(),description:i.Z_8().min(1),qty:i.oQ2.number().positive(),unitPrice:i.oQ2.number().nonnegative(),vatRate:i.oQ2.number().min(0).max(100).default(15)}),r=i.Ryn({tenantId:i.Z_8().cuid(),issueDate:i.oQ2.date(),dueDate:i.oQ2.date(),customerRef:i.Z_8().optional(),currency:i.Z_8().default("SAR"),lines:i.IXX(a).min(1)}),o=i.Ryn({action:i.KmV(["POST","VOID"]).default("POST")});var s=n(9851);async function u(e){let t=await s._.invoice.count({where:{tenantId:e.tenantId}}),n=`INV-${function(e,t=6){return String(e).padStart(t,"0")}(t+1)}`,i=function(e){let t=0,n=0;for(let i of e){let e=i.qty*i.unitPrice;t+=e,n+=i.vatRate/100*e}return{sub:t,vat:n,total:t+n}}(e.lines);return s._.invoice.create({data:{tenantId:e.tenantId,number:n,issueDate:e.issueDate,dueDate:e.dueDate,currency:e.currency,total:i.total,vatAmount:i.vat,lines:{create:e.lines.map(e=>({sku:e.sku??null,description:e.description,qty:e.qty,unitPrice:e.unitPrice,vatRate:e.vatRate,total:e.qty*e.unitPrice*(1+e.vatRate/100)}))}},include:{lines:!0}})}async function c(e,t,n){return s._.invoice.findMany({where:{tenantId:e,AND:[t?{OR:[{number:{contains:t,mode:"insensitive"}},{customerRef:{contains:t,mode:"insensitive"}}]}:{},n?{status:n}:{}]},orderBy:{createdAt:"desc"},include:{lines:!0}})}async function d(e,t){return s._.invoice.update({where:{id:e},data:{status:t}})}var l=n(2),p=n(1165);async function v(e,t,n){let i=r.parse(e),a=await (0,l.a)(`inv:create:${i.tenantId}:${i.issueDate.toISOString()}:${i.dueDate.toISOString()}`,()=>u(i));return await (0,p.U)(i.tenantId,t,"invoice.create",`invoice:${a.number}`,{inv:a},n),a}async function m(e,t,n){return c(e,t,n)}async function f(e,t,n,i,a){let r=o.parse(n),s=await d(t,"POST"===r.action?"POSTED":"VOID");return await (0,p.U)(e,i,"POST"===r.action?"invoice.post":"invoice.void",`invoice:${s.number}`,{},a),s}},2:(e,t,n)=>{n.d(t,{a:()=>a});let i=new Map;function a(e,t){if(i.has(e))return i.get(e);let n=(async()=>await t())();return i.set(e,n),n}},1165:(e,t,n)=>{n.d(t,{U:()=>a});var i=n(9851);async function a(e,t,n,a,r,o){await i._.auditLog.create({data:{tenantId:e,actorId:t,action:n,entity:a,payload:r,ip:o}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),i=t.X(0,[948,877],()=>n(8967));module.exports=i})();
"use strict";(()=>{var e={};e.id=930,e.ids=[930],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3884:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>v,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var a={};n.r(a),n.d(a,{GET:()=>l,POST:()=>p});var i=n(9303),r=n(8716),o=n(670),s=n(7070),u=n(3330),c=n(5237);function d(e){return{tenantId:e.headers.get("x-tenant-id")||"",actorId:e.headers.get("x-user-id")||void 0,ip:e.ip??""}}async function l(e){let{searchParams:t}=new URL(e.url),{tenantId:n}=d(e);if(!n)return s.NextResponse.json({error:"Missing tenant"},{status:400});let a=t.get("q")||void 0,i=t.get("status")||void 0,r=await u.pb(n,a,i);return s.NextResponse.json({data:r})}async function p(e){let{tenantId:t,actorId:n,ip:a}=d(e);if(!t)return s.NextResponse.json({error:"Missing tenant"},{status:400});let i=`inv:${t}:${n}`;if(!(0,c.h)(i,20,6e4).allowed)return s.NextResponse.json({error:"Rate limit"},{status:429});let r=await e.json();try{let e=await u.Ue({...r,tenantId:t},n,a);return s.NextResponse.json({data:e},{status:201})}catch(e){return s.NextResponse.json({error:e.message},{status:400})}}let v=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/finance/invoices/route",pathname:"/api/finance/invoices",filename:"route",bundlePath:"app/api/finance/invoices/route"},resolvedPagePath:"C:\\Users\\Geekay\\OneDrive\\Documents\\GitHub\\Fixzit-1\\app\\api\\finance\\invoices\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=v,y="/api/finance/invoices/route";function w(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},9851:(e,t,n)=>{n.d(t,{_:()=>i});let a=require("@prisma/client"),i=global.__prisma??new a.PrismaClient;global.__prisma||(global.__prisma=i)},3330:(e,t,n)=>{n.d(t,{Ue:()=>v,pb:()=>m,v_:()=>f});var a=n(8879);let i=a.Ryn({sku:a.Z_8().optional(),description:a.Z_8().min(1),qty:a.oQ2.number().positive(),unitPrice:a.oQ2.number().nonnegative(),vatRate:a.oQ2.number().min(0).max(100).default(15)}),r=a.Ryn({tenantId:a.Z_8().cuid(),issueDate:a.oQ2.date(),dueDate:a.oQ2.date(),customerRef:a.Z_8().optional(),currency:a.Z_8().default("SAR"),lines:a.IXX(i).min(1)}),o=a.Ryn({action:a.KmV(["POST","VOID"]).default("POST")});var s=n(9851);async function u(e){let t=await s._.invoice.count({where:{tenantId:e.tenantId}}),n=`INV-${function(e,t=6){return String(e).padStart(t,"0")}(t+1)}`,a=function(e){let t=0,n=0;for(let a of e){let e=a.qty*a.unitPrice;t+=e,n+=a.vatRate/100*e}return{sub:t,vat:n,total:t+n}}(e.lines);return s._.invoice.create({data:{tenantId:e.tenantId,number:n,issueDate:e.issueDate,dueDate:e.dueDate,currency:e.currency,total:a.total,vatAmount:a.vat,lines:{create:e.lines.map(e=>({sku:e.sku??null,description:e.description,qty:e.qty,unitPrice:e.unitPrice,vatRate:e.vatRate,total:e.qty*e.unitPrice*(1+e.vatRate/100)}))}},include:{lines:!0}})}async function c(e,t,n){return s._.invoice.findMany({where:{tenantId:e,AND:[t?{OR:[{number:{contains:t,mode:"insensitive"}},{customerRef:{contains:t,mode:"insensitive"}}]}:{},n?{status:n}:{}]},orderBy:{createdAt:"desc"},include:{lines:!0}})}async function d(e,t){return s._.invoice.update({where:{id:e},data:{status:t}})}var l=n(2),p=n(1165);async function v(e,t,n){let a=r.parse(e),i=await (0,l.a)(`inv:create:${a.tenantId}:${a.issueDate.toISOString()}:${a.dueDate.toISOString()}`,()=>u(a));return await (0,p.U)(a.tenantId,t,"invoice.create",`invoice:${i.number}`,{inv:i},n),i}async function m(e,t,n){return c(e,t,n)}async function f(e,t,n,a,i){let r=o.parse(n),s=await d(t,"POST"===r.action?"POSTED":"VOID");return await (0,p.U)(e,a,"POST"===r.action?"invoice.post":"invoice.void",`invoice:${s.number}`,{},i),s}},2:(e,t,n)=>{n.d(t,{a:()=>i});let a=new Map;function i(e,t){if(a.has(e))return a.get(e);let n=(async()=>await t())();return a.set(e,n),n}},5237:(e,t,n)=>{n.d(t,{h:()=>i});let a=new(n(138)).z({max:5e3});function i(e,t=60,n=6e4){let i=Date.now(),r=a.get(e);return!r||i>r.resetAt?(a.set(e,{count:1,resetAt:i+n}),{allowed:!0,remaining:t-1}):r.count>=t?{allowed:!1,remaining:0}:(r.count+=1,{allowed:!0,remaining:t-r.count})}},1165:(e,t,n)=>{n.d(t,{U:()=>i});var a=n(9851);async function i(e,t,n,i,r,o){await a._.auditLog.create({data:{tenantId:e,actorId:t,action:n,entity:i,payload:r,ip:o}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[948,877,138],()=>n(3884));module.exports=a})();
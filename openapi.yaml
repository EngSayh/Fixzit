openapi: 3.0.3
info:
  title: Fixzit Aqar Real Estate API
  version: 1.0.0
  description: |-
    REST API for Aqar real estate marketplace with listings, leads, favorites, and packages
    
    ## Breaking Changes
    ### v2.0.26 - Souq Refund Methods
    - **DEPRECATED**: `store_credit` refund method removed
    - **NEW**: Use `wallet` for refunds to user's digital wallet
    - **Affected Endpoints**: `/api/souq/returns/refund`
    - **Migration**: Update API clients to use `wallet` instead of `store_credit`
    - **Timeline**: `store_credit` was removed in v2.0.26 (November 2025)

servers:
  - url: http://localhost:3000/api
    description: Development
  - url: https://fixzit.co/api
    description: Production

paths:
  /aqar/listings:
    post:
      summary: Create property listing
      tags: [Listings]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ListingCreate"
      responses:
        "201":
          description: Listing created
          content:
            application/json:
              schema:
                type: object
                properties:
                  listing:
                    $ref: "#/components/schemas/Listing"
                  correlationId:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /aqar/listings/{id}:
    get:
      summary: Get listing by ID
      tags: [Listings]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: "^[a-fA-F0-9]{24}$"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  listing:
                    $ref: "#/components/schemas/Listing"
                  correlationId:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /aqar/listings/search:
    get:
      summary: Search listings with filters
      tags: [Listings]
      parameters:
        - name: city
          in: query
          schema:
            type: string
        - name: lat
          in: query
          schema:
            type: number
            format: double
        - name: lng
          in: query
          schema:
            type: number
            format: double
        - name: radiusKm
          in: query
          schema:
            type: number
            minimum: 0.1
            maximum: 20
          description: "Capped to 20km for performance"
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: OK

  /aqar/leads:
    post:
      summary: Create lead (public, rate-limited to 10 req/min)
      tags: [Leads]
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LeadCreate"
      responses:
        "201":
          description: Created
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          description: Too Many Requests

  /aqar/favorites:
    post:
      summary: Add favorite
      tags: [Favorites]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FavoriteCreate"
      responses:
        "201":
          description: Created
        "409":
          description: Conflict (already favorited)

  /aqar/packages:
    post:
      summary: Purchase package (atomic transaction)
      tags: [Packages]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [type]
              properties:
                type:
                  type: string
                  enum: [STARTER, STANDARD, PREMIUM]
      responses:
        "201":
          description: Created
        "400":
          $ref: "#/components/responses/BadRequest"

  /souq/returns/refund:
    post:
      summary: Process refund for RMA
      description: |-
        Process a refund for a return merchandise authorization (RMA).
        
        **Breaking Change (v2.0.26)**: The `store_credit` refund method has been removed.
        Use `wallet` for refunds to user's digital wallet instead.
      tags: [Refunds]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rmaId, refundMethod, refundAmount]
              properties:
                rmaId:
                  type: string
                  description: Return merchandise authorization ID
                refundMethod:
                  type: string
                  enum: [original_payment, wallet, bank_transfer]
                  description: |-
                    Refund method:
                    - `original_payment`: Refund to original payment method
                    - `wallet`: Refund to user's digital wallet (replaces deprecated `store_credit`)
                    - `bank_transfer`: Direct bank transfer
                refundAmount:
                  type: number
                  minimum: 0.01
                  description: Refund amount in SAR
      responses:
        '200':
          description: Refund processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 'Refund processed successfully'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /copilot/knowledge:
    post:
      summary: Upsert knowledge documents for Copilot search
      tags: [Copilot]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                docs:
                  type: array
                  items:
                    type: object
                    properties:
                      slug: { type: string }
                      title: { type: string }
                      content: { type: string }
                      orgId: { type: string, nullable: true }
                      roles:
                        type: array
                        items: { type: string }
                      locale:
                        type: string
                        enum: [en, ar]
                      tags:
                        type: array
                        items: { type: string }
                      source: { type: string }
                      checksum: { type: string }
      responses:
        "200": { description: Upserted }
        "401": { description: Unauthorized }
        "429": { description: Rate limit exceeded }
        "503": { description: Webhook not configured }

  /souq/search:
    get:
      summary: Search Souq products
      tags: [Souq]
      security: []
      parameters:
        - in: query
          name: q
          schema: { type: string, maxLength: 256 }
        - in: query
          name: category
          schema: { type: string }
        - in: query
          name: subcategory
          schema: { type: string }
        - in: query
          name: brandId
          schema: { type: string }
        - in: query
          name: minPrice
          schema: { type: number }
        - in: query
          name: maxPrice
          schema: { type: number }
        - in: query
          name: minRating
          schema: { type: number, minimum: 0, maximum: 5 }
        - in: query
          name: badges
          schema: { type: string, description: "Comma-separated badges" }
        - in: query
          name: inStock
          schema: { type: boolean }
        - in: query
          name: isActive
          schema: { type: boolean, default: true }
        - in: query
          name: sort
          schema:
            type: string
            enum: [relevance, price_asc, price_desc, rating, newest]
            default: relevance
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        "200": { description: Search results }
        "400": { description: Invalid parameters }
        "403": { description: Unauthorized org context }
        "429": { description: Rate limit exceeded }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Unauthorized - Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    ServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            name:
              type: string
            code:
              oneOf:
                - type: string
                - type: integer
            userMessage:
              type: string
            devMessage:
              type: string
            correlationId:
              type: string

    ListingCreate:
      type: object
      required:
        [
          intent,
          propertyType,
          title,
          description,
          city,
          price,
          areaSqm,
          geo,
          source,
        ]
      properties:
        intent:
          type: string
          enum: [BUY, RENT, DAILY]
        propertyType:
          type: string
        title:
          type: string
        description:
          type: string
        city:
          type: string
        price:
          type: number
          minimum: 1
        areaSqm:
          type: number
          minimum: 1
        geo:
          type: object
          required: [type, coordinates]
          properties:
            type:
              type: string
              enum: [Point]
            coordinates:
              type: array
              items:
                type: number
              minItems: 2
              maxItems: 2
        source:
          type: string
          enum: [OWNER, AGENT, DEVELOPER]

    Listing:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        price:
          type: number
        areaSqm:
          type: number
        city:
          type: string
        status:
          type: string

    LeadCreate:
      type: object
      required: [inquirerName, inquirerPhone, intent, source]
      properties:
        listingId:
          type: string
        projectId:
          type: string
        inquirerName:
          type: string
        inquirerPhone:
          type: string
        intent:
          type: string
          enum: [BUY, RENT, DAILY]
        source:
          type: string

    FavoriteCreate:
      type: object
      required: [targetId, targetType]
      properties:
        targetId:
          type: string
        targetType:
          type: string
          enum: [LISTING, PROJECT]

    # ============================================
    # FM Schemas
    # ============================================

    WorkOrderCreate:
      type: object
      required: [title, propertyId, priority]
      properties:
        title:
          type: string
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        propertyId:
          type: string
          pattern: "^[a-fA-F0-9]{24}$"
        priority:
          type: string
          enum: [critical, high, medium, low]
        category:
          type: string
          enum: [hvac, plumbing, electrical, general, cleaning, security]
        scheduledDate:
          type: string
          format: date-time
        attachments:
          type: array
          items:
            type: string

    WorkOrderUpdate:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [critical, high, medium, low]
        scheduledDate:
          type: string
          format: date-time

    WorkOrder:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        description:
          type: string
        propertyId:
          type: string
        status:
          type: string
          enum: [draft, pending, in_progress, on_hold, completed, cancelled]
        priority:
          type: string
        category:
          type: string
        assigneeId:
          type: string
        scheduledDate:
          type: string
          format: date-time
        slaDeadline:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time

    WorkOrderResponse:
      type: object
      properties:
        workOrder:
          $ref: "#/components/schemas/WorkOrder"
        correlationId:
          type: string

    WorkOrderListResponse:
      type: object
      properties:
        workOrders:
          type: array
          items:
            $ref: "#/components/schemas/WorkOrder"
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        correlationId:
          type: string

    PropertyListResponse:
      type: object
      properties:
        properties:
          type: array
          items:
            type: object
            properties:
              _id:
                type: string
              name:
                type: string
              type:
                type: string
              address:
                type: string
        page:
          type: integer
        total:
          type: integer

    # ============================================
    # HR Schemas
    # ============================================

    EmployeeCreate:
      type: object
      required: [firstName, lastName, email, department, position]
      properties:
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        department:
          type: string
        position:
          type: string
        hireDate:
          type: string
          format: date
        salary:
          type: number
        employeeNumber:
          type: string

    EmployeeUpdate:
      type: object
      properties:
        firstName:
          type: string
        lastName:
          type: string
        phone:
          type: string
        department:
          type: string
        position:
          type: string
        salary:
          type: number
        status:
          type: string
          enum: [active, inactive, terminated, on_leave]

    Employee:
      type: object
      properties:
        _id:
          type: string
        employeeNumber:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
        phone:
          type: string
        department:
          type: string
        position:
          type: string
        status:
          type: string
        hireDate:
          type: string
          format: date
        createdAt:
          type: string
          format: date-time

    EmployeeListResponse:
      type: object
      properties:
        employees:
          type: array
          items:
            $ref: "#/components/schemas/Employee"
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer

    LeaveListResponse:
      type: object
      properties:
        leaves:
          type: array
          items:
            type: object
            properties:
              _id:
                type: string
              employeeId:
                type: string
              type:
                type: string
              startDate:
                type: string
                format: date
              endDate:
                type: string
                format: date
              status:
                type: string
              reason:
                type: string
        page:
          type: integer
        total:
          type: integer

    AttendanceListResponse:
      type: object
      properties:
        records:
          type: array
          items:
            type: object
            properties:
              _id:
                type: string
              employeeId:
                type: string
              date:
                type: string
                format: date
              clockIn:
                type: string
                format: date-time
              clockOut:
                type: string
                format: date-time
              hoursWorked:
                type: number
        page:
          type: integer
        total:
          type: integer

    PayrollListResponse:
      type: object
      properties:
        payrolls:
          type: array
          items:
            type: object
            properties:
              _id:
                type: string
              employeeId:
                type: string
              month:
                type: integer
              year:
                type: integer
              basicSalary:
                type: number
              allowances:
                type: number
              deductions:
                type: number
              gosiDeduction:
                type: number
              netPay:
                type: number
              status:
                type: string
                enum: [draft, approved, paid]
        page:
          type: integer
        total:
          type: integer

  # ATS Analytics Endpoint
  /ats/analytics:
    get:
      summary: Get ATS analytics and metrics
      tags: [ATS]
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          description: Start date for analytics period
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          description: End date for analytics period
        - name: orgId
          in: query
          schema:
            type: string
          description: Organization ID filter
      responses:
        "200":
          description: Analytics data retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  applications:
                    type: object
                    properties:
                      total:
                        type: integer
                      byStage:
                        type: object
                        additionalProperties:
                          type: integer
                      byStatus:
                        type: object
                        additionalProperties:
                          type: integer
                  jobs:
                    type: object
                    properties:
                      total:
                        type: integer
                      active:
                        type: integer
                      filled:
                        type: integer
                  candidates:
                    type: object
                    properties:
                      total:
                        type: integer
                      hired:
                        type: integer
                  correlationId:
                    type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # Marketplace Search Endpoint
  /marketplace/search:
    get:
      summary: Search marketplace products and vendors
      tags: [Marketplace]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query term
        - name: category
          in: query
          schema:
            type: string
          description: Filter by product category
        - name: vendor
          in: query
          schema:
            type: string
          description: Filter by vendor ID
        - name: minPrice
          in: query
          schema:
            type: number
          description: Minimum price filter
        - name: maxPrice
          in: query
          schema:
            type: number
          description: Maximum price filter
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: Items per page
      responses:
        "200":
          description: Search results retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        description:
                          type: string
                        price:
                          type: number
                        category:
                          type: string
                        vendor:
                          type: object
                          properties:
                            id:
                              type: string
                            name:
                              type: string
                  page:
                    type: integer
                  limit:
                    type: integer
                  total:
                    type: integer
                  correlationId:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"

  # PayTabs Callback Webhook
  /paytabs/callback:
    post:
      summary: PayTabs payment callback webhook
      tags: [Payments]
      description: Webhook endpoint for PayTabs payment status notifications
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tran_ref:
                  type: string
                  description: PayTabs transaction reference
                cart_id:
                  type: string
                  description: Original cart/invoice ID
                payment_result:
                  type: object
                  properties:
                    response_status:
                      type: string
                      enum: [A, H, P, V, E]
                      description: Payment status (A=Approved, H=Hold, P=Pending, V=Voided, E=Error)
                    response_code:
                      type: string
                    response_message:
                      type: string
                    transaction_time:
                      type: string
                      format: date-time
      responses:
        "200":
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  correlationId:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ============================================
  # Facility Management (FM) API
  # ============================================

  /fm/work-orders:
    get:
      summary: List work orders
      description: Retrieve work orders with filtering and pagination. Results are scoped to user's organization.
      tags: [FM - Work Orders]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, pending, in_progress, on_hold, completed, cancelled]
          description: Filter by work order status
        - name: priority
          in: query
          schema:
            type: string
            enum: [critical, high, medium, low]
          description: Filter by priority level
        - name: assigneeId
          in: query
          schema:
            type: string
          description: Filter by assigned technician ID
        - name: propertyId
          in: query
          schema:
            type: string
          description: Filter by property ID
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          description: Filter by creation date (from)
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          description: Filter by creation date (to)
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: Work orders retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkOrderListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

    post:
      summary: Create work order
      description: Create a new work order. Requires `work-orders:create` permission.
      tags: [FM - Work Orders]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkOrderCreate"
      responses:
        "201":
          description: Work order created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkOrderResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /fm/work-orders/{id}:
    get:
      summary: Get work order by ID
      tags: [FM - Work Orders]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: "^[a-fA-F0-9]{24}$"
      responses:
        "200":
          description: Work order retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkOrderResponse"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      summary: Update work order
      tags: [FM - Work Orders]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: "^[a-fA-F0-9]{24}$"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkOrderUpdate"
      responses:
        "200":
          description: Work order updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkOrderResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /fm/work-orders/{id}/assign:
    post:
      summary: Assign work order to technician
      tags: [FM - Work Orders]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [technicianId]
              properties:
                technicianId:
                  type: string
                  description: ID of technician to assign
                notes:
                  type: string
                  description: Assignment notes
      responses:
        "200":
          description: Work order assigned
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /fm/work-orders/{id}/status:
    patch:
      summary: Update work order status
      description: |
        Transition work order to a new status. Valid transitions:
        - draft → pending
        - pending → in_progress, cancelled
        - in_progress → completed, on_hold
        - on_hold → in_progress
      tags: [FM - Work Orders]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [pending, in_progress, on_hold, completed, cancelled]
                reason:
                  type: string
                  description: Reason for status change (required for cancel/hold)
      responses:
        "200":
          description: Status updated
        "400":
          description: Invalid status transition
        "404":
          $ref: "#/components/responses/NotFound"

  /fm/properties:
    get:
      summary: List properties
      tags: [FM - Properties]
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [residential, commercial, industrial, mixed]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Properties retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PropertyListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /fm/reports/summary:
    get:
      summary: Get FM summary report
      tags: [FM - Reports]
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Report generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  workOrders:
                    type: object
                    properties:
                      total:
                        type: integer
                      byStatus:
                        type: object
                      avgResolutionTime:
                        type: number
                  slaCompliance:
                    type: object
                    properties:
                      onTime:
                        type: integer
                      breached:
                        type: integer
                      percentage:
                        type: number

  # ============================================
  # Billing API
  # ============================================

  /billing/subscribe:
    post:
      summary: Create subscription
      description: Subscribe to a billing plan. Initiates payment flow.
      tags: [Billing]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [planId]
              properties:
                planId:
                  type: string
                  description: Subscription plan ID
                  example: "plan_starter_monthly"
                couponCode:
                  type: string
                  description: Optional discount coupon
                paymentMethod:
                  type: string
                  enum: [card, bank_transfer]
                  default: card
      responses:
        "200":
          description: Subscription initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscriptionId:
                    type: string
                  paymentUrl:
                    type: string
                    description: Redirect URL for payment
                  amount:
                    type: number
                  currency:
                    type: string
                    example: "SAR"
        "400":
          $ref: "#/components/responses/BadRequest"

  /billing/charge-recurring:
    post:
      summary: Process recurring charge
      description: Internal endpoint for processing recurring subscription charges.
      tags: [Billing]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [subscriptionId]
              properties:
                subscriptionId:
                  type: string
      responses:
        "200":
          description: Charge processed
        "400":
          $ref: "#/components/responses/BadRequest"
        "402":
          description: Payment failed

  /billing/quote:
    post:
      summary: Generate billing quote
      description: Generate a quote for services or products.
      tags: [Billing]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [items]
              properties:
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      productId:
                        type: string
                      quantity:
                        type: integer
                      unitPrice:
                        type: number
                customerId:
                  type: string
                validDays:
                  type: integer
                  default: 30
      responses:
        "201":
          description: Quote generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  quoteId:
                    type: string
                  subtotal:
                    type: number
                  tax:
                    type: number
                  total:
                    type: number
                  expiresAt:
                    type: string
                    format: date-time

  /billing/callback:
    post:
      summary: Payment callback webhook
      description: Webhook for payment provider callbacks.
      tags: [Billing]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Callback processed

  # ============================================
  # Human Resources (HR) API
  # ============================================

  /hr/employees:
    get:
      summary: List employees
      description: Retrieve employees in the organization.
      tags: [HR - Employees]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, terminated, on_leave]
        - name: department
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Employees retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmployeeListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      summary: Create employee
      tags: [HR - Employees]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EmployeeCreate"
      responses:
        "201":
          description: Employee created
        "400":
          $ref: "#/components/responses/BadRequest"

  /hr/employees/{id}:
    get:
      summary: Get employee by ID
      tags: [HR - Employees]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Employee retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Employee"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      summary: Update employee
      tags: [HR - Employees]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EmployeeUpdate"
      responses:
        "200":
          description: Employee updated
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /hr/leaves:
    get:
      summary: List leave requests
      tags: [HR - Leave Management]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, approved, rejected, cancelled]
        - name: employeeId
          in: query
          schema:
            type: string
        - name: type
          in: query
          schema:
            type: string
            enum: [annual, sick, unpaid, maternity, paternity, hajj]
      responses:
        "200":
          description: Leave requests retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeaveListResponse"

    post:
      summary: Submit leave request
      tags: [HR - Leave Management]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, startDate, endDate]
              properties:
                type:
                  type: string
                  enum: [annual, sick, unpaid, maternity, paternity, hajj]
                startDate:
                  type: string
                  format: date
                endDate:
                  type: string
                  format: date
                reason:
                  type: string
                attachments:
                  type: array
                  items:
                    type: string
                  description: URLs to supporting documents
      responses:
        "201":
          description: Leave request submitted
        "400":
          $ref: "#/components/responses/BadRequest"

  /hr/leaves/{id}/approve:
    post:
      summary: Approve leave request
      tags: [HR - Leave Management]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                comments:
                  type: string
      responses:
        "200":
          description: Leave approved

  /hr/leaves/{id}/reject:
    post:
      summary: Reject leave request
      tags: [HR - Leave Management]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
      responses:
        "200":
          description: Leave rejected

  /hr/attendance:
    get:
      summary: Get attendance records
      tags: [HR - Attendance]
      security:
        - bearerAuth: []
      parameters:
        - name: employeeId
          in: query
          schema:
            type: string
        - name: startDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Attendance records retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttendanceListResponse"

    post:
      summary: Record attendance (clock in/out)
      tags: [HR - Attendance]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type]
              properties:
                type:
                  type: string
                  enum: [clock_in, clock_out]
                location:
                  type: object
                  properties:
                    lat:
                      type: number
                    lng:
                      type: number
                notes:
                  type: string
      responses:
        "201":
          description: Attendance recorded

  /hr/payroll:
    get:
      summary: Get payroll records
      tags: [HR - Payroll]
      security:
        - bearerAuth: []
      parameters:
        - name: month
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
        - name: year
          in: query
          required: true
          schema:
            type: integer
        - name: employeeId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Payroll records retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PayrollListResponse"

    post:
      summary: Generate payroll
      description: Generate payroll for a specific month. Calculates GOSI, deductions, and net pay.
      tags: [HR - Payroll]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [month, year]
              properties:
                month:
                  type: integer
                  minimum: 1
                  maximum: 12
                year:
                  type: integer
                employeeIds:
                  type: array
                  items:
                    type: string
                  description: Specific employees (empty = all)
      responses:
        "201":
          description: Payroll generated
        "400":
          $ref: "#/components/responses/BadRequest"

  /hr/leave-types:
    get:
      summary: Get leave types
      tags: [HR - Leave Management]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Leave types retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  leaveTypes:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        daysPerYear:
                          type: integer
                        isPaid:
                          type: boolean
                        requiresApproval:
                          type: boolean

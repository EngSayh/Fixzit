openapi: 3.0.3
info:
  title: Fixzit Aqar Real Estate API
  version: 1.0.0
  description: REST API for Aqar real estate marketplace with listings, leads, favorites, and packages

servers:
  - url: http://localhost:3000/api
    description: Development
  - url: https://fixzit.co/api
    description: Production

paths:
  /aqar/listings:
    post:
      summary: Create property listing
      tags: [Listings]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListingCreate'
      responses:
        '201':
          description: Listing created
          content:
            application/json:
              schema:
                type: object
                properties:
                  listing:
                    $ref: '#/components/schemas/Listing'
                  correlationId:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /aqar/listings/{id}:
    get:
      summary: Get listing by ID
      tags: [Listings]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-fA-F0-9]{24}$'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  listing:
                    $ref: '#/components/schemas/Listing'
                  correlationId:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /aqar/listings/search:
    get:
      summary: Search listings with filters
      tags: [Listings]
      parameters:
        - name: city
          in: query
          schema:
            type: string
        - name: lat
          in: query
          schema:
            type: number
            format: double
        - name: lng
          in: query
          schema:
            type: number
            format: double
        - name: radiusKm
          in: query
          schema:
            type: number
            minimum: 0.1
            maximum: 20
          description: 'Capped to 20km for performance'
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: OK

  /aqar/leads:
    post:
      summary: Create lead (public, rate-limited to 10 req/min)
      tags: [Leads]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadCreate'
      responses:
        '201':
          description: Created
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          description: Too Many Requests

  /aqar/favorites:
    post:
      summary: Add favorite
      tags: [Favorites]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FavoriteCreate'
      responses:
        '201':
          description: Created
        '409':
          description: Conflict (already favorited)

  /aqar/packages:
    post:
      summary: Purchase package (atomic transaction)
      tags: [Packages]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [type]
              properties:
                type:
                  type: string
                  enum: [STARTER, STANDARD, PREMIUM]
      responses:
        '201':
          description: Created
        '400':
          $ref: '#/components/responses/BadRequest'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Forbidden
    NotFound:
      description: Not found
    ServerError:
      description: Internal Server Error

  schemas:
    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            name:
              type: string
            code:
              oneOf:
                - type: string
                - type: integer
            userMessage:
              type: string
            devMessage:
              type: string
            correlationId:
              type: string

    ListingCreate:
      type: object
      required: [intent, propertyType, title, description, city, price, areaSqm, geo, source]
      properties:
        intent:
          type: string
          enum: [BUY, RENT, DAILY]
        propertyType:
          type: string
        title:
          type: string
        description:
          type: string
        city:
          type: string
        price:
          type: number
          minimum: 1
        areaSqm:
          type: number
          minimum: 1
        geo:
          type: object
          required: [type, coordinates]
          properties:
            type:
              type: string
              enum: [Point]
            coordinates:
              type: array
              items:
                type: number
              minItems: 2
              maxItems: 2
        source:
          type: string
          enum: [OWNER, AGENT, DEVELOPER]

    Listing:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        price:
          type: number
        areaSqm:
          type: number
        city:
          type: string
        status:
          type: string

    LeadCreate:
      type: object
      required: [inquirerName, inquirerPhone, intent, source]
      properties:
        listingId:
          type: string
        projectId:
          type: string
        inquirerName:
          type: string
        inquirerPhone:
          type: string
        intent:
          type: string
          enum: [BUY, RENT, DAILY]
        source:
          type: string

    FavoriteCreate:
      type: object
      required: [targetId, targetType]
      properties:
        targetId:
          type: string
        targetType:
          type: string
          enum: [LISTING, PROJECT]

  # ========== NEW ROUTES (PR #283 - Fix OpenAPI Drift) ==========
  
  /aqar/leads:
    get:
      summary: List leads with pagination
      tags: [CRM]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
            maximum: 10000
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Paginated leads
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Lead'
                  page:
                    type: integer
                  limit:
                    type: integer
                  total:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /finance/journals:
    get:
      summary: List journal entries with pagination
      tags: [Finance]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Paginated journal entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/JournalEntry'
                  page:
                    type: integer
                  limit:
                    type: integer

  /finance/ledger:
    get:
      summary: Get general ledger with optional date range
      tags: [Finance]
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Ledger entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LedgerEntry'

  /finance/ledger/account-activity/{accountId}:
    get:
      summary: Get account activity (transactions)
      tags: [Finance]
      security:
        - bearerAuth: []
      parameters:
        - name: accountId
          in: path
          required: true
          schema:
            type: string
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Account transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  account:
                    type: string
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'

  /finance/ledger/trial-balance:
    get:
      summary: Get trial balance report
      tags: [Finance]
      security:
        - bearerAuth: []
      parameters:
        - name: asOf
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Trial balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  accounts:
                    type: array
                    items:
                      $ref: '#/components/schemas/TrialBalanceAccount'
                  totalDebits:
                    type: number
                  totalCredits:
                    type: number

  /hr/employees:
    get:
      summary: List employees with pagination
      tags: [HR]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Paginated employees
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Employee'
                  page:
                    type: integer
                  limit:
                    type: integer

  /performance/metrics:
    get:
      summary: Get performance KPIs
      tags: [Performance]
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Performance metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceMetrics'

  /support/tickets/my:
    get:
      summary: Get current user's support tickets
      tags: [Support]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: User's tickets
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SupportTicket'
                  page:
                    type: integer
                  limit:
                    type: integer

  /admin/audit-logs:
    get:
      summary: Retrieve audit logs with strict pagination limits
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Max 100, default 100
          schema:
            type: integer
            default: 100
            maximum: 100
        - name: skip
          in: query
          description: Max 10000, default 0
          schema:
            type: integer
            default: 0
            maximum: 10000
      responses:
        '200':
          description: Audit logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLog'

  /admin/users:
    get:
      summary: List users with pagination (admin only)
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Paginated users
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  page:
                    type: integer
                  limit:
                    type: integer

  /ats/jobs/{id}/apply:
    post:
      summary: Submit job application
      tags: [ATS]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobApplication'
      responses:
        '201':
          description: Application submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  applicationId:
                    type: string
                  status:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    # ========== NEW SCHEMAS (PR #283) ==========
    
    Lead:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        phone:
          type: string
        createdAt:
          type: string
          format: date-time
    
    JournalEntry:
      type: object
      properties:
        id:
          type: string
        date:
          type: string
          format: date
        description:
          type: string
        lines:
          type: array
          items:
            type: object
            properties:
              account:
                type: string
              debit:
                type: number
              credit:
                type: number

    LedgerEntry:
      type: object
      properties:
        account:
          type: string
        date:
          type: string
          format: date
        debit:
          type: number
        credit:
          type: number
        balance:
          type: number

    Transaction:
      type: object
      properties:
        id:
          type: string
        date:
          type: string
          format: date
        description:
          type: string
        amount:
          type: number
        type:
          type: string
          enum: [debit, credit]

    TrialBalanceAccount:
      type: object
      properties:
        account:
          type: string
        debit:
          type: number
        credit:
          type: number

    Employee:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        department:
          type: string
        position:
          type: string

    PerformanceMetrics:
      type: object
      properties:
        revenue:
          type: number
        expenses:
          type: number
        workOrdersCompleted:
          type: integer
        customerSatisfaction:
          type: number

    SupportTicket:
      type: object
      properties:
        id:
          type: string
        subject:
          type: string
        status:
          type: string
          enum: [open, in-progress, resolved, closed]
        priority:
          type: string
          enum: [low, medium, high, critical]
        createdAt:
          type: string
          format: date-time

    AuditLog:
      type: object
      properties:
        id:
          type: string
        action:
          type: string
        userId:
          type: string
        timestamp:
          type: string
          format: date-time
        details:
          type: object

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        name:
          type: string
        role:
          type: string
        orgId:
          type: string

    JobApplication:
      type: object
      required: [resume, coverLetter]
      properties:
        resume:
          type: string
          description: Resume file URL or content
        coverLetter:
          type: string
        linkedIn:
          type: string
        portfolio:
          type: string

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Block merge commits into protected branches unless explicitly approved
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null)"
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  APPROVAL_FILE=".git/FIXZIT_ALLOW_MAIN_MERGE"
  if [ ! -f "$APPROVAL_FILE" ]; then
    echo "ERROR: Merge commit to '$CURRENT_BRANCH' is blocked."
    echo "Create $APPROVAL_FILE with: I APPROVE MAIN MERGE"
    exit 1
  fi
  if ! grep -q "^I APPROVE MAIN MERGE" "$APPROVAL_FILE"; then
    echo "ERROR: $APPROVAL_FILE missing required approval text."
    echo "Expected line: I APPROVE MAIN MERGE"
    exit 1
  fi
fi

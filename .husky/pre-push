#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================================
# AGENTS.md Enforcement: Pre-Push Validation
# ============================================================================

echo "üîí AGENTS.md Enforcement: Pre-push validation..."

# ============================================================================
# CHECK 1: Block direct pushes to protected branches
# ============================================================================
while read local_ref local_sha remote_ref remote_sha; do
  if echo "$remote_ref" | grep -Eq "^refs/heads/(main|master)$"; then
    echo "ERROR: Direct pushes to '$remote_ref' are blocked. Create a PR and merge to main."
    exit 1
  fi
done

# ============================================================================
# CHECK 2: Verify all commits have Agent Token
# ============================================================================
echo "üîç Checking commits for Agent Tokens..."

# Get commits that will be pushed
COMMITS_TO_PUSH=$(git log @{u}..HEAD --oneline 2>/dev/null || git log HEAD~5..HEAD --oneline)

if [ -n "$COMMITS_TO_PUSH" ]; then
  MISSING_TOKEN=0
  while IFS= read -r commit; do
    COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
    if ! echo "$COMMIT_MSG" | grep -qE '\[AGENT-[0-9]{4}\]'; then
      echo "‚ùå Missing Agent Token in: $commit"
      MISSING_TOKEN=$((MISSING_TOKEN + 1))
    fi
  done <<< "$COMMITS_TO_PUSH"
  
  if [ $MISSING_TOKEN -gt 0 ]; then
    echo ""
    echo "‚ùå $MISSING_TOKEN commit(s) missing Agent Token [AGENT-XXXX]"
    echo "   Amend commits to include your Agent Token."
    echo "   See docs/AGENTS.md Section 3.5 for requirements."
    echo ""
    exit 1
  fi
  echo "‚úÖ All commits have Agent Tokens"
fi

# ============================================================================
# CHECK 3: Reject old forbidden token format
# ============================================================================
echo "üîç Checking for forbidden token formats..."
OLD_FORMAT=$(git log @{u}..HEAD --oneline 2>/dev/null | grep -E '\[AGENT-[0-9]{3}-[A-Z]\]' || true)
if [ -n "$OLD_FORMAT" ]; then
  echo ""
  echo "‚ùå FORBIDDEN: Old token format [AGENT-XXX-X] detected!"
  echo "   $OLD_FORMAT"
  echo ""
  echo "   Required format: [AGENT-XXXX] (4-digit, no letter)"
  echo "   Amend commits to use correct format."
  echo ""
  exit 1
fi

# ============================================================================
# CHECK 4: Run mongo-unwrap guard
# ============================================================================
echo "üîç Running MongoDB unwrap guard..."
pnpm lint:mongo-unwrap || {
  echo "‚ùå MongoDB unwrap guard failed."
  exit 1
}

# ============================================================================
# CHECK 5: TypeScript check
# ============================================================================
echo "üîç Running TypeScript check..."
pnpm typecheck || {
  echo "‚ùå TypeScript check failed. Fix errors before pushing."
  exit 1
}

echo "‚úÖ Pre-push validation passed!"

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Ensure translation artifacts are up-to-date before committing
echo "ğŸ”„ Checking i18n artifacts..."

# Check if any translation source files were modified
TRANSLATION_SOURCES_CHANGED=$(git diff --cached --name-only | grep -E "^i18n/(sources/.*\.json|new-translations\.ts)$")

if [ -n "$TRANSLATION_SOURCES_CHANGED" ]; then
  echo "ğŸ“¦ Translation sources changed, regenerating dictionaries..."
  pnpm run i18n:build
  
  # Add generated files to commit
  git add i18n/generated/*.dictionary.json
  
  echo "âœ… Translation artifacts updated"
fi

# Run TypeScript check
echo "ğŸ” Running TypeScript check..."
pnpm tsc --noEmit

if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Please fix before committing."
  exit 1
fi

# PROC-005: Local Security Audit (non-blocking - warns only)
echo "ğŸ”’ Running security audit..."
if pnpm audit --audit-level=high 2>/dev/null; then
  echo "âœ… No high/critical vulnerabilities found"
else
  echo "âš ï¸  Security vulnerabilities detected (non-blocking)"
  echo "   Run: pnpm audit --fix"
  echo "   Or review: pnpm audit"
fi

# Run translation audit (non-blocking while known gaps are being fixed)
echo "ğŸ§ª Auditing translation keys..."
if ! pnpm run scan:i18n:audit; then
  echo "âš ï¸  Translation audit reported issues (non-blocking)"
  echo "   Resolve by adding the missing keys listed above."
fi

# Run high-fidelity coverage check (EN/AR only, non-blocking warning)
echo "ğŸŒ Checking translation coverage..."
pnpm run i18n:coverage -- --locales=en,ar --silent || {
  echo "âš ï¸  Translation coverage issues detected (not blocking)"
  echo "   Run: pnpm i18n:coverage -- --locales=en,ar"
}

echo "âœ… Pre-commit checks passed!"

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Enforce PR-only flow by blocking commits on protected branches
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null)"
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "ERROR: Direct commits to '$CURRENT_BRANCH' are blocked. Create a feature branch and open a PR."
  exit 1
fi

# Ensure translation artifacts are up-to-date before committing
echo "üîÑ Checking i18n artifacts..."

# Check if any translation source files were modified
TRANSLATION_SOURCES_CHANGED=$(git diff --cached --name-only | grep -E "^i18n/(sources/.*\.json|new-translations\.ts)$")

if [ -n "$TRANSLATION_SOURCES_CHANGED" ]; then
  echo "üì¶ Translation sources changed, regenerating dictionaries..."
  pnpm run i18n:build
  
  # Add generated files to commit
  git add i18n/generated/*.dictionary.json
  
  echo "‚úÖ Translation artifacts updated"
fi

# Security: fail fast on known vulnerabilities
if [ "${SKIP_PNPM_AUDIT:-false}" != "true" ]; then
  echo "üõ°Ô∏è  Running pnpm audit (prod, high severity)..."
  pnpm audit --prod --audit-level=high
  if [ $? -ne 0 ]; then
    echo "‚ùå pnpm audit reported vulnerabilities (prod, high). Fix or set SKIP_PNPM_AUDIT=true to bypass locally."
    exit 1
  fi
else
  echo "‚ö†Ô∏è  SKIP_PNPM_AUDIT=true - pnpm audit skipped for this commit."
fi

# Run TypeScript check
echo "üîç Running TypeScript check..."
pnpm tsc --noEmit

if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript errors found. Please fix before committing."
  exit 1
fi

# Guard against unsafe client process.env usage
echo "üîê Checking client env usage..."
node scripts/audit-client-env.mjs
if [ $? -ne 0 ]; then
  echo "‚ùå Unsafe process.env usage detected in client code."
  exit 1
fi

# Guard against undocumented @ts-expect-error annotations
echo "üßæ Checking @ts-expect-error annotations..."
node scripts/check-ts-expect-error.mjs
if [ $? -ne 0 ]; then
  echo "‚ùå Undocumented @ts-expect-error detected."
  exit 1
fi

# PROC-005: Local Security Audit (non-blocking - warns only)
echo "üîí Running security audit..."
if pnpm audit --audit-level=high 2>/dev/null; then
  echo "‚úÖ No high/critical vulnerabilities found"
else
  echo "‚ö†Ô∏è  Security vulnerabilities detected (non-blocking)"
  echo "   Run: pnpm audit --fix"
  echo "   Or review: pnpm audit"
fi

# Run translation audit (non-blocking while known gaps are being fixed)
echo "üß™ Auditing translation keys..."
if ! pnpm run scan:i18n:audit; then
  echo "‚ö†Ô∏è  Translation audit reported issues (non-blocking)"
  echo "   Resolve by adding the missing keys listed above."
fi

# EFF-003: Check API routes for try-catch error handling
echo "üõ°Ô∏è  Checking API routes for error handling..."
API_ROUTES_CHANGED=$(git diff --cached --name-only | grep -E "^app/api/.*route\.ts$")
if [ -n "$API_ROUTES_CHANGED" ]; then
  MISSING_TRY_CATCH=0
  for route in $API_ROUTES_CHANGED; do
    # Skip routes that use crud-factory (already has try-catch)
    if grep -q "createCrudHandlers" "$route" 2>/dev/null; then
      continue
    fi
    # Check if route has try-catch
    if ! grep -q "try\s*{" "$route" 2>/dev/null; then
      echo "‚ö†Ô∏è  Missing try-catch in: $route"
      MISSING_TRY_CATCH=$((MISSING_TRY_CATCH + 1))
    fi
  done
  if [ $MISSING_TRY_CATCH -gt 0 ]; then
    echo "‚ö†Ô∏è  $MISSING_TRY_CATCH API route(s) missing try-catch (non-blocking)"
    echo "   Add try-catch or use createCrudHandlers from lib/api/crud-factory.ts"
  fi
fi

# Run high-fidelity coverage check (EN/AR only, non-blocking warning)
echo "üåê Checking translation coverage..."
pnpm run i18n:coverage -- --locales=en,ar --silent || {
  echo "‚ö†Ô∏è  Translation coverage issues detected (not blocking)"
  echo "   Run: pnpm i18n:coverage -- --locales=en,ar"
}

echo "‚úÖ Pre-commit checks passed!"

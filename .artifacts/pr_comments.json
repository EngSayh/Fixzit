{"author":{"id":"U_kgDODNUrTg","is_bot":false,"login":"EngSayh","name":"Eng. Sultan Al Hassni"},"baseRefName":"main","comments":[{"id":"IC_kwDOPtDyds7Mx9fb","author":{"login":"coderabbitai"},"authorAssociation":"NONE","body":"<!-- This is an auto-generated comment: summarize by coderabbit.ai -->\n<!-- walkthrough_start -->\n\n<details>\n<summary>üìù Walkthrough</summary>\n\n<!-- This is an auto-generated comment: release notes by coderabbit.ai -->\n\n## Summary by CodeRabbit\n\n## Release Notes\n\n* **Bug Fixes**\n  * Fixed race condition during concurrent listing creation operations.\n\n* **Security**\n  * Enhanced email privacy by implementing salted hashing in logs.\n  * Strengthened rate limiting with improved IP extraction to prevent spoofing attacks.\n\n* **Documentation**\n  * Updated configuration documentation with new environment variables.\n\n<!-- end of auto-generated comment: release notes by coderabbit.ai -->\n## Walkthrough\n\nA documentation file details 6 security and quality fixes: preventing race conditions in listings API transactions, salting email hashes in authentication, mitigating X-Forwarded-For spoofing in rate limiting, adding safer TypeScript type casting in packages API, and updating environment configuration documentation.\n\n## Changes\n\n| Cohort / File(s) | Summary |\n|---|---|\n| **Documentation & Configuration** <br> `PR137_CRITICAL_FIXES_COMPLETE.md`, `README.md`, `env.example` | New comprehensive PR documentation detailing all fixes with before/after code snippets and deployment checklists. README.md updated with new environment variables (NEXTAUTH_SECRET, INTERNAL_API_SECRET, LOG_HASH_SALT, OAuth credentials). env.example adds LOG_HASH_SALT variable for email hashing salt. |\n| **Auth Security** <br> `auth.config.ts` | hashEmail function now appends environment-specified LOG_HASH_SALT (or default) to email before hashing, changing hash output while maintaining function signature. |\n| **API Transaction & Type Safety** <br> `app/api/aqar/listings/route.ts`, `app/api/aqar/packages/route.ts` | listings/route.ts: Refactored transaction logic to capture and return listing from within transaction block, preventing race condition between commit and subsequent reads. Adds NO_ACTIVE_PACKAGE error handling. packages/route.ts: Added type cast `payment._id as mongoose.Types.ObjectId` for type conformity. |\n| **Rate Limiting Security** <br> `lib/rateLimit.ts` | Introduced getClientIp(request) helper to centralize IP extraction, prioritizing x-real-ip, cf-connecting-ip, then last IP from x-forwarded-for. Replaces client-controlled first IP extraction to mitigate X-Forwarded-For spoofing. |\n\n## Estimated code review effort\n\nüéØ 3 (Moderate) | ‚è±Ô∏è ~20 minutes\n\n## Poem\n\n> üê∞ Six fixes bundled with care and precision,\n> Race conditions caught in a transaction's decision,\n> Salted hashes protect the sensitive mail,\n> IP spoofing thwarted without fail‚Äî\n> Security strengthened, bugs brushed away! ‚ú®\n\n</details>\n\n<!-- walkthrough_end -->\n\n\n<!-- pre_merge_checks_walkthrough_start -->\n\n## Pre-merge checks and finishing touches\n<!-- pre_merge_checks_override_start -->\n> [!CAUTION]\n> ## Pre-merge checks failed\n> \n> Please resolve all errors before merging. Addressing warnings is optional.\n> \n> - [ ] <!-- {\"checkboxId\": \"override-pre-merge-checks\"} --> Ignore\n<!-- pre_merge_checks_override_end -->\n<details>\n<summary>‚ùå Failed checks (2 errors)</summary>\n\n|     Check name    | Status  | Explanation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Resolution |\n| :---------------: | :------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------- |\n|    Title Check    | ‚ùå Error | The PR title claims to \"Resolve ALL 9 Critical Issues from PR #137 Review,\" but the actual changeset documents only 6 primary fixes as shown in the raw summary and PR description. The summary table explicitly lists \"6 Total\" critical issues fixed, and the PR objectives confirm \"six critical/high/medium fixes implemented\" with \"total resolved: 6 listed fixes.\" This discrepancy between claiming \"ALL 9\" issues in the title while the changeset only addresses 6 creates a factual inaccuracy about the scope of work.                                                                                                                                                                                                                             |            |\n| Description Check | ‚ùå Error | The PR description provides helpful information about the fixes but does not follow the required template structure. It is missing several critical sections including the governance checklist with specific checkboxes, the formal evidence section with required artifacts (before/after screenshots, console logs, network logs, build/TypeScript summary, test output), test results in code block format, page √ó role verification, performance metrics, similar-issue sweep, requirements verification (mapping to /docs/requirements/), and a rollback plan. While the description adequately explains what was changed and why, the substantial deviation from the required template format and missing key sections represent incomplete compliance. |            |\n\n</details>\n<details>\n<summary>‚úÖ Passed checks (1 passed)</summary>\n\n|     Check name     | Status   | Explanation                                                                         |\n| :----------------: | :------- | :---------------------------------------------------------------------------------- |\n| Docstring Coverage | ‚úÖ Passed | Docstring coverage is 83.33% which is sufficient. The required threshold is 80.00%. |\n\n</details>\n\n<!-- pre_merge_checks_walkthrough_end -->\n\n<!-- finishing_touch_checkbox_start -->\n\n<details>\n<summary>‚ú® Finishing touches</summary>\n\n- [ ] <!-- {\"checkboxId\": \"7962f53c-55bc-4827-bfbf-6a18da830691\"} --> üìù Generate docstrings\n<details>\n<summary>üß™ Generate unit tests (beta)</summary>\n\n- [ ] <!-- {\"checkboxId\": \"f47ac10b-58cc-4372-a567-0e02b2c3d479\", \"radioGroupId\": \"utg-output-choice-group-unknown_comment_id\"} -->   Create PR with unit tests\n- [ ] <!-- {\"checkboxId\": \"07f1e7d6-8a8e-4e23-9900-8731c2c87f58\", \"radioGroupId\": \"utg-output-choice-group-unknown_comment_id\"} -->   Post copyable unit tests in a comment\n- [ ] <!-- {\"checkboxId\": \"6ba7b810-9dad-11d1-80b4-00c04fd430c8\", \"radioGroupId\": \"utg-output-choice-group-unknown_comment_id\"} -->   Commit unit tests in branch `fix/pr137-remaining-issues`\n\n</details>\n\n</details>\n\n<!-- finishing_touch_checkbox_end -->\n\n<!-- tips_start -->\n\n---\n\n\n\n<sub>Comment `@coderabbitai help` to get the list of available commands and usage tips.</sub>\n\n<!-- tips_end -->\n\n<!-- internal state start -->\n\n\n<!-- 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 -->\n\n<!-- internal state end -->","createdAt":"2025-10-23T08:06:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/EngSayh/Fixzit/pull/138#issuecomment-3435648987","viewerDidAuthor":false}],"headRefName":"fix/pr137-remaining-issues","number":138,"reviews":[{"id":"PRR_kwDOPtDyds7IytMU","author":{"login":"coderabbitai"},"authorAssociation":"NONE","body":"**Actionable comments posted: 2**\n\n> [!CAUTION]\n> Some comments are outside the diff and can‚Äôt be posted inline due to platform limitations.\n> \n> \n> \n> <details>\n> <summary>‚ö†Ô∏è Outside diff range comments (4)</summary><blockquote>\n> \n> <details>\n> <summary>auth.config.ts (2)</summary><blockquote>\n> \n> `7-13`: **Do not use a hardcoded default salt in production; add delimiter and (optionally) longer hash.**\n> \n> Fallback salt should be dev‚Äëonly. Also delimit to avoid ambiguity; 16+ hex chars reduces collisions.\n> \n> ```diff\n> -  // Add salt to prevent rainbow table attacks\n> -  const salt = process.env.LOG_HASH_SALT || 'fixzit-default-salt-change-in-production';\n> -  const msgUint8 = new TextEncoder().encode(email + salt);\n> +  // Add salt to prevent rainbow table attacks (prod requires LOG_HASH_SALT)\n> +  const salt = process.env.LOG_HASH_SALT ?? 'fixzit-default-salt-dev-only';\n> +  if (process.env.NODE_ENV === 'production' && !process.env.LOG_HASH_SALT) {\n> +    throw new Error('LOG_HASH_SALT is required in production');\n> +  }\n> +  const msgUint8 = new TextEncoder().encode(`${salt}|${email}`);\n>    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);\n>    const hashArray = Array.from(new Uint8Array(hashBuffer));\n>    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\n> -  return hashHex.substring(0, 12);\n> +  return hashHex.substring(0, 16); // 64 bits\n> ```\n> \n> ---\n> \n> `22-33`: **Validate LOG_HASH_SALT at startup (prod).**\n> \n> Mirror other env checks so prod never runs with a default/empty salt.\n> \n> ```diff\n>  const NEXTAUTH_SECRET = process.env.NEXTAUTH_SECRET;\n>  const INTERNAL_API_SECRET = process.env.INTERNAL_API_SECRET;\n> +const LOG_HASH_SALT = process.env.LOG_HASH_SALT;\n> \n>  const missingVars: string[] = [];\n>  if (!GOOGLE_CLIENT_ID) missingVars.push('GOOGLE_CLIENT_ID');\n>  if (!GOOGLE_CLIENT_SECRET) missingVars.push('GOOGLE_CLIENT_SECRET');\n>  if (!NEXTAUTH_SECRET) missingVars.push('NEXTAUTH_SECRET');\n>  if (!INTERNAL_API_SECRET) missingVars.push('INTERNAL_API_SECRET');\n> +if (process.env.NODE_ENV === 'production' && !LOG_HASH_SALT) missingVars.push('LOG_HASH_SALT');\n> ```\n> \n> </blockquote></details>\n> <details>\n> <summary>app/api/aqar/listings/route.ts (2)</summary><blockquote>\n> \n> `156-163`: **Fix required-fields check (falsy trap).**\n> \n> Current check rejects valid 0/false values (e.g., areaSqm=0). Use nullish/empty‚Äëstring check.\n> \n> ```diff\n> -const missingFields = requiredFields.filter((field) => !sanitizedBody[field]);\n> +const missingFields = requiredFields.filter((field) => {\n> +  const v = sanitizedBody[field as keyof typeof sanitizedBody];\n> +  if (v === null || v === undefined) return true;\n> +  return typeof v === 'string' && v.trim().length === 0;\n> +});\n> ```\n> \n> ---\n> \n> `186-216`: **Session leak: end the session on success too.**\n> \n> withTransaction commits/aborts, but does not end the session. Always end it.\n> \n> ```diff\n> -      const session = await AqarPackage.startSession();\n> -      let createdListing;\n> -      \n> -      try {\n> -        createdListing = await session.withTransaction(async () => {\n> +      const session = await AqarPackage.startSession();\n> +      let createdListing;\n> +      try {\n> +        createdListing = await session.withTransaction(async () => {\n>            // ... unchanged ...\n> -          return listing;\n> -        });\n> -        \n> -        // Session already ended by withTransaction, no need to call endSession\n> -        \n> -        return NextResponse.json({ listing: createdListing }, { status: 201 });\n> -      } catch (txError) {\n> -        // Transaction auto-aborted by withTransaction, just end the session\n> -        await session.endSession();\n> +          return listing;\n> +        });\n> +        return NextResponse.json({ listing: createdListing }, { status: 201 });\n> +      } catch (txError) {\n>          // Transaction auto-aborted by withTransaction, just end the session\n> -        \n>          if (txError instanceof Error && txError.message === 'NO_ACTIVE_PACKAGE') {\n>            return NextResponse.json(\n>              { error: 'No active listing package. Please purchase a package first.' },\n>              { status: 402 }\n>            );\n>          }\n> -        throw txError; // Re-throw to be caught by outer catch block\n> -      }\n> +        throw txError; // Re-throw to be caught by outer catch block\n> +      } finally {\n> +        await session.endSession();\n> +      }\n> ```\n> \n> </blockquote></details>\n> \n> </blockquote></details>\n\n<details>\n<summary>üßπ Nitpick comments (8)</summary><blockquote>\n\n<details>\n<summary>env.example (1)</summary><blockquote>\n\n`49-54`: **Make LOG_HASH_SALT mandatory in production + clarify guidance.**\n\nDeclare it REQUIRED in prod, specify 32+ bytes entropy, and add rotation note.\n\n```diff\n # === SECURITY - EMAIL HASHING ===\n-# Salt for hashing email addresses in logs (privacy protection)\n-# This prevents rainbow table attacks on hashed email addresses\n-# Generate: openssl rand -hex 32\n-LOG_HASH_SALT=\n+# Salt for hashing email addresses in logs (privacy protection)\n+# REQUIRED in production. 32+ bytes entropy. Unique per environment. Rotate if leaked.\n+# Generate: openssl rand -hex 32\n+LOG_HASH_SALT=\n```\n\n</blockquote></details>\n<details>\n<summary>app/api/aqar/packages/route.ts (1)</summary><blockquote>\n\n`116-122`: **Harden ObjectId handling (avoid instanceof pitfalls).**\n\ninstanceof Types.ObjectId can fail across multiple Mongoose copies. Validate and normalize instead.\n\n```diff\n- // Update package with payment ID (with runtime validation)\n- if (!payment._id || !(payment._id instanceof mongoose.Types.ObjectId)) {\n-   throw new Error('Invalid payment ID after save');\n- }\n- pkg.paymentId = payment._id as mongoose.Types.ObjectId;\n+ // Update package with payment ID (normalized)\n+ if (!mongoose.isValidObjectId(payment._id)) {\n+   throw new Error('Invalid payment ID after save');\n+ }\n+ pkg.paymentId = new mongoose.Types.ObjectId(String(payment._id));\n```\nPlease confirm AqarPackage.paymentId is declared as ObjectId ref to AqarPayment in the schema.\n\n</blockquote></details>\n<details>\n<summary>README.md (1)</summary><blockquote>\n\n`103-118`: **Call out LOG_HASH_SALT as REQUIRED in production and add quick-gen snippet.**\n\nSmall docs tweak improves setup correctness.\n\n```diff\n-# Security - Email Hashing (for privacy-preserving logs)\n-LOG_HASH_SALT=your-random-salt-here          # Generate with: openssl rand -hex 32\n+# Security - Email Hashing (for privacy-preserving logs)\n+# REQUIRED in production. Unique per environment. Generate with:\n+# openssl rand -hex 32\n+LOG_HASH_SALT=your-random-salt-here\n```\n\n</blockquote></details>\n<details>\n<summary>lib/rateLimit.ts (2)</summary><blockquote>\n\n`17-26`: **Avoid keeping the process alive with the cleanup timer.**\n\nUnref the interval so it won‚Äôt block process exit.\n\n```diff\n-setInterval(() => {\n+const _gc = setInterval(() => {\n   const now = Date.now();\n   for (const [key, entry] of rateLimitStore.entries()) {\n     if (entry.resetAt < now) {\n       rateLimitStore.delete(key);\n     }\n   }\n-}, 5 * 60 * 1000);\n+}, 5 * 60 * 1000);\n+// Don't keep the event loop alive just for cleanup\n+// @ts-ignore - unref present in Node runtimes\n+(_gc as any).unref?.();\n```\n\n---\n\n`70-116`: **In‚Äëmemory limiter is per‚Äëinstance; use Redis (or similar) for real production.**\n\nBehind multiple instances, keys won‚Äôt be shared and abuse can slip through.\n\n- Suggest Upstash/Redis with per‚ÄëIP key TTL.\n- Keep this in‚Äëmemory path for local/dev only via an env flag.\n\n</blockquote></details>\n<details>\n<summary>app/api/aqar/listings/route.ts (2)</summary><blockquote>\n\n`172-180`: **Align validation message with the variable being checked.**\n\nMessage says ‚ÄúRent price‚Äù but code checks price.\n\n```diff\n-          { error: 'Rent price must be a positive number when rentFrequency is specified' },\n+          { error: 'Price must be a positive number when rentFrequency is specified' },\n```\n\n---\n\n`183-189`: **Use sanitized `source` instead of `body.source`.**\n\nStay consistent with sanitized inputs for control flow.\n\n```diff\n-    if (body.source === 'AGENT' || body.source === 'DEVELOPER') {\n+    if (source === 'AGENT' || source === 'DEVELOPER') {\n```\n\n</blockquote></details>\n<details>\n<summary>PR137_CRITICAL_FIXES_COMPLETE.md (1)</summary><blockquote>\n\n`1-280`: **Add blank lines before/after code blocks and headings (markdownlint MD031 & MD022).**\n\nStatic analysis flagged 15 markdown formatting violations across the document. Code blocks lack blank lines before and after (MD031), and headings lack preceding blank lines (MD022). While these don't affect content, they impact markdown rendering consistency and document style.\n\nApply blank lines around all code blocks and ensure headings have a blank line above them (unless at document start).\n\n\n**Example fix** for lines 172‚Äì175 (current):\n```\n## üß™ Quality Verification\n\n### TypeScript Compilation\n```bash\n```\n\n**Should be**:\n```\n## üß™ Quality Verification\n\n### TypeScript Compilation\n\n```bash\n```\n\nApply this pattern throughout the document.\n\n</blockquote></details>\n\n</blockquote></details>\n\n<details>\n<summary>üìú Review details</summary>\n\n**Configuration used**: CodeRabbit UI\n\n**Review profile**: CHILL\n\n**Plan**: Pro\n\n**Knowledge base: Disabled due to `Reviews -> Disable Knowledge Base` setting**\n\n<details>\n<summary>üì• Commits</summary>\n\nReviewing files that changed from the base of the PR and between 4123247c2623455b30ae24d15a07532befe99ee2 and d12c2f2d9617ac717ef4e80219163354d04f3e51.\n\n</details>\n\n<details>\n<summary>üìí Files selected for processing (7)</summary>\n\n* `PR137_CRITICAL_FIXES_COMPLETE.md` (1 hunks)\n* `README.md` (1 hunks)\n* `app/api/aqar/listings/route.ts` (2 hunks)\n* `app/api/aqar/packages/route.ts` (1 hunks)\n* `auth.config.ts` (1 hunks)\n* `env.example` (1 hunks)\n* `lib/rateLimit.ts` (3 hunks)\n\n</details>\n\n<details>\n<summary>üß∞ Additional context used</summary>\n\n<details>\n<summary>üß¨ Code graph analysis (1)</summary>\n\n<details>\n<summary>app/api/aqar/listings/route.ts (1)</summary><blockquote>\n\n<details>\n<summary>auth.config.ts (1)</summary>\n\n* `session` (124-140)\n\n</details>\n\n</blockquote></details>\n\n</details><details>\n<summary>ü™õ markdownlint-cli2 (0.18.1)</summary>\n\n<details>\n<summary>PR137_CRITICAL_FIXES_COMPLETE.md</summary>\n\n30-30: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n43-43: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n65-65: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n74-74: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n97-97: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n103-103: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n137-137: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n143-143: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n163-163: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n174-174: Headings should be surrounded by blank lines\nExpected: 1; Actual: 0; Below\n\n(MD022, blanks-around-headings)\n\n---\n\n175-175: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n180-180: Headings should be surrounded by blank lines\nExpected: 1; Actual: 0; Below\n\n(MD022, blanks-around-headings)\n\n---\n\n181-181: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n---\n\n187-187: Headings should be surrounded by blank lines\nExpected: 1; Actual: 0; Below\n\n(MD022, blanks-around-headings)\n\n---\n\n188-188: Fenced code blocks should be surrounded by blank lines\n\n(MD031, blanks-around-fences)\n\n</details>\n\n</details>\n\n</details>\n\n<details>\n<summary>üîá Additional comments (2)</summary><blockquote>\n\n<details>\n<summary>app/api/aqar/listings/route.ts (1)</summary><blockquote>\n\n`191-205`: **Confirm atomicity of consumeListing to prevent oversell.**\n\nEnsure AqarPackage.consumeListing(session) uses an atomic conditional $inc (with listingsUsed < listingsAllowed) under the same session.\n\nIf not, switch to a findOneAndUpdate with session, precondition, and check modifiedCount.\n\n</blockquote></details>\n<details>\n<summary>PR137_CRITICAL_FIXES_COMPLETE.md (1)</summary><blockquote>\n\n`21-256`: **Well-structured documentation with clear before/after examples.**\n\nThe document effectively communicates all 6 issues with consistent structure: problem statement, before/after code, fix explanation, and impact. The inclusion of severity levels, file paths, and reviewer guidance is excellent. The deployment checklist and testing recommendations provide actionable next steps.\n\n</blockquote></details>\n\n</blockquote></details>\n\n</details>\n\n<!-- This is an auto-generated comment by CodeRabbit for review status -->","submittedAt":"2025-10-23T08:13:05Z","includesCreatedEdit":false,"reactionGroups":[],"state":"CHANGES_REQUESTED","commit":{"oid":"d12c2f2d9617ac717ef4e80219163354d04f3e51"}}]}

'use client';

import { useState, useEffect, useCallback } from 'react';
import { Bell, User, ChevronDown, Search } from 'lucide-react';
import LanguageSelector from './i18n/LanguageSelector';
import CurrencySelector from './i18n/CurrencySelector';
import AppSwitcher from './topbar/AppSwitcher';
import GlobalSearch from './topbar/GlobalSearch';
import QuickActions from './topbar/QuickActions';
import Portal from './Portal';
import Link from 'next/link';
import Image from 'next/image';
import { useRouter, usePathname } from 'next/navigation';
import { useTranslation } from '@/contexts/TranslationContext';
import { useResponsive } from '@/contexts/ResponsiveContext';
import { useFormState } from '@/contexts/FormStateContext';
import { logger } from '@/lib/logger';

// Fallback translations for when context is not available
const fallbackTranslations: Record<string, string> = {
  'common.brand': 'FIXZIT ENTERPRISE',
  'common.search.placeholder': 'Search Work Orders, Properties, Tenants...',
  'nav.notifications': 'Notifications',
  'common.unread': 'unread',
  'common.noNotifications': 'No new notifications',
  'common.loading': 'Loading...',
  'common.allCaughtUp': "You're all caught up!",
  'common.viewAll': 'View all notifications',
  'nav.profile': 'Profile',
  'nav.settings': 'Settings',
  'common.logout': 'Sign out'
};

interface TopBarProps {
  role?: string;
}

interface Notification {
  id: string;
  title: string;
  message: string;
  timestamp: string;
  read: boolean;
  priority: 'low' | 'medium' | 'high';
  category: string;
  type: string;
}

/**
 * Top navigation bar for the application, including brand, search, quick actions,
 * language/currency selectors, notifications, and user menu.
 *
 * Renders responsive, RTL-aware UI with:
 * - Brand and app switcher
 * - Global search (hidden on mobile) and a mobile search button
 * - Quick actions, compact language and currency selectors
 * - Notification bell with dropdown (loads notifications on open, shows loading/empty states,
 *   marks unread items with a dot, navigates to /notifications)
 * - User menu with Profile, Settings, and Sign out (clears client storage and redirects to /login)
 *
 * @param {string} [role='guest'] - Optional user role string (defaults to `'guest'`). Provided role may be used
 *               by downstream logic or hooks that consume this component's props.
 * @returns {JSX.Element} The TopBar React element.
 */
export default function TopBar({ role: _role = 'guest' }: TopBarProps) {
  const [notifOpen, setNotifOpen] = useState(false);
  const [userOpen, setUserOpen] = useState(false);
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [loading, setLoading] = useState(false);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [showUnsavedDialog, setShowUnsavedDialog] = useState(false);
  const [pendingNavigation, setPendingNavigation] = useState<string | null>(null);

  const router = useRouter();
  const pathname = usePathname();

  // Use FormStateContext for unsaved changes detection
  const formState = useFormState();
  const hasUnsavedChanges = formState.hasUnsavedChanges;

  // Close all popups helper
  const closeAllPopups = useCallback(() => {
    setNotifOpen(false);
    setUserOpen(false);
  }, []);

  // Close dropdowns when route changes
  useEffect(() => {
    closeAllPopups();
  }, [pathname, closeAllPopups]);

  // Get responsive context
  const { responsiveClasses, screenInfo, isRTL } = useResponsive();

  // Call useTranslation unconditionally at top level (React Rules of Hooks)
  const translationContext = useTranslation();
  const t = translationContext?.t ?? ((key: string, fallback?: string) => fallbackTranslations[key] || fallback || key);

  // Check authentication status on mount
  useEffect(() => {
    const checkAuth = async () => {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        setIsAuthenticated(response.ok);
      } catch {
        setIsAuthenticated(false);
      }
    };
    checkAuth();
  }, []);

  // Handle logo click with unsaved changes check
  const handleLogoClick = (e: React.MouseEvent) => {
    if (hasUnsavedChanges) {
      e.preventDefault();
      setShowUnsavedDialog(true);
      setPendingNavigation('/');
    } else {
      router.push('/');
    }
  };

  // Handle save and navigate - use event-driven pattern
  const handleSaveAndNavigate = async () => {
    try {
      // Use the FormStateContext's requestSave method which triggers
      // registered save handlers via events
      await formState.requestSave();
      
      // Only navigate if save was successful (no exception thrown)
      setShowUnsavedDialog(false);
      if (pendingNavigation) {
        router.push(pendingNavigation);
        setPendingNavigation(null);
      }
    } catch (error) {
      logger.error('Failed to save form', { error });
      // Don't close dialog or navigate - let user retry or discard
      alert(t('common.saveError', 'Failed to save changes. Please try again.'));
    }
  };

  // Handle discard and navigate
  const handleDiscardAndNavigate = () => {
    // Reset the form state via context
    formState.reset();
    setShowUnsavedDialog(false);
    if (pendingNavigation) {
      router.push(pendingNavigation);
      setPendingNavigation(null);
    }
  };

  // Define fetchNotifications before using it
  const fetchNotifications = useCallback(async () => {
    // Don't fetch notifications for guest users
    if (!isAuthenticated) {
      setNotifications([]);
      return;
    }

    setLoading(true);
    try {
      const response = await fetch('/api/notifications?limit=5&read=false', {
        credentials: 'include' // Use session cookies instead of hardcoded guest
      });
      if (response.ok) {
        const data = await response.json();
        setNotifications(data.items || []);
      } else {
        // Don't use mock notifications - just show empty
        setNotifications([]);
      }
    } catch (error) {
      logger.error('Failed to fetch notifications', { error });
      // Don't show mock notifications - just empty for guests
      setNotifications([]);
    } finally {
      setLoading(false);
    }
  }, [isAuthenticated]);

  // Fetch notifications when dropdown opens (only if authenticated)
  useEffect(() => {
    if (notifOpen && notifications.length === 0 && isAuthenticated) {
      fetchNotifications();
    }
  }, [notifOpen, notifications.length, isAuthenticated, fetchNotifications]);

  // Close notification popup when clicking outside or pressing Escape
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;

      // Check if the click is inside any popup container
      const isInsideNotification = target.closest('.notification-container');
      const isInsideUserMenu = target.closest('.user-menu-container');

      // Close notification if click is outside and it's open
      if (notifOpen && !isInsideNotification) {
        setNotifOpen(false);
      }

      // Close user menu if click is outside and it's open
      if (userOpen && !isInsideUserMenu) {
        setUserOpen(false);
      }
    };

    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === 'Escape') {
        closeAllPopups();
      }
    };

    // Add listeners if any popup is open
    if (notifOpen || userOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      document.addEventListener('keydown', handleKeyDown);
      return () => {
        document.removeEventListener('mousedown', handleClickOutside);
        document.removeEventListener('keydown', handleKeyDown);
      };
    }
  }, [notifOpen, userOpen, closeAllPopups]);

  const formatTimeAgo = (timestamp: string) => {
    const now = new Date();
    const time = new Date(timestamp);
    const diffInMinutes = Math.floor((now.getTime() - time.getTime()) / (1000 * 60));

    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
    return `${Math.floor(diffInMinutes / 1440)}d ago`;
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'text-red-600';
      case 'medium': return 'text-yellow-600';
      case 'low': return 'text-green-600';
      default: return 'text-gray-600';
    }
  };

  const handleLogout = async () => {
    try {
      // Call logout API to clear server-side session
      await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include'
      });

      // Save language and locale preferences before clearing storage
      const savedLang = localStorage.getItem('fxz.lang');
      const savedLocale = localStorage.getItem('fxz.locale');

      // Clear client-side storage
      localStorage.removeItem('fixzit-role');
      localStorage.removeItem('fixzit-currency');
      localStorage.removeItem('fxz.theme');

      // Clear any other localStorage items related to the app, BUT preserve language settings
      Object.keys(localStorage).forEach(key => {
        if ((key.startsWith('fixzit-') || key.startsWith('fxz-')) && 
            key !== 'fxz.lang' && 
            key !== 'fxz.locale') {
          localStorage.removeItem(key);
        }
      });

      // Restore language preferences
      if (savedLang) localStorage.setItem('fxz.lang', savedLang);
      if (savedLocale) localStorage.setItem('fxz.locale', savedLocale);

      // Force a hard reload to clear all state and redirect to login
      window.location.href = '/login';
    } catch (error) {
      logger.error('Logout error', { error });
      // Still redirect even if API call fails - use hard reload
      window.location.href = '/login';
    }
  };

  return (
    <header className={`sticky top-0 z-40 h-14 bg-gradient-to-r from-primary via-primary to-success text-white flex items-center justify-between ${responsiveClasses.container} shadow-sm border-b border-white/10 ${isRTL ? 'flex-row-reverse' : ''}`}>{/* FIXED: was #023047 (banned) */}
      <div className={`flex items-center gap-2 sm:gap-4 ${isRTL ? 'flex-row-reverse' : ''}`}>
        {/* Logo with unsaved changes handler */}
        <button
          onClick={handleLogoClick}
          className="flex items-center gap-2 hover:opacity-80 transition-opacity"
          aria-label="Go to home"
        >
          <Image
            src="/img/logo.jpg"
            alt="Fixzit Enterprise"
            width={32}
            height={32}
            className="rounded-md"
          />
          <span className={`font-bold ${screenInfo.isMobile ? 'hidden' : 'text-lg'} ${isRTL ? 'text-end' : ''}`}>
            {t('common.brand', 'FIXZIT ENTERPRISE')}
          </span>
        </button>
        <AppSwitcher />
      </div>
      
      {/* Global Search - Center */}
      <div className={`flex-1 max-w-2xl mx-4 ${screenInfo.isMobile ? 'hidden' : 'block'}`}>
        <GlobalSearch />
      </div>
      
      {/* Mobile search button */}
      {screenInfo.isMobile && (
        <button className="p-2 hover:bg-white/10 rounded-md" onClick={() => {/* Mobile search modal */}}>
          <Search className="w-4 h-4" />
        </button>
      )}
      
      <div className={`flex items-center gap-1 sm:gap-2 ${isRTL ? 'flex-row-reverse' : ''}`}>
        {/* Only show QuickActions for authenticated users */}
        {isAuthenticated && <QuickActions />}
        {/* Removed language and currency selectors - moved to profile dropdown */}
        {/* Only show notifications for authenticated users */}
        {isAuthenticated && (
          <div className="notification-container relative">
            <button
              onClick={() => {
                setUserOpen(false); // Close user menu when opening notifications
                setNotifOpen(!notifOpen);
              }}
              className="p-2 hover:bg-white/10 rounded-md relative transition-all duration-200 hover:scale-105"
              aria-label="Toggle notifications"
            >
              <Bell className="w-5 h-5" />
              {notifications.filter(n => !n.read).length > 0 && (
                <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
              )}
            </button>
            {notifOpen && (
            <Portal>
              <div 
                role="dialog"
                aria-label="Notifications"
                className="fixed bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 z-[100] max-h-[calc(100vh-5rem)] overflow-hidden animate-in slide-in-from-top-2 duration-200 w-80 max-w-[calc(100vw-2rem)] sm:w-96"
                style={{
                  top: '4rem',
                  [isRTL ? 'left' : 'right']: '1rem'
                }}
              >
                <div className="p-3 border-b border-gray-200 flex items-center justify-between">
                <div>
                  <div className="font-semibold">{t('nav.notifications', 'Notifications')}</div>
                  <div className="text-xs text-gray-500 mt-1">
                    {notifications.filter(n => !n.read).length > 0
                      ? `${notifications.filter(n => !n.read).length} ${t('common.unread', 'unread')}`
                      : t('common.noNotifications', 'No new notifications')
                    }
                  </div>
                </div>
                <button
                  onClick={() => setNotifOpen(false)}
                  className="p-1 hover:bg-gray-100 rounded-full"
                  aria-label="Close notifications"
                >
                  <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="max-h-80 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                {loading ? (
                  <div className="p-3 text-center text-gray-500">
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-300 mx-auto"></div>
                    <div className="text-xs mt-1">{t('common.loading', 'Loading...')}</div>
                  </div>
                ) : notifications.length > 0 ? (
                  <div className="space-y-1">
                    {notifications.map((notification) => (
                      <div
                        key={notification.id}
                        className="p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0 cursor-pointer transition-colors"
                        onClick={() => {
                          // Navigate to notification details or mark as read
                          setNotifOpen(false);
                          router.push('/notifications');
                        }}
                      >
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="font-medium text-sm text-gray-900">
                              {notification.title}
                            </div>
                            <div className="text-xs text-gray-600 mt-1">
                              {notification.message}
                            </div>
                            <div className="flex items-center justify-between mt-2">
                              <span className={`text-xs px-2 py-1 rounded-full ${getPriorityColor(notification.priority)} bg-gray-100`}>
                                {notification.priority.toUpperCase()}
                              </span>
                              <span className="text-xs text-gray-400">
                                {formatTimeAgo(notification.timestamp)}
                              </span>
                            </div>
                          </div>
                          {!notification.read && (
                            <div className="w-2 h-2 bg-blue-500 rounded-full ml-2 flex-shrink-0"></div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="p-6 text-center text-gray-500">
                    <Bell className="w-8 h-8 mx-auto mb-2 opacity-30" />
                    <div className="text-sm">{t('common.noNotifications', 'No new notifications')}</div>
                    <div className="text-xs text-gray-400 mt-1">{t('common.allCaughtUp', "You're all caught up!")}</div>
                  </div>
                )}
              </div>

              {notifications.length > 0 && (
                <div className="p-3 border-t border-gray-200 bg-gray-50">
                  <Link
                    href="/notifications"
                    className="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center gap-1"
                    onClick={() => setNotifOpen(false)}
                  >
                    {t('common.viewAll', 'View all notifications')}
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </Link>
                </div>
              )}
              </div>
            </Portal>
            )}
          </div>
        )}
        <div className="user-menu-container relative">
          <button 
            onClick={() => {
              setNotifOpen(false); // Close notifications when opening user menu
              setUserOpen(!userOpen);
            }} 
            className="flex items-center gap-1 p-2 hover:bg-white/10 rounded-md transition-colors"
            aria-label="Toggle user menu"
          >
            <User className="w-5 h-5" /><ChevronDown className="w-4 h-4" />
          </button>
          {userOpen && (
            <Portal>
              <div 
                role="menu"
                aria-label="User menu"
                className="fixed bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 py-1 z-[100] animate-in slide-in-from-top-2 duration-200 w-56 max-w-[calc(100vw-2rem)]"
                style={{
                  top: '4rem',
                  [isRTL ? 'left' : 'right']: '1rem'
                }}
              >
                <Link
                  href="/profile"
                  className="block px-4 py-2 hover:bg-gray-50 rounded transition-colors cursor-pointer text-gray-800"
                  role="menuitem"
                  onClick={() => setUserOpen(false)}
                >
                  {t('nav.profile', 'Profile')}
                </Link>
                <Link
                  href="/settings"
                  className="block px-4 py-2 hover:bg-gray-50 rounded transition-colors cursor-pointer text-gray-800"
                  role="menuitem"
                  onClick={() => setUserOpen(false)}
                >
                  {t('nav.settings', 'Settings')}
                </Link>
                
                {/* Language & Currency Section */}
                <div className="border-t my-1 mx-2" />
                <div className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">
                  {t('common.preferences', 'Preferences')}
                </div>
                <div className="px-4 py-2 space-y-2">
                  <LanguageSelector variant="default" />
                  <CurrencySelector variant="default" />
                </div>
                
                <div className="border-t my-1 mx-2" />
                <button
                  type="button"
                  role="menuitem"
                  className="block w-full text-start px-4 py-2 hover:bg-red-50 text-red-600 rounded transition-colors cursor-pointer"
                  onClick={handleLogout}
                >
                  {t('common.logout', 'Sign out')}
                </button>
              </div>
            </Portal>
          )}
        </div>
      </div>

      {/* Unsaved Changes Dialog */}
      {showUnsavedDialog && (
        <Portal>
          <div 
            className="fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4"
            role="dialog"
            aria-modal="true"
            aria-labelledby="unsaved-dialog-title"
          >
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
              <h3 
                id="unsaved-dialog-title"
                className="text-lg font-semibold text-gray-900 mb-2"
              >
                {t('common.unsavedChanges', 'Unsaved Changes')}
              </h3>
              <p className="text-gray-600 mb-6">
                {t('common.unsavedChangesMessage', 'You have unsaved changes. Do you want to save them before leaving?')}
              </p>
              <div className="flex gap-3 justify-end">
                <button
                  onClick={() => setShowUnsavedDialog(false)}
                  className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
                >
                  {t('common.cancel', 'Cancel')}
                </button>
                <button
                  onClick={handleDiscardAndNavigate}
                  className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-md transition-colors"
                >
                  {t('common.discard', 'Discard')}
                </button>
                <button
                  onClick={handleSaveAndNavigate}
                  className="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-md transition-colors"
                >
                  {t('common.saveAndContinue', 'Save & Continue')}
                </button>
              </div>
            </div>
          </div>
        </Portal>
      )}
    </header>
  );
}

name: I18n Validation

on:
  pull_request:
    paths:
      - 'i18n/sources/**/*.json'
      - 'i18n/new-translations.ts'
      - 'i18n/dictionaries/**/*.ts'
      - 'scripts/generate-dictionaries-json.ts'
      - 'scripts/flatten-base-dictionaries.ts'
      - 'scripts/split-translations.ts'
      - 'scripts/check-translation-parity.ts'
  push:
    branches:
      - main
      - develop
    paths:
      - 'i18n/sources/**/*.json'
      - 'i18n/new-translations.ts'
      - 'i18n/dictionaries/**/*.ts'
      - 'scripts/**/*.ts'
  workflow_dispatch:
    inputs:
      skip_parity_check:
        description: 'Skip parity check (for baseline updates)'
        required: false
        default: 'false'

jobs:
  validate-translations:
    name: Validate Translation Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Validate source files (check mode)
        run: |
          echo "üîç Validating translation source files..."
          if [ -f "scripts/split-translations.ts" ]; then
            npx tsx scripts/split-translations.ts --check || {
              echo "‚ùå Translation sources validation failed"
              exit 1
            }
          fi
          echo "‚úÖ Source files validated"
      
      - name: Check translation parity
        if: ${{ github.event.inputs.skip_parity_check != 'true' }}
        run: |
          echo "üìä Checking translation parity..."
          npx tsx scripts/check-translation-parity.ts --format=text || {
            echo "‚ö†Ô∏è  Parity issues detected - generating report artifact"
            npx tsx scripts/check-translation-parity.ts --format=json > parity-report.json
            exit 1
          }
      
      - name: Build translation dictionaries
        run: pnpm i18n:build
      
      - name: Check generated artifacts are up-to-date
        run: |
          if [ -n "$(git status --porcelain i18n/generated/)" ]; then
            echo "‚ùå Generated translation files are out of date!"
            echo ""
            echo "The following files have changes:"
            git status --porcelain i18n/generated/
            echo ""
            echo "üìã To fix this:"
            echo "  1. Run: pnpm i18n:build"
            echo "  2. Review changes: git diff i18n/generated/"
            echo "  3. Commit: git add i18n/generated/ && git commit"
            echo ""
            git diff i18n/generated/
            exit 1
          fi
          echo "‚úÖ Generated artifacts are up-to-date"
      
      - name: Check source artifacts drift
        run: |
          # Check if any source files were modified by the build
          if [ -n "$(git status --porcelain i18n/sources/)" ]; then
            echo "‚ö†Ô∏è  WARNING: Source files modified during build"
            echo ""
            git status --porcelain i18n/sources/
            echo ""
            echo "This may indicate:"
            echo "  - Automatic formatting applied"
            echo "  - Keys were re-sorted"
            echo "  - Merge artifacts from scripts"
            echo ""
            echo "Please review and commit if changes are intended."
            git diff i18n/sources/
            exit 1
          fi
          echo "‚úÖ Source files unchanged"
      
      - name: TypeScript check
        run: pnpm tsc --noEmit
      
      - name: Verify translation coverage baseline
        run: |
          EN_KEYS=$(jq 'keys | length' i18n/generated/en.dictionary.json)
          AR_KEYS=$(jq 'keys | length' i18n/generated/ar.dictionary.json)
          
          echo "üìä Translation Coverage:"
          echo "   English keys: $EN_KEYS"
          echo "   Arabic keys:  $AR_KEYS"
          echo "   Difference:   $((EN_KEYS - AR_KEYS))"
          echo ""
          
          # Current baseline from actual state (29672 EN, 29672 AR)
          BASELINE_EN=29672
          BASELINE_AR=29672
          
          if [ "$EN_KEYS" -lt "$BASELINE_EN" ]; then
            echo "‚ùå English key count dropped below baseline ($BASELINE_EN)"
            echo "   Current: $EN_KEYS, Expected: >= $BASELINE_EN"
            exit 1
          fi
          
          if [ "$AR_KEYS" -lt "$BASELINE_AR" ]; then
            echo "‚ùå Arabic key count dropped below baseline ($BASELINE_AR)"
            echo "   Current: $AR_KEYS, Expected: >= $BASELINE_AR"
            exit 1
          fi
          
          # Allow difference but warn if it grows
          DIFF=$((EN_KEYS > AR_KEYS ? EN_KEYS - AR_KEYS : AR_KEYS - EN_KEYS))
          MAX_DIFF=50
          
          if [ "$DIFF" -gt "$MAX_DIFF" ]; then
            echo "‚ö†Ô∏è  WARNING: Key count difference ($DIFF) exceeds threshold ($MAX_DIFF)"
            echo "   This may indicate missing translations"
          fi
          
          echo "‚úÖ Coverage baseline check passed"
      
      - name: High-Fidelity Coverage Check (EN/AR only)
        run: |
          echo "üîç Running high-fidelity coverage analysis..."
          npx tsx scripts/detect-unlocalized-strings.ts --locales=en,ar || {
            echo "‚ùå High-fidelity coverage check failed"
            echo "   This means EN or AR dictionaries have quality issues"
            exit 1
          }
          echo "‚úÖ EN/AR coverage verified"
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: i18n-coverage-report
          path: _artifacts/i18n-locale-coverage.json
          retention-days: 90
      
      - name: Upload parity report artifact
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: translation-parity-report
          path: parity-report.json
          retention-days: 30

---
# yamllint disable rule:line-length rule:truthy
name: I18n Validation

on:
  pull_request:
    paths:
      - 'i18n/sources/**/*.json'
      - 'i18n/new-translations.ts'
      - 'i18n/dictionaries/**/*.ts'
      - 'scripts/generate-dictionaries-json.ts'
      - 'scripts/flatten-base-dictionaries.ts'
      - 'scripts/split-translations.ts'
      - 'scripts/check-translation-parity.ts'
  push:
    branches:
      - main
      - develop
    paths:
      - 'i18n/sources/**/*.json'
      - 'i18n/new-translations.ts'
      - 'i18n/dictionaries/**/*.ts'
      - 'scripts/**/*.ts'
  workflow_dispatch:
    inputs:
      skip_parity_check:
        description: 'Skip parity check (for baseline updates)'
        required: false
        default: 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  validate-translations:
    name: Validate Translation Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Get pnpm store directory
        id: pnpm-store
        shell: bash
        run: echo "path=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.path }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: RTL logical lint
        run: pnpm run lint:rtl

      - name: Validate source files (check mode)
        run: |
          echo "ðŸ” Validating translation source files..."
          if [ -f "scripts/split-translations.ts" ]; then
            npx tsx scripts/split-translations.ts --check || {
              echo "âŒ Translation sources validation failed"
              exit 1
            }
          fi
          echo "âœ… Source files validated"

      - name: Check translation parity
        id: check-parity
        if: ${{ !(github.event_name == 'workflow_dispatch' && fromJSON(github.event.inputs.skip_parity_check || 'false')) }}
        continue-on-error: true
        run: |
          echo "ðŸ“Š Checking translation parity..."
          npx tsx scripts/check-translation-parity.ts --format=text || {
            echo "âš ï¸  Parity issues detected - generating report artifact"
            npx tsx scripts/check-translation-parity.ts --format=json > parity-report.json
            exit 1
          }

      - name: Fail when parity issues detected
        if: ${{ steps.check-parity.outcome == 'failure' }}
        run: |
          echo "âŒ Translation parity regression detected. See parity report artifact."
          exit 1

      - name: Build translation dictionaries
        run: pnpm i18n:build

      - name: Check generated artifacts are up-to-date
        run: |
          if [ -n "$(git status --porcelain i18n/generated/)" ]; then
            echo "âŒ Generated translation files are out of date!"
            echo ""
            echo "The following files have changes:"
            git status --porcelain i18n/generated/
            echo ""
            echo "ðŸ“‹ To fix this:"
            echo "  1. Run: pnpm i18n:build"
            echo "  2. Review changes: git diff i18n/generated/"
            echo "  3. Commit: git add i18n/generated/ && git commit"
            echo ""
            git diff i18n/generated/
            exit 1
          fi
          echo "âœ… Generated artifacts are up-to-date"

      - name: Check source artifacts drift
        run: |
          # Check if any source files were modified by the build
          if [ -n "$(git status --porcelain i18n/sources/)" ]; then
            echo "âš ï¸  WARNING: Source files modified during build"
            echo ""
            git status --porcelain i18n/sources/
            echo ""
            echo "This may indicate:"
            echo "  - Automatic formatting applied"
            echo "  - Keys were re-sorted"
            echo "  - Merge artifacts from scripts"
            echo ""
            echo "Please review and commit if changes are intended."
            git diff i18n/sources/
            exit 1
          fi
          echo "âœ… Source files unchanged"

      - name: TypeScript check
        run: pnpm tsc --noEmit
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Verify translation coverage baseline
        run: |
          EN_KEYS=$(jq 'keys | length' i18n/generated/en.dictionary.json)
          AR_KEYS=$(jq 'keys | length' i18n/generated/ar.dictionary.json)

          echo "ðŸ“Š Translation Coverage:"
          echo "   English keys: $EN_KEYS"
          echo "   Arabic keys:  $AR_KEYS"
          echo "   Difference:   $((EN_KEYS - AR_KEYS))"
          echo ""

          # Current baseline from actual state (29672 EN, 29672 AR)
          BASELINE_EN=29672
          BASELINE_AR=29672

          if [ "$EN_KEYS" -lt "$BASELINE_EN" ]; then
            echo "âŒ English key count dropped below baseline ($BASELINE_EN)"
            echo "   Current: $EN_KEYS, Expected: >= $BASELINE_EN"
            exit 1
          fi

          if [ "$AR_KEYS" -lt "$BASELINE_AR" ]; then
            echo "âŒ Arabic key count dropped below baseline ($BASELINE_AR)"
            echo "   Current: $AR_KEYS, Expected: >= $BASELINE_AR"
            exit 1
          fi

          # Allow difference but warn if it grows
          DIFF=$((EN_KEYS > AR_KEYS ? EN_KEYS - AR_KEYS : AR_KEYS - EN_KEYS))
          MAX_DIFF=50

          if [ "$DIFF" -gt "$MAX_DIFF" ]; then
            echo "âš ï¸  WARNING: Key count difference ($DIFF) exceeds threshold ($MAX_DIFF)"
            echo "   This may indicate missing translations"
          fi

          echo "âœ… Coverage baseline check passed"

      - name: High-Fidelity Coverage Check (EN/AR only)
        run: |
          echo "ðŸ” Running high-fidelity coverage analysis..."
          npx tsx scripts/detect-unlocalized-strings.ts --locales=en,ar || {
            echo "âŒ High-fidelity coverage check failed"
            echo "   This means EN or AR dictionaries have quality issues"
            exit 1
          }
          echo "âœ… EN/AR coverage verified"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: i18n-coverage-report
          path: _artifacts/i18n-locale-coverage.json
          retention-days: 90

      - name: Upload parity report artifact
        if: ${{ steps.check-parity.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: translation-parity-report
          path: parity-report.json
          retention-days: 30

  rtl-smoke:
    needs: validate-translations
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright (chromium)
        run: npx playwright install --with-deps chromium

      - name: RTL smoke tests (layout + dashboards + souq)
        env:
          ALLOW_DASHBOARD_TEST_AUTH: 'true'
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
        run: |
          npx playwright test \
            tests/smoke/rtl-layout.smoke.spec.ts \
            tests/smoke/rtl-dashboard-hr.smoke.spec.ts \
            tests/smoke/rtl-dashboard-finance.smoke.spec.ts \
            tests/smoke/rtl-dashboard-system.smoke.spec.ts \
            tests/smoke/rtl-souq.smoke.spec.ts \
            --project=chromium --workers=1

# ============================================================================
# Agent Token Enforcement - GitHub Action
# ============================================================================
# This workflow validates that ALL commits in a PR have proper agent tokens.
# It CANNOT be bypassed by --no-verify because it runs on GitHub's servers.
# ============================================================================

name: Agent Token Enforcement

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  validate-agent-tokens:
    name: Validate Agent Tokens
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit validation

      - name: Validate All Commits Have Agent Token
        run: |
          echo "ğŸ”’ AGENTS.md Enforcement: Validating commit messages..."
          echo ""
          
          # Get commits in this PR/push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            COMMITS=$(git log --format="%H %s" $BASE..$HEAD)
          else
            # For direct pushes, check last 10 commits
            COMMITS=$(git log --format="%H %s" -10)
          fi
          
          # Token patterns
          VALID_TOKEN_PATTERN='\[AGENT-[0-9]{4}\]'
          FORBIDDEN_TOKEN_PATTERN='\[AGENT-[0-9]{3}-[A-Z]\]'
          INVALID_TOKEN='[AGENT-0000]'
          
          FAILED=0
          
          echo "$COMMITS" | while IFS= read -r line; do
            if [ -z "$line" ]; then continue; fi
            
            COMMIT_HASH=$(echo "$line" | cut -d' ' -f1)
            COMMIT_MSG=$(echo "$line" | cut -d' ' -f2-)
            SHORT_HASH=$(echo "$COMMIT_HASH" | cut -c1-7)
            
            echo "Checking commit $SHORT_HASH: $COMMIT_MSG"
            
            # Check for forbidden old format
            if echo "$COMMIT_MSG" | grep -Eq "$FORBIDDEN_TOKEN_PATTERN"; then
              echo "  âŒ FORBIDDEN: Uses old format [AGENT-XXX-X]"
              echo "  ğŸ’¡ Use new format: [AGENT-XXXX] (4-digit sequential)"
              FAILED=1
            # Check for invalid token
            elif echo "$COMMIT_MSG" | grep -q "$INVALID_TOKEN"; then
              echo "  âŒ INVALID: Uses reserved token [AGENT-0000]"
              FAILED=1
            # Check for missing token
            elif ! echo "$COMMIT_MSG" | grep -Eq "$VALID_TOKEN_PATTERN"; then
              echo "  âŒ MISSING: No valid [AGENT-XXXX] token found"
              echo "  ğŸ’¡ Add token like: fix(scope): description [AGENT-0001]"
              FAILED=1
            else
              echo "  âœ… Valid agent token found"
            fi
          done
          
          if [ "$FAILED" = "1" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  â›” AGENT TOKEN VALIDATION FAILED                                 â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  One or more commits are missing valid agent tokens.              â•‘"
            echo "â•‘                                                                   â•‘"
            echo "â•‘  Required format: [AGENT-XXXX] where XXXX is 4-digit number       â•‘"
            echo "â•‘  Example: fix(auth): add validation [AGENT-0001]                  â•‘"
            echo "â•‘                                                                   â•‘"
            echo "â•‘  Forbidden formats:                                               â•‘"
            echo "â•‘    â€¢ [AGENT-001-A] (old format with letter suffix)                â•‘"
            echo "â•‘    â€¢ [AGENT-0000] (reserved/invalid)                              â•‘"
            echo "â•‘    â€¢ Missing token entirely                                       â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          echo ""
          echo "âœ… All commits have valid agent tokens"

      - name: Block Direct Pushes to Main
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš ï¸  WARNING: Direct push to protected branch detected            â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Direct pushes to main/master should go through PRs.              â•‘"
          echo "â•‘  This push has been logged for audit purposes.                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          # Note: We can't actually block the push after it happened,
          # but we log it and could notify via Slack/email if configured

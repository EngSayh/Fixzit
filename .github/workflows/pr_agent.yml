---
# yamllint disable rule:line-length rule:truthy
name: PR Agent

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  issue_comment:
    types: [created]

concurrency:
  group: pr-agent-${{ github.repository }}-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  pr_agent_job:
    # - ignore bots
    # - run only for PR events or PR comments (not issue comments)
    # - avoid fork PRs for pull_request event (secrets not exposed)
    if: >-
      ${{
        github.event.sender.type != 'Bot' &&
        (
          github.event_name == 'pull_request' ||
          (github.event_name == 'issue_comment' && github.event.issue.pull_request)
        ) &&
        (
          github.event_name != 'pull_request' ||
          github.event.pull_request.head.repo.full_name == github.repository
        )
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        if: ${{ (vars.ENABLE_PR_AGENT || 'true') != 'false' }}
        run: |
          if [ -z "${{ secrets.OPENAI_KEY }}" ]; then
            echo "::warning::OPENAI_KEY secret is not configured. PR Agent will be skipped."
            echo "SKIP_PR_AGENT=true" >> $GITHUB_ENV
          fi
      
      - name: PR Agent action step
        if: ${{ (vars.ENABLE_PR_AGENT || 'true') != 'false' && env.SKIP_PR_AGENT != 'true' }}
        uses: Codium-ai/pr-agent@main
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          GITHUB_TOKEN: ${{ github.token }}

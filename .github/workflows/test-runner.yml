---
# yamllint disable rule:line-length rule:truthy
name: Test Runner

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CI_LITE: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'full-ci') }}

# Prevent concurrent runs for same PR/ref
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  test:
    runs-on: ubuntu-latest

    # MongoDB service for index creation and DB-bound tests
    services:
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_DATABASE: fixzit_test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      NODE_OPTIONS: --max-old-space-size=8192
      NODE_ENV: test
      CI: true
      CI_COVERAGE: "true"
      # Auth secrets from GitHub Secrets (fallback to deterministic test values)
      JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key-for-ci-tests-minimum-32-characters' }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-nextauth-secret-for-ci-tests-32-chars' }}
      NEXTAUTH_URL: http://localhost:3000
      MONGODB_URI: mongodb://localhost:27017/fixzit_test
      ALLOW_OFFLINE_MONGODB: 'false'
      HEALTH_CHECK_TOKEN: ${{ secrets.HEALTH_CHECK_TOKEN || 'ci-health-check-token-for-tests' }}
      # Tenant IDs for tests - use deterministic test values if not defined
      PUBLIC_ORG_ID: ${{ secrets.PUBLIC_ORG_ID || '000000000000000000000001' }}
      DEFAULT_ORG_ID: ${{ secrets.DEFAULT_ORG_ID || '000000000000000000000002' }}
      TEST_ORG_ID: ${{ secrets.TEST_ORG_ID || 'test-org-id' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Drift Guard (tenancy/roles)
        run: pnpm tsx scripts/check-tenant-role-drift.ts

      - name: Run Linting
        run: pnpm lint

      - name: Run Type Check
        run: pnpm typecheck || pnpm tsc --noEmit

      - name: Ensure Mongo Indexes (idempotent)
        if: env.CI_LITE != 'true'
        env:
          MONGODB_URI: ${{ env.MONGODB_URI }}
        run: pnpm tsx -e "import { createIndexes } from './lib/db/collections'; import { getDatabase } from './lib/mongodb-unified'; (async () => { await createIndexes(); await (await getDatabase()).client?.close?.(); })();"

      - name: Run Unit Tests
        run: |
          set -e
          if [ "${CI_LITE}" = "true" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1
            pnpm vitest run --changed "origin/${{ github.base_ref }}" \
              --reporter=dot --passWithNoTests
          else
            # Run unit tests with coverage. Fail-fast if both runners fail.
            if pnpm run test:ci --passWithNoTests 2>/dev/null; then
              echo "Tests completed successfully"
            elif pnpm test --passWithNoTests 2>/dev/null; then
              echo "Tests completed with fallback command"
            else
              echo "::error::Unit tests failed (test:ci and test fallback both failed)"
              exit 1
            fi
          fi

      - name: Run Auth API Tests
        if: env.CI_LITE != 'true'
        run: |
          if npm pkg get scripts | grep -q '"test:auth"'; then
            pnpm test:auth --passWithNoTests
          else
            echo "No auth test suite configured, skipping"
          fi

      - name: Run Model Tests
        if: env.CI_LITE != 'true'
        run: |
          if npm pkg get scripts | grep -q '"test:models"'; then
            pnpm test:models
          else
            echo "No model tests configured, skipping"
          fi

      - name: Upload Coverage (if generated)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
          if-no-files-found: ignore

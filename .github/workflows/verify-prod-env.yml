name: Production Environment Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

# Ensure only one instance runs at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-production-env:
    name: Validate Production Environment Configuration
    runs-on: ubuntu-latest
    
    # Only run on preview deployments or production pushes
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    
    permissions:
      contents: read
      pull-requests: write
    
    env:
      # Vercel environment detection
      VERCEL_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}
      
      # Required production secrets (from GitHub Secrets)
      TAP_PUBLIC_KEY: ${{ secrets.TAP_PUBLIC_KEY }}
      TAP_WEBHOOK_SECRET: ${{ secrets.TAP_WEBHOOK_SECRET }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      
      # Non-secret configuration
      SKIP_ENV_VALIDATION: false
      DISABLE_MONGODB_FOR_BUILD: false
      NODE_ENV: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run production environment validation
        id: validate
        run: |
          echo "ðŸ” Validating production environment configuration..."
          node scripts/ci/verify-prod-env.js
          echo "validation_status=success" >> $GITHUB_OUTPUT
        continue-on-error: false
      
      - name: Check validation result
        if: failure()
        run: |
          echo "âŒ Production environment validation failed!"
          echo "Please ensure all required environment variables are configured:"
          echo "  - NEXTAUTH_SECRET (required for session signing)"
          echo "  - NEXTAUTH_URL (required for production runtime)"
          echo "  - TAP_PUBLIC_KEY (required for payment integration)"
          echo "  - TAP_WEBHOOK_SECRET (required for webhook verification)"
          echo ""
          echo "Set these in:"
          echo "  - Vercel: Project Settings â†’ Environment Variables"
          echo "  - GitHub: Repository Settings â†’ Secrets and Variables â†’ Actions"
          exit 1
      
      - name: Post validation success
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Production Environment Validation Passed**\\n\\nAll required environment variables are configured correctly for production deployment.'
            })
      
      - name: Summary
        if: always()
        run: |
          echo "### Production Environment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            echo "âœ… **Status**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All required environment variables are configured correctly." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Missing or invalid environment variables detected.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please configure the following in Vercel and GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
            echo "- NEXTAUTH_SECRET" >> $GITHUB_STEP_SUMMARY
            echo "- NEXTAUTH_URL" >> $GITHUB_STEP_SUMMARY
            echo "- TAP_PUBLIC_KEY" >> $GITHUB_STEP_SUMMARY
            echo "- TAP_WEBHOOK_SECRET" >> $GITHUB_STEP_SUMMARY
          fi

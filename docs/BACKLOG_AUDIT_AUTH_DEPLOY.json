{
  "issues": [
    {
      "key": "AUTH-DEPLOY-001",
      "externalId": "AUTH-DEPLOY-001",
      "title": "Login fails after every Vercel deployment due to AUTH_SECRET mismatch between preview and production",
      "category": "bug",
      "priority": "P0",
      "status": "open",
      "location": "lib/config/constants.ts:155-203, auth.config.ts:60-90, auth.config.ts:869",
      "sourcePath": "code-review",
      "sourceRef": "code-review:lib/config/constants.ts:155-203",
      "evidenceSnippet": "resolveAuthSecret() generates hash from VERCEL_DEPLOYMENT_ID causing different secrets per deploy",
      "effort": "S",
      "riskTags": ["SECURITY", "PRODUCTION", "AUTHENTICATION"],
      "description": "ROOT CAUSE: resolveAuthSecret() in lib/config/constants.ts generates a deterministic hash when AUTH_SECRET is missing, using VERCEL_DEPLOYMENT_ID as seed. Each new Vercel deployment creates a NEW deployment ID, generating a DIFFERENT secret. This breaks JWT verification for existing session cookies, forcing logout on every deploy.\n\nEVIDENCE:\n1. lib/config/constants.ts:177-189 uses VERCEL_DEPLOYMENT_ID as hash seed\n2. auth.config.ts:869 uses this secret for JWT signing\n3. Session cookies signed with old secret cannot be verified with new secret\n4. User must re-login after EVERY production deployment\n\nIMPACT:\n- All users logged out on every deploy (production + preview)\n- Session cookies become invalid immediately\n- Poor UX: users pay for Vercel but can't stay logged in\n- JWT verification fails with 'invalid signature' error\n\nVERCEL ENV SETUP:\nCurrent: AUTO-GENERATED hash per deployment\nRequired: STATIC AUTH_SECRET set in Vercel Environment Variables\n\nFIX:\n1. Generate secret: openssl rand -base64 32\n2. Add to Vercel (Project Settings > Environment Variables):\n   - Variable: AUTH_SECRET\n   - Value: <generated secret>\n   - Environments: Production, Preview, Development\n   - CRITICAL: Use SAME value for ALL environments\n3. Verify after deploy: curl https://fixzit.co/api/health/auth\n4. Test: Login → Deploy → Verify session persists\n\nRELATED FILES:\n- lib/config/constants.ts:155-203 (resolveAuthSecret function)\n- auth.config.ts:869 (secret usage)\n- app/api/auth/post-login/route.ts:51 (secret verification)\n- scripts/diagnose-login-issue.ts:20-24 (diagnostic tool)\n- scripts/deployment/setup-vercel-env.sh:85-91 (setup script)\n\nVALIDATION:\nAfter fix, run: pnpm tsx scripts/diagnose-login-issue.ts",
      "notes": "User reported: 'every-time I deploy I pay for vercel, ensure the codes are correct'. This is the root cause.",
      "relatedIssues": [],
      "mentionCount": 1,
      "events": [
        {
          "type": "CREATED",
          "timestamp": "2025-12-16T17:30:00.000Z",
          "actor": "copilot-agent",
          "data": {
            "context": "Deep dive audit per user request: 'search for identical or similar issues and do not trust your search since yesterday you are not looking at this bug'",
            "searchPattern": "login.*fail|auth.*deploy|session.*vercel",
            "filesAnalyzed": ["lib/config/constants.ts", "auth.config.ts", "scripts/diagnose-login-issue.ts", "docs/PENDING_MASTER.md"]
          }
        }
      ]
    }
  ]
}

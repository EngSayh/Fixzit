openapi: 3.1.0
info:
  title: Fixzit Souq Module API
  version: 1.0.0
  description: |
    OpenAPI specification for the Fixzit Souq marketplace and operational support module.
    All responses use JSON and timestamps are ISO-8601 strings.
servers:
  - url: https://api.fixzit.local
    description: Example base URL
  - url: http://localhost:5000
    description: Local development server
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    SuccessFlag:
      type: boolean
      description: Indicates whether the request completed successfully.
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Human readable error message.
        message:
          type: string
          description: Optional additional detail.
    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        pages:
          type: integer
    Property:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        address:
          type: string
        type:
          type: string
        units:
          type: integer
        occupancyRate:
          type: number
        monthlyRevenueSar:
          type: number
        city:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    WorkOrder:
      type: object
      properties:
        _id:
          type: string
        code:
          type: string
        title:
          type: string
        description:
          type: string
        priority:
          type: string
        status:
          type: string
        property:
          $ref: "#/components/schemas/Property"
        assignedTo:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    FinanceMetricMap:
      type: object
      additionalProperties:
        type: number
    SupportSummary:
      type: object
      properties:
        open:
          type: integer
        avgResponseHours:
          type: number
        resolutionRate:
          type: number
    MarketplaceProduct:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        name:
          type: string
          description: Legacy compatibility field.
        description:
          type: string
        category:
          type: string
        vendor:
          type: string
        price:
          type: number
        priceSar:
          type: number
        stock:
          type: integer
        rating:
          type: number
        reviewCount:
          type: integer
        soldCount:
          type: integer
        tags:
          type: array
          items:
            type: string
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    MarketplaceProductList:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            products:
              type: array
              items:
                $ref: "#/components/schemas/MarketplaceProduct"
            pagination:
              $ref: "#/components/schemas/Pagination"
    MarketplaceCategory:
      type: object
      properties:
        name:
          type: string
        count:
          type: integer
    CartResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            productId:
              type: string
            quantity:
              type: integer
            product:
              $ref: "#/components/schemas/MarketplaceProduct"
    OrderRequest:
      type: object
      required: [items, shippingAddress, paymentMethod]
      properties:
        items:
          type: array
          items:
            type: object
            required: [productId, quantity]
            properties:
              productId:
                type: string
              quantity:
                type: integer
        shippingAddress:
          type: object
          additionalProperties:
            type: string
        paymentMethod:
          type: string
    OrderResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            orderNumber:
              type: string
            items:
              type: array
              items:
                type: object
                properties:
                  productId:
                    type: string
                  title:
                    type: string
                  price:
                    type: number
                  quantity:
                    type: integer
                  subtotal:
                    type: number
            total:
              type: number
            currency:
              type: string
            status:
              type: string
            shippingAddress:
              type: object
              additionalProperties:
                type: string
            paymentMethod:
              type: string
            createdAt:
              type: string
              format: date-time
    RFQRequest:
      type: object
      required: [title, description, category, quantity, budget]
      properties:
        title:
          type: string
        description:
          type: string
        category:
          type: string
        quantity:
          type: integer
        budget:
          type: number
    RFQResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            id:
              type: string
            title:
              type: string
            status:
              type: string
            bids:
              type: array
              items:
                type: object
            createdAt:
              type: string
              format: date-time
    Vendor:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        rating:
          type: number
        reviewCount:
          type: integer
        category:
          type: string
        verified:
          type: boolean
        responseTime:
          type: string
    Customer:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        email:
          type: string
        phone:
          type: string
    ComplianceDoc:
      type: object
      properties:
        _id:
          type: string
        permitNumber:
          type: string
        type:
          type: string
        propertyName:
          type: string
        expiry:
          type: string
          format: date
    SensorReading:
      type: object
      properties:
        _id:
          type: string
        type:
          type: string
        location:
          type: string
        value:
          type: string
        status:
          type: string
        createdAt:
          type: string
          format: date-time
    AnalyticsMetricMap:
      type: object
      additionalProperties:
        type: number
    SystemSettings:
      type: object
      additionalProperties:
        type: string
    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
    AuthLoginResponse:
      type: object
      properties:
        ok:
          type: boolean
        token:
          type: string
        user:
          type: object
          properties:
            id:
              type: string
            email:
              type: string
            name:
              type: string
            role:
              type: string
            tenantId:
              type: string
    AuthMeResponse:
      type: object
      properties:
        ok:
          type: boolean
        user:
          type: object
          properties:
            id:
              type: string
            email:
              type: string
            name:
              type: string
            role:
              type: string
            tenantId:
              type: string
paths:
  /health:
    get:
      summary: Service health
      description: Returns service, port, timestamp, and database connectivity status.
      responses:
        "200":
          description: Health payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                  port:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time
                  database:
                    type: object
                    properties:
                      status:
                        type: string
                      lastConnectedAt:
                        type: string
                        format: date-time
                      error:
                        type: string
                        nullable: true
        "500":
          description: Unexpected failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/dashboard:
    get:
      summary: Dashboard summary
      responses:
        "200":
          description: Property and work-order counts
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      propertiesCount:
                        type: integer
                      workOrdersCount:
                        type: integer
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthLoginResponse"
        "400":
          description: Missing credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/auth/me:
    get:
      summary: Current user profile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Authenticated user info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthMeResponse"
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/auth/logout:
    post:
      summary: Logout acknowledgement
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Logout confirmed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/properties:
    get:
      summary: List properties
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
          description: Optional override for max documents (default 100)
      responses:
        "200":
          description: Array of properties
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Property"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create property
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Property"
      responses:
        "201":
          description: Created property
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Property"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/workorders:
    get:
      summary: List work orders
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Work orders list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WorkOrder"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create work order
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkOrder"
      responses:
        "201":
          description: Work order created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/WorkOrder"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/hr/employees:
    get:
      summary: List employees
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Employee roster
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      additionalProperties:
                        type: string
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/finance/metrics:
    get:
      summary: Financial metrics
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Metric map
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/FinanceMetricMap"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/support/summary:
    get:
      summary: Support summary
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Support KPIs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/SupportSummary"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/products:
    get:
      summary: Search marketplace products
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: category
          schema:
            type: string
        - in: query
          name: minPrice
          schema:
            type: number
        - in: query
          name: maxPrice
          schema:
            type: number
        - in: query
          name: vendor
          schema:
            type: string
        - in: query
          name: rating
          schema:
            type: number
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: sort
          schema:
            type: string
            default: -createdAt
      responses:
        "200":
          description: Paginated products
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarketplaceProductList"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create marketplace product
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarketplaceProduct"
      responses:
        "201":
          description: Product created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/MarketplaceProduct"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/products/{id}:
    get:
      summary: Fetch single product
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Product response
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/MarketplaceProduct"
        "404":
          description: Product not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update product
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarketplaceProduct"
      responses:
        "200":
          description: Product updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/MarketplaceProduct"
        "404":
          description: Product not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/categories:
    get:
      summary: List categories with counts
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Category list
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/MarketplaceCategory"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/cart:
    post:
      summary: Validate cart selection
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [productId]
              properties:
                productId:
                  type: string
                quantity:
                  type: integer
                  default: 1
      responses:
        "200":
          description: Cart snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CartResponse"
        "400":
          description: Insufficient stock
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Product not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/orders:
    post:
      summary: Create order summary
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderRequest"
      responses:
        "201":
          description: Order created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Product not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/products/{id}/reviews:
    post:
      summary: Submit review
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rating]
              properties:
                rating:
                  type: number
                  minimum: 1
                  maximum: 5
                comment:
                  type: string
                userName:
                  type: string
      responses:
        "201":
          description: Review captured
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  data:
                    type: object
                    properties:
                      productId:
                        type: string
                      userName:
                        type: string
                      rating:
                        type: number
                      comment:
                        type: string
                      createdAt:
                        type: string
                        format: date-time
        "400":
          description: Invalid rating
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Product not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/rfq:
    post:
      summary: Submit RFQ
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RFQRequest"
      responses:
        "201":
          description: RFQ created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RFQResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/vendors:
    get:
      summary: List vendors
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Vendor list
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Vendor"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/marketplace/items:
    get:
      summary: Legacy items endpoint
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Legacy response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/MarketplaceProduct"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/crm/customers:
    get:
      summary: List customers
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Customer list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Customer"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/compliance/docs:
    get:
      summary: List compliance documents
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Compliance documents
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ComplianceDoc"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/iot/readings:
    get:
      summary: List IoT sensor readings
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Sensor readings
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/SensorReading"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/analytics/metrics:
    get:
      summary: Analytics metrics
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Analytics KPI map
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/AnalyticsMetricMap"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/admin/settings:
    get:
      summary: System settings map
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Settings key/value pairs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/SystemSettings"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /api/seed:
    post:
      summary: Seed demo data (non-production)
      description: Available only in non-production environments.
      responses:
        "200":
          description: Seeding success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
